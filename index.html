<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Sanremo Gelato – LMIV Etiketten (Brother QL-810W)</title>
  <style>
    /* =========================
       ROOT VARIABLES & BASE STYLES
    ========================= */
    :root {
      --bg: #0b1020;
      --card: #111a33;
      --card2: #0f1730;
      --line: #22305c;
      --txt: #e9eefc;
      --mut: #b7c2ea;
      --acc: #4dd4ff;
      --ok: #33d17a;
      --warn: #ffcc66;
      --bad: #ff6b6b;
      --shadow: 0 16px 40px rgba(0,0,0,.35);
      --r: 18px;
      --pad: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --previewScale: 1;
    }
    
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    
    body {
      font-family: var(--sans);
      background: radial-gradient(1200px 600px at 10% -10%, rgba(77,212,255,.22), transparent 50%),
                  radial-gradient(900px 500px at 90% 0%, rgba(51,209,122,.20), transparent 55%),
                  linear-gradient(180deg, #060a16 0%, #0b1020 60%, #070b15 100%);
      color: var(--txt);
    }
    
    /* =========================
       LAYOUT STRUCTURE
    ========================= */
    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 14px 80px;
    }
    
    .top {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 20;
      padding: 14px 0 10px;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(7,10,20,.92) 0%, rgba(7,10,20,.65) 70%, transparent 100%);
    }
    
    .brand {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .logo {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      background: conic-gradient(from 200deg, #33d17a, #4dd4ff, #9b7bff, #33d17a);
      box-shadow: var(--shadow);
    }
    
    .title h1 {
      margin: 0;
      font-size: 16px;
      letter-spacing: .2px;
    }
    
    .title .sub {
      margin: 2px 0 0;
      color: var(--mut);
      font-size: 12px;
    }
    
    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    
    /* =========================
       BUTTONS
    ========================= */
    button {
      border: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      color: var(--txt);
      padding: 10px 12px;
      border-radius: 14px;
      cursor: pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
      font-weight: 650;
      font-size: 13px;
      transition: all 0.2s ease;
    }
    
    button:hover { 
      border-color: rgba(77,212,255,.35);
      transform: translateY(-1px);
    }
    
    .btnPrimary {
      background: linear-gradient(180deg, rgba(77,212,255,.26), rgba(77,212,255,.12));
      border-color: rgba(77,212,255,.35);
    }
    
    .btnOk {
      background: linear-gradient(180deg, rgba(51,209,122,.26), rgba(51,209,122,.12));
      border-color: rgba(51,209,122,.35);
    }
    
    .btnBad {
      background: linear-gradient(180deg, rgba(255,107,107,.26), rgba(255,107,107,.12));
      border-color: rgba(255,107,107,.35);
    }
    
    /* =========================
       TABS
    ========================= */
    .tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 10px 0 14px;
    }
    
    .tab {
      padding: 10px 12px;
      border-radius: 999px;
      cursor: pointer;
      user-select: none;
      border: 1px solid rgba(255,255,255,.10);
      color: var(--mut);
      background: rgba(255,255,255,.04);
      font-weight: 700;
      font-size: 13px;
      transition: all 0.2s ease;
    }
    
    .tab:hover {
      border-color: rgba(77,212,255,.25);
      background: rgba(77,212,255,.08);
    }
    
    .tab.active {
      color: var(--txt);
      border-color: rgba(77,212,255,.45);
      background: rgba(77,212,255,.12);
    }
    
    /* =========================
       GRID & CARDS
    ========================= */
    .grid {
      display: grid;
      gap: 14px;
      grid-template-columns: 1.05fr .95fr;
      align-items: start;
    }
    
    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
      .actions { justify-content: flex-start; }
    }
    
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      padding: var(--pad);
      box-shadow: var(--shadow);
    }
    
    .card h2 {
      margin: 0 0 10px;
      font-size: 14px;
    }
    
    .mut { color: var(--mut); }
    
    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .row > * { flex: 1; }
    
    /* =========================
       FORM ELEMENTS
    ========================= */
    label {
      display: block;
      font-size: 12px;
      color: var(--mut);
      margin: 0 0 6px;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(10,14,26,.65);
      color: var(--txt);
      outline: none;
      font-family: var(--sans);
      transition: border-color 0.2s ease;
    }
    
    textarea {
      min-height: 90px;
      resize: vertical;
      line-height: 1.5;
    }
    
    input:focus, select:focus, textarea:focus {
      border-color: rgba(77,212,255,.5);
    }
    
    input[type="number"] {
      font-family: var(--mono);
    }
    
    .hr {
      height: 1px;
      background: rgba(255,255,255,.08);
      margin: 12px 0;
    }
    
    /* =========================
       LISTS & TABLES
    ========================= */
    .list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 520px;
      overflow: auto;
      padding-right: 4px;
    }
    
    .list::-webkit-scrollbar {
      width: 6px;
    }
    
    .list::-webkit-scrollbar-track {
      background: rgba(255,255,255,.05);
      border-radius: 3px;
    }
    
    .list::-webkit-scrollbar-thumb {
      background: rgba(77,212,255,.3);
      border-radius: 3px;
    }
    
    .item {
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 10px;
      display: flex;
      gap: 10px;
      align-items: flex-start;
      justify-content: space-between;
      transition: all 0.2s ease;
    }
    
    .item:hover {
      border-color: rgba(77,212,255,.2);
      background: rgba(77,212,255,.03);
    }
    
    .item .meta { flex: 1; min-width: 0; }
    .item .meta .name { 
      font-weight: 850; 
      font-size: 13px; 
      margin-bottom: 4px;
    }
    
    .item .meta .small { 
      font-size: 12px; 
      color: var(--mut); 
      margin-top: 2px; 
    }
    
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: var(--mut);
      margin: 6px 6px 0 0;
      white-space: nowrap;
      font-weight: 600;
    }
    
    .pill.ok {
      border-color: rgba(51,209,122,.35);
      color: #b9f7d8;
      background: rgba(51,209,122,.10);
    }
    
    .pill.warn {
      border-color: rgba(255,204,102,.35);
      color: #ffe7b8;
      background: rgba(255,204,102,.10);
    }
    
    .pill.bad {
      border-color: rgba(255,107,107,.35);
      color: #ffd2d2;
      background: rgba(255,107,107,.10);
    }
    
    .miniBtns {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    
    .miniBtns button {
      padding: 8px 10px;
      font-size: 12px;
      border-radius: 12px;
      box-shadow: none;
    }
    
    .table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow: hidden;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    
    .table th, .table td {
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      font-size: 12px;
      text-align: left;
      vertical-align: top;
    }
    
    .table th {
      color: var(--mut);
      font-weight: 800;
      background: rgba(255,255,255,.03);
      border-bottom: 2px solid rgba(77,212,255,.3);
    }
    
    .table tr:last-child td { border-bottom: none; }
    .table tr:hover td { background: rgba(77,212,255,.05); }
    
    .mono { font-family: var(--mono); }
    
    /* =========================
       MISC ELEMENTS
    ========================= */
    .hint {
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: var(--mut);
      font-size: 12px;
      line-height: 1.5;
    }
    
    .hint b {
      color: var(--acc);
    }
    
    .hidden { display: none !important; }
    
    .toast {
      position: fixed;
      left: 50%;
      bottom: 14px;
      transform: translateX(-50%);
      background: rgba(17,26,51,.95);
      border: 1px solid rgba(77,212,255,.25);
      color: var(--txt);
      padding: 12px 16px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      font-size: 13px;
      display: none;
      z-index: 9999;
      max-width: min(720px, 92vw);
      backdrop-filter: blur(10px);
      animation: toastSlideUp 0.3s ease;
    }
    
    @keyframes toastSlideUp {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }
    
    /* =========================
       PREVIEW AREA
    ========================= */
    .labelCard { 
      position: sticky; 
      top: 92px; 
    }
    
    @media (max-width: 980px) {
      .labelCard { position: relative; top: auto; }
    }
    
    .labelWrap {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px;
      border-radius: 16px;
      background: rgba(0,0,0,.25);
      border: 1px dashed rgba(255,255,255,.16);
      overflow: auto;
      min-height: 400px;
    }
    
    #previewHost {
      display: flex;
      justify-content: center;
      align-items: center;
      transform: scale(var(--previewScale, 1));
      transform-origin: center;
      transition: transform 0.3s ease;
    }
    
    /* =========================
       LABEL STYLES (PRINT) - GERMAN LAW COMPLIANT
    ========================= */
    .lbl {
      background: #fff;
      color: #000;
      border-radius: 6px;
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
      overflow: hidden;
      font-family: Arial, Helvetica, sans-serif;
      display: grid;
      grid-template-rows: auto 1fr var(--footerH);
      box-sizing: border-box;
    }
    
    .lblHeader { 
      padding: 2.6mm 2.6mm 1.2mm; 
      border-bottom: 0.2mm solid #eee;
    }
    
    .lblBody { 
      padding: 1.3mm 2.6mm 1.2mm; 
      overflow: hidden; 
    }
    
    .lblFooter {
      border-top: 0.35mm solid #111;
      padding: 1.6mm 2.6mm 1.4mm;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 2.4mm;
      overflow: hidden;
      background: #f9f9f9;
    }
    
    .prodName { 
      font-weight: 900; 
      letter-spacing: .2px; 
      margin: 0 0 0.5mm 0;
      line-height: 1.2;
    }
    
    .prodMeta { 
      font-size: 8.2pt; 
      margin-top: 0.5mm;
      color: #333;
    }
    
    .prodMeta2 { 
      font-size: 8.0pt; 
      margin-top: .6mm; 
      color: #666;
    }
    
    .bodyGrid {
      display: grid;
      grid-template-columns: 45% 55%;
      gap: 2.2mm;
      align-items: start;
      height: 100%;
    }
    
    .rightCol { 
      min-width: 0; 
      overflow: hidden; 
    }
    
    table.nutri {
      width: 100%;
      border-collapse: collapse;
      font-size: 7.2pt;
      margin: 0;
    }
    
    table.nutri td, table.nutri th {
      border: 0.3mm solid #000;
      padding: 0.6mm 0.8mm;
      vertical-align: top;
      line-height: 1.3;
    }
    
    table.nutri th { 
      text-align: left; 
      font-weight: 800; 
      background: #f5f5f5;
    }
    
    table.nutri td { 
      font-weight: 600; 
    }
    
    .blk {
      font-size: 7.2pt;
      line-height: 1.22;
      margin-top: 1.0mm;
      color: #222;
    }
    
    .blk b { 
      font-weight: 900; 
      color: #000;
    }
    
    .spuren {
      border: 0.3mm solid #000;
      padding: 0.8mm 1.0mm;
      font-weight: 800;
      overflow: hidden;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 3;
      background: #fff9e6;
      margin-top: 1mm;
      font-size: 7.0pt;
    }
    
    /* =========================
       BARCODE STYLES (GERMAN LAW COMPLIANT - EAN-13)
    ========================= */
    .barcodeBox {
      display: flex;
      flex-direction: column;
      gap: 0.3mm;
      align-items: center;
      justify-content: center;
      min-width: 40mm;
      max-width: 50%;
    }
    
    .barcodeContainer {
      width: 100%;
      height: 15mm; /* Minimum height according to German law */
      background: #fff;
      border: 0.2mm solid #ccc;
      padding: 0.5mm;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .eanText {
      font-size: 7.4pt;
      letter-spacing: .2px;
      text-align: center;
      margin-top: 0.3mm;
      font-family: "OCR-B", "Courier New", monospace;
      font-weight: bold;
      color: #000;
    }
    
    .lotMini {
      font-size: 7.2pt;
      line-height: 1.15;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #333;
      max-width: 25mm;
    }
    
    .lotMini b {
      color: #000;
    }
    
    /* Label sizes */
    .lbl.big {
      width: 100mm;
      height: 62mm;
      --footerH: 13.8mm;
    }
    
    .lbl.small {
      width: 90mm;
      height: 38mm;
      --footerH: 11.8mm;
    }
    
    .lbl.small .bodyGrid {
      grid-template-columns: 46% 54%;
      gap: 1.6mm;
    }
    
    .lbl.small table.nutri { 
      font-size: 7.0pt; 
    }
    
    .lbl.small table.nutri td, 
    .lbl.small table.nutri th {
      padding: 0.5mm 0.6mm;
    }
    
    .lbl.small .blk { 
      font-size: 7.0pt; 
      margin-top: 0.8mm;
    }
    
    .lbl.small .spuren { 
      -webkit-line-clamp: 2; 
      font-size: 6.8pt;
      padding: 0.6mm 0.8mm;
    }
    
    .lbl.small .prodName { 
      font-size: 12.3pt; 
    }
    
    .lbl.small .prodMeta { 
      font-size: 7.8pt; 
    }
    
    .lbl.big .prodName { 
      font-size: 14.2pt; 
    }
    
    /* Round label */
    .lbl.round {
      width: 62mm;
      height: 62mm;
      border-radius: 999px;
      --footerH: 14mm;
    }
    
    .lbl.round .bodyGrid { 
      grid-template-columns: 1fr; 
    }
    
    .lbl.round .lblBody { 
      padding: 1.2mm 3.2mm; 
    }
    
    .lbl.round table.nutri { 
      display: none; 
    }
    
    .lbl.round .spuren { 
      display: none; 
    }
    
    .lbl.round .prodMeta2 { 
      display: none; 
    }
    
    .lbl.round .blk { 
      font-size: 8.0pt; 
    }
    
    .lbl.round .prodName { 
      font-size: 13pt; 
      text-align: center;
    }
    
    .lbl.round .prodMeta { 
      text-align: center; 
    }
    
    /* QR Code */
    .qrBox {
      width: 16mm;
      height: 16mm;
      border: 0.3mm solid #000;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background: #fff;
      flex: 0 0 auto;
    }
    
    .qrBox svg { 
      width: 100%; 
      height: 100%; 
    }
    
    /* Warning colors for additives */
    .warning-text {
      color: #d00;
      font-weight: bold;
      border: 0.2mm solid #d00;
      padding: 0.5mm;
      margin-top: 0.5mm;
      background: #fff0f0;
      font-size: 7.0pt;
    }
    
    /* Print-specific styles */
    @media print {
      .lbl {
        box-shadow: none;
        border: 0.1mm solid #000;
      }
      
      .barcodeContainer {
        border: 0.1mm solid #000;
      }
      
      .eanText {
        -webkit-print-color-adjust: exact;
        color-adjust: exact;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">
          <h1>Sanremo – LMIV Etiketten (QL-810W)</h1>
          <div class="sub">62×100 (DK11202) • 38×90 (DK11208) • Optional: Rund (Ø62)</div>
        </div>
      </div>
      <div class="actions">
        <button class="btnPrimary" id="btnExport">Backup exportieren</button>
        <button class="btnPrimary" id="btnImport">Backup importieren</button>
        <input id="fileImport" type="file" accept="application/json" class="hidden" />
        <button class="btnOk" id="btnPrint">Etikett drucken</button>
      </div>
    </div>

    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="ingredients">Zutaten / Produkte</div>
      <div class="tab" data-tab="recipes">Rezept / Etikett</div>
      <div class="tab" data-tab="settings">Betrieb / LMIV Texte</div>
    </div>

    <div class="grid">
      <!-- LEFT COLUMN -->
      <div id="leftCol">
        <!-- TAB INGREDIENTS -->
        <div class="card" id="tab-ingredients">
          <h2>Zutaten-Bibliothek (inkl. Frucht-Pulver)</h2>

          <div class="row">
            <div>
              <label>Suche</label>
              <input id="ingSearch" placeholder="z.B. Milch, Supergelmix, Erdbeere, Pistazie..." />
            </div>
            <div>
              <label>Kategorie</label>
              <select id="ingFilterCat"></select>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div>
              <label>Name</label>
              <input id="ingName" placeholder="z.B. Supergelmix D / Base Soave / Pistazienpaste..." />
            </div>
            <div>
              <label>Kategorie</label>
              <select id="ingCat"></select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Allergene (GROSS, Komma)</label>
              <input id="ingAll" placeholder="z.B. MILCH, SOJA, EI, SCHALENFRÜCHTE" />
            </div>
            <div>
              <label>Zusatzstoffe / E-Nummern (Komma)</label>
              <input id="ingAdd" placeholder="z.B. E330, E440, E129" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Zutatenliste (für dieses Produkt, LMIV Text)</label>
              <textarea id="ingText" placeholder="z.B. Zucker, Glukosesirup, Stabilisatoren (E...)" ></textarea>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Hinweis (optional)</label>
              <input id="ingNote" placeholder="z.B. Kann Aktivität und Aufmerksamkeit bei Kindern beeinträchtigen." />
            </div>
          </div>

          <div class="hr"></div>
          <div class="hint">
            <b>Wichtig (LMIV):</b> Für Pasten/Variegato/Pulver immer die Lieferanten-Etiketten (pro 100 g) eintragen.
            Wenn du Werte nicht hast: vorerst 0 und später korrigieren.
          </div>

          <div class="hr"></div>

          <h2>Nährwerte pro 100 g (Lieferant)</h2>
          <div class="row">
            <div><label>Energie (kJ)</label><input id="n_kj" type="number" step="0.1" value="0"></div>
            <div><label>Energie (kcal)</label><input id="n_kcal" type="number" step="0.1" value="0"></div>
          </div>
          <div class="row">
            <div><label>Fett (g)</label><input id="n_fat" type="number" step="0.1" value="0"></div>
            <div><label>davon gesättigt (g)</label><input id="n_sat" type="number" step="0.1" value="0"></div>
          </div>
          <div class="row">
            <div><label>Kohlenhydrate (g)</label><input id="n_carb" type="number" step="0.1" value="0"></div>
            <div><label>davon Zucker (g)</label><input id="n_sugar" type="number" step="0.1" value="0"></div>
          </div>
          <div class="row">
            <div><label>Eiweiß (g)</label><input id="n_protein" type="number" step="0.1" value="0"></div>
            <div><label>Salz (g)</label><input id="n_salt" type="number" step="0.01" value="0"></div>
          </div>
          <div class="row">
            <div><label>Ballaststoffe (g) optional</label><input id="n_fiber" type="number" step="0.1" value="0"></div>
            <div style="display:flex; gap:8px; align-items:flex-end; justify-content:flex-end">
              <button class="btnOk" id="btnSaveIng">Speichern</button>
              <button class="btnBad" id="btnResetIng">Neu</button>
            </div>
          </div>

          <div class="hr"></div>
          <h2>Liste</h2>
          <div class="list" id="ingList"></div>
        </div>

        <!-- TAB RECIPES -->
        <div class="card hidden" id="tab-recipes">
          <h2>Rezept (Gelato) + Etikett</h2>

          <div class="row">
            <div>
              <label>Rezeptname / Sorte</label>
              <input id="r_name" placeholder="z.B. Vanille, Kinder Riegel, Mango, Erdbeere..." />
            </div>
            <div>
              <label>Produkttyp</label>
              <select id="r_type">
                <option value="auto">Auto (Milch → Speiseeis / Wasser → Fruchteis)</option>
                <option value="Speiseeis">Speiseeis</option>
                <option value="Fruchteis">Fruchteis</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Nettofüllmenge</label>
              <select id="r_netto">
                <option value="170">170 g</option>
                <option value="750">750 g</option>
                <option value="custom">Eigen...</option>
              </select>
            </div>
            <div>
              <label>Barcode (EAN)</label>
              <select id="eanMode">
                <option value="auto">Auto (170/750 nach Netto)</option>
                <option value="170">170 g – 4170000057765</option>
                <option value="750">750 g – 4170000057949</option>
                <option value="custom">Eigen...</option>
                <option value="off">Aus (kein Barcode)</option>
              </select>
            </div>
          </div>

          <div class="row" id="customNetRow" style="display:none;">
            <div>
              <label>Eigen Netto (Text)</label>
              <input id="r_netto_custom" placeholder="z.B. 500 g / 0,5 kg" />
            </div>
            <div></div>
          </div>

          <div class="row" id="customEanRow" style="display:none;">
            <div>
              <label>Eigen EAN (Zahlen)</label>
              <input id="eanCustom" placeholder="z.B. 1234567890123" inputmode="numeric" />
            </div>
            <div></div>
          </div>

          <div class="row">
            <div>
              <label>Charge / Lot</label>
              <input id="r_lot" placeholder="z.B. L2513681" />
            </div>
            <div>
              <label>MHD</label>
              <input id="r_mhd" type="date" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>QR Link (optional)</label>
              <input id="r_qr" placeholder="https://..." />
            </div>
            <div>
              <label>Etikettformat</label>
              <select id="labelSize">
                <option value="big">62×100 mm (Groß – legal)</option>
                <option value="small">38×90 mm (Klein – optional)</option>
                <option value="round">Rund Ø62 mm (optional)</option>
              </select>
            </div>
          </div>

          <div class="hr"></div>

          <h2>Zutaten ins Rezept</h2>
          <div class="row">
            <div>
              <label>Zutat wählen</label>
              <select id="r_pick"></select>
            </div>
            <div>
              <label>Menge</label>
              <input id="r_qty" type="number" step="0.1" value="100" />
            </div>
            <div>
              <label>Einheit</label>
              <select id="r_unit">
                <option value="g">g</option>
                <option value="ml">ml</option>
              </select>
            </div>
            <div style="flex:0">
              <label>&nbsp;</label>
              <button class="btnOk" id="btnAddToRecipe">Hinzufügen</button>
            </div>
          </div>

          <div class="hr"></div>

          <h2>Rezeptliste</h2>
          <table class="table" id="recipeTable">
            <thead>
              <tr>
                <th style="width:42%">Zutat</th>
                <th style="width:14%">Menge</th>
                <th style="width:10%">Einheit</th>
                <th style="width:26%">Hinweise</th>
                <th style="width:8%"></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <div class="hr"></div>

          <div class="row">
            <div class="hint">
              <b>Automatik:</b> Zutatenliste nach Menge (absteigend).
              Allergene/Zusatzstoffe werden automatisch gesammelt. <b>Spuren-Text</b> kommt aus „Betrieb / LMIV Texte".
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <button class="btnOk" id="btnSaveRecipe">Rezept speichern</button>
            <button class="btnBad" id="btnNewRecipe">Neues Rezept</button>
            <button class="btnPrimary" id="btnLoadRecipe">Rezept laden</button>
            <select id="recipePicker"></select>
          </div>
        </div>

        <!-- TAB SETTINGS -->
        <div class="card hidden" id="tab-settings">
          <h2>Betrieb / Standard (LMIV)</h2>

          <div class="row">
            <div>
              <label>Aufbewahrung (Standard)</label>
              <input id="s_storage" placeholder="Tiefgekühlt bei -18°C lagern." />
            </div>
            <div>
              <label>Fußzeile (optional)</label>
              <input id="s_footer" placeholder="Nach dem Auftauen nicht wieder einfrieren." />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Firma</label>
              <input id="s_company" />
            </div>
            <div>
              <label>Adresse</label>
              <input id="s_addr" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Telefon</label>
              <input id="s_phone" />
            </div>
            <div>
              <label>E-Mail</label>
              <input id="s_email" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Spuren-Text (LMIV) – wird auf Etikett gedruckt</label>
              <textarea id="s_spuren" placeholder="Kann Spuren enthalten: MILCH, SOJA, EI, ..."></textarea>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Hinweis (Azo-Farbstoffe) – Standardtext</label>
              <input id="s_azo" placeholder="Kann Aktivität und Aufmerksamkeit bei Kindern beeinträchtigen." />
            </div>
            <div style="display:flex; gap:8px; align-items:flex-end; justify-content:flex-end">
              <button class="btnOk" id="btnSaveSettings">Speichern</button>
            </div>
          </div>

          <div class="hr"></div>

          <div class="hint">
            <b>Wichtig:</b> Wenn ein Produkt E102/E104/E110/E122/E124/E129 enthält,
            wird automatisch ein Warnhinweis auf dem Etikett ausgegeben.
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div>
        <div class="card labelCard">
          <h2>Etikett Vorschau (ohne Überlappung)</h2>

          <div class="row">
            <div>
              <label>Layout</label>
              <select id="layoutMode">
                <option value="clean">Clean (Supermarkt)</option>
                <option value="compact">Compact (mehr Text)</option>
              </select>
            </div>
            <div>
              <label>Schriftgröße (nur Vorschau)</label>
              <select id="fontScale">
                <option value="1">Normal</option>
                <option value="0.95">Etwas kleiner</option>
                <option value="0.9">Klein</option>
              </select>
            </div>
          </div>

          <div class="hr"></div>

          <div class="labelWrap">
            <div id="previewHost"></div>
          </div>

          <div class="hr"></div>

          <div class="hint" id="labelHint">
            Druck: „Etikett drucken" → Brother QL-810W → Skalierung: 100% (keine Anpassung).
          </div>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

  <script>
    /* =========================
       STORAGE & CONSTANTS
    ========================= */
    const STORAGE_KEY = "sanremo_lmiv_etiketten_v2";
    const EAN_170 = "4170000057765";
    const EAN_750 = "4170000057949";
    
    // Required EAN-13 checksum calculation
    function calculateEANChecksum(code) {
      if (code.length !== 12) return code;
      let sum = 0;
      for (let i = 0; i < 12; i++) {
        const digit = parseInt(code[i]);
        sum += digit * (i % 2 === 0 ? 1 : 3);
      }
      const checksum = (10 - (sum % 10)) % 10;
      return code + checksum;
    }

    const DEFAULT_STATE = {
      settings: {
        storage: "Tiefgekühlt bei -18°C lagern.",
        footer: "Nach dem Auftauen nicht wieder einfrieren.",
        company: "Eiscafé Sanremo",
        addr: "57319 Bad Berleburg, Deutschland",
        phone: "0176 72809926",
        email: "paulo.sanremo@web.de",
        spuren: "Kann Spuren enthalten: MILCH, SOJA, EI, MANDELN, HASELNÜSSE, WALNÜSSE, PISTAZIEN",
        azoText: "Kann Aktivität und Aufmerksamkeit bei Kindern beeinträchtigen."
      },
      ingredients: [],
      recipes: [],
      current: {
        editingIngId: null,
        editingRecipeId: null,
        recipe: {
          name: "",
          type: "auto",
          netto: "170",
          netto_custom: "",
          eanMode: "auto",
          eanCustom: "",
          lot: "",
          mhd: "",
          qr: "",
          labelSize: "big",
          items: []
        }
      }
    };

    /* =========================
       UTILITY FUNCTIONS
    ========================= */
    function uid(prefix = "id") {
      return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }

    function deepClone(x) { 
      try {
        return structuredClone ? structuredClone(x) : JSON.parse(JSON.stringify(x));
      } catch(e) {
        console.error("Clone error:", e);
        return JSON.parse(JSON.stringify(x));
      }
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return deepClone(DEFAULT_STATE);
        const s = JSON.parse(raw);
        // Merge with defaults for backward compatibility
        return {
          ...deepClone(DEFAULT_STATE),
          ...s,
          settings: { ...deepClone(DEFAULT_STATE.settings), ...(s.settings || {}) },
          current: { ...deepClone(DEFAULT_STATE.current), ...(s.current || {}) },
          ingredients: s.ingredients || [],
          recipes: s.recipes || []
        };
      } catch (e) {
        console.error("Load state error:", e);
        return deepClone(DEFAULT_STATE);
      }
    }

    function saveState() { 
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch(e) {
        console.error("Save state error:", e);
      }
    }
    
    let state = loadState();

    /* =========================
       BARCODE GENERATION (EAN-13 COMPLIANT WITH GERMAN LAW)
    ========================= */
    function makeBarcodeSVG(ean) {
      if (!ean || ean.length !== 13) {
        // Return empty barcode container
        return `<div class="barcodeContainer" style="display: flex; align-items: center; justify-content: center;">
                  <span style="font-size: 6pt; color: #999;">Kein Barcode</span>
                </div>`;
      }
      
      // Verify it's a valid EAN-13
      const digits = ean.split('').map(d => parseInt(d, 10));
      if (digits.some(isNaN)) return "";
      
      // Calculate checksum to verify
      let sum = 0;
      for (let i = 0; i < 12; i++) {
        sum += digits[i] * (i % 2 === 0 ? 1 : 3);
      }
      const checksum = (10 - (sum % 10)) % 10;
      if (digits[12] !== checksum) {
        console.warn("Invalid EAN checksum");
      }
      
      // EAN-13 encoding patterns
      const L_PATTERNS = [
        "0001101", "0011001", "0010011", "0111101", "0100011",
        "0110001", "0101111", "0111011", "0110111", "0001011"
      ];
      
      const G_PATTERNS = [
        "0100111", "0110011", "0011011", "0100001", "0011101",
        "0111001", "0000101", "0010001", "0001001", "0010111"
      ];
      
      const R_PATTERNS = [
        "1110010", "1100110", "1101100", "1000010", "1011100",
        "1001110", "1010000", "1000100", "1001000", "1110100"
      ];
      
      // First digit determines encoding pattern
      const firstDigit = digits[0];
      const ENCODING_TABLE = [
        "LLLLLL", "LLGLGG", "LLGGLG", "LLGGGL", "LGLLGG",
        "LGGLLG", "LGGGLL", "LGLGLG", "LGLGGL", "LGGLGL"
      ];
      
      const encoding = ENCODING_TABLE[firstDigit];
      if (!encoding) return "";
      
      // Build barcode pattern
      let pattern = "101"; // Start guard
      
      // Left side (digits 1-6)
      for (let i = 1; i <= 6; i++) {
        const digit = digits[i];
        const encType = encoding[i - 1];
        const patterns = encType === 'L' ? L_PATTERNS : G_PATTERNS;
        pattern += patterns[digit];
      }
      
      pattern += "01010"; // Center guard
      
      // Right side (digits 7-12)
      for (let i = 7; i <= 12; i++) {
        const digit = digits[i];
        pattern += R_PATTERNS[digit];
      }
      
      pattern += "101"; // End guard
      
      // Create SVG with proper dimensions for German law
      // Minimum height: 15mm, width: 37.29mm (standard EAN-13)
      const svgWidth = 37.29; // mm
      const svgHeight = 15; // mm
      const quietZone = 3; // mm each side (required by German law)
      const totalWidth = svgWidth + (quietZone * 2);
      const moduleWidth = svgWidth / 95; // EAN-13 has 95 modules
      
      // Build SVG elements
      let elements = [];
      let x = quietZone;
      
      // Draw quiet zones
      elements.push(`<rect x="0" y="0" width="${quietZone}" height="${svgHeight}" fill="#fff"/>`);
      elements.push(`<rect x="${quietZone + svgWidth}" y="0" width="${quietZone}" height="${svgHeight}" fill="#fff"/>`);
      
      // Draw barcode modules
      for (let i = 0; i < pattern.length; i++) {
        const isBar = pattern[i] === '1';
        const barHeight = svgHeight * (isBar ? 1 : 0.92); // Slightly shorter for spaces
        
        if (isBar) {
          elements.push(`<rect x="${x.toFixed(3)}" y="${svgHeight - barHeight}" width="${moduleWidth.toFixed(3)}" height="${barHeight}" fill="#000"/>`);
        }
        
        x += moduleWidth;
      }
      
      // Add human readable numbers (German law requires clear readability)
      const textY = svgHeight + 1.2;
      const firstPart = ean.substring(0, 1);
      const leftPart = ean.substring(1, 7);
      const rightPart = ean.substring(7);
      
      return `<svg viewBox="0 0 ${totalWidth} ${svgHeight + 3}" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
        <rect width="${totalWidth}" height="${svgHeight + 3}" fill="#fff"/>
        ${elements.join("")}
        <!-- First digit -->
        <text x="${quietZone - 2}" y="${textY}" text-anchor="end" font-family="'OCR-B', 'Courier New', monospace" font-size="3" font-weight="bold" fill="#000">${firstPart}</text>
        <!-- Left part -->
        <text x="${quietZone + (svgWidth * 0.25)}" y="${textY}" text-anchor="middle" font-family="'OCR-B', 'Courier New', monospace" font-size="3" font-weight="bold" fill="#000">${leftPart}</text>
        <!-- Right part -->
        <text x="${quietZone + (svgWidth * 0.75)}" y="${textY}" text-anchor="middle" font-family="'OCR-B', 'Courier New', monospace" font-size="3" font-weight="bold" fill="#000">${rightPart}</text>
      </svg>`;
    }

    /* =========================
       HELPER FUNCTIONS
    ========================= */
    const $ = (id) => document.getElementById(id);
    
    function toast(msg, duration = 2200) {
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._tm);
      toast._tm = setTimeout(() => {
        t.style.display = "none";
      }, duration);
    }
    
    function num(x) { 
      const v = parseFloat(x); 
      return isFinite(v) ? v : 0; 
    }
    
    function round(x, d = 1) { 
      const p = Math.pow(10, d); 
      return Math.round((num(x) + Number.EPSILON) * p) / p; 
    }
    
    function escapeHtml(s) { 
      if (s == null) return "";
      return String(s).replace(/[&<>"']/g, m => ({ 
        "&": "&amp;", "<": "&lt;", ">": "&gt;", 
        '"': "&quot;", "'": "&#039;" 
      }[m])); 
    }
    
    function normalizeList(str) {
      return (str || "").split(",")
        .map(s => s.trim().toUpperCase())
        .filter(s => s.length > 0);
    }
    
    function uniq(arr) { 
      return Array.from(new Set(arr.filter(Boolean))); 
    }
    
    function sortByName(a, b) { 
      return (a.name || "").localeCompare((b.name || ""), "de"); 
    }
    
    function hasAzoWarning(additivesStr) {
      const adds = normalizeList(additivesStr);
      const azo = ["E102", "E104", "E110", "E122", "E124", "E129"];
      const set = new Set(adds);
      return azo.some(a => set.has(a));
    }

    /* =========================
       CATEGORIES MANAGEMENT
    ========================= */
    function catList() {
      const base = [
        "Alle",
        "Milch & Sahne",
        "Zucker & Süßung",
        "Pulver & Stabilisierung",
        "Kakao / Schokolade",
        "Pasten & Nüsse",
        "Variegato / Saucen",
        "Glasur / Dekor",
        "Frucht / Püree",
        "Sonstiges"
      ];
      const extra = uniq((state.ingredients || []).map(i => i.cat).filter(c => c && !base.includes(c)));
      return base.concat(extra);
    }
    
    function fillCatSelects() {
      const cats = catList();
      const ingCat = $("ingCat");
      const ingFilterCat = $("ingFilterCat");
      
      if (ingCat) {
        ingCat.innerHTML = cats.filter(c => c !== "Alle")
          .map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`)
          .join("");
      }
      
      if (ingFilterCat) {
        ingFilterCat.innerHTML = cats.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
      }
      
      if (ingCat && !ingCat.value) ingCat.value = "Sonstiges";
    }

    /* =========================
       TABS MANAGEMENT
    ========================= */
    function setTab(tab) {
      document.querySelectorAll(".tab").forEach(el => {
        el.classList.toggle("active", el.dataset.tab === tab);
      });
      
      ["ingredients", "recipes", "settings"].forEach(t => {
        const el = $("tab-" + t);
        if (el) el.classList.toggle("hidden", t !== tab);
      });
      
      renderAll();
    }
    
    $("tabs").addEventListener("click", (e) => {
      const t = e.target.closest(".tab");
      if (!t) return;
      setTab(t.dataset.tab);
    });

    /* =========================
       INGREDIENTS MANAGEMENT
    ========================= */
    function resetIngForm() {
      state.current.editingIngId = null;
      $("ingName").value = "";
      $("ingCat").value = "Sonstiges";
      $("ingAll").value = "";
      $("ingAdd").value = "";
      $("ingText").value = "";
      $("ingNote").value = "";
      $("n_kj").value = 0;
      $("n_kcal").value = 0;
      $("n_fat").value = 0;
      $("n_sat").value = 0;
      $("n_carb").value = 0;
      $("n_sugar").value = 0;
      $("n_protein").value = 0;
      $("n_salt").value = 0;
      $("n_fiber").value = 0;
    }
    
    function loadIngToForm(ing) {
      state.current.editingIngId = ing.id;
      $("ingName").value = ing.name || "";
      $("ingCat").value = ing.cat || "Sonstiges";
      $("ingAll").value = ing.allergens || "";
      $("ingAdd").value = ing.additives || "";
      $("ingText").value = ing.ingredientsText || "";
      $("ingNote").value = ing.note || "";
      $("n_kj").value = num(ing.n?.kj) || 0;
      $("n_kcal").value = num(ing.n?.kcal) || 0;
      $("n_fat").value = num(ing.n?.fat) || 0;
      $("n_sat").value = num(ing.n?.sat) || 0;
      $("n_carb").value = num(ing.n?.carb) || 0;
      $("n_sugar").value = num(ing.n?.sugar) || 0;
      $("n_protein").value = num(ing.n?.protein) || 0;
      $("n_salt").value = num(ing.n?.salt) || 0;
      $("n_fiber").value = num(ing.n?.fiber) || 0;
    }
    
    function saveIngredient() {
      const ing = {
        id: state.current.editingIngId || uid("ing"),
        name: $("ingName").value.trim(),
        cat: $("ingCat").value.trim() || "Sonstiges",
        allergens: $("ingAll").value.trim().toUpperCase(),
        additives: $("ingAdd").value.trim().toUpperCase(),
        ingredientsText: $("ingText").value.trim(),
        note: $("ingNote").value.trim(),
        n: {
          kj: num($("n_kj").value),
          kcal: num($("n_kcal").value),
          fat: num($("n_fat").value),
          sat: num($("n_sat").value),
          carb: num($("n_carb").value),
          sugar: num($("n_sugar").value),
          protein: num($("n_protein").value),
          salt: num($("n_salt").value),
          fiber: num($("n_fiber").value),
        }
      };
      
      if (!ing.name) {
        toast("Bitte Namen eingeben.");
        return;
      }
      
      const idx = state.ingredients.findIndex(x => x.id === ing.id);
      if (idx >= 0) {
        state.ingredients[idx] = ing;
      } else {
        state.ingredients.push(ing);
      }
      
      state.ingredients.sort(sortByName);
      saveState();
      fillCatSelects();
      fillPickers();
      renderIngredients();
      renderLabel();
      toast("Zutat gespeichert ✅");
    }
    
    function deleteIngredient(id) {
      if (!confirm("Zutat wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.")) return;
      
      // Remove from ingredients
      state.ingredients = state.ingredients.filter(x => x.id !== id);
      
      // Remove from current recipe
      state.current.recipe.items = (state.current.recipe.items || []).filter(it => it.ingId !== id);
      
      // Remove from all saved recipes
      state.recipes.forEach(r => {
        r.items = (r.items || []).filter(it => it.ingId !== id);
      });
      
      saveState();
      fillPickers();
      renderAll();
      toast("Zutat gelöscht.");
    }
    
    // Global functions for buttons in list
    window.__editIng = (id) => {
      const ing = state.ingredients.find(x => x.id === id);
      if (!ing) return;
      loadIngToForm(ing);
      setTab("ingredients");
      toast("Zutat geladen.");
    };
    
    window.__delIng = (id) => deleteIngredient(id);
    
    function fmtNutri(n) {
      if (!n) return "—";
      return `${round(n.kj, 0)}kJ/${round(n.kcal, 0)}kcal · F ${round(n.fat, 1)} · KH ${round(n.carb, 1)} · Z ${round(n.sugar, 1)} · E ${round(n.protein, 1)} · S ${round(n.salt, 2)}`;
    }
    
    function renderIngredients() {
      fillCatSelects();
      const q = $("ingSearch").value.trim().toLowerCase();
      const cat = $("ingFilterCat").value;
      const list = $("ingList");
      
      if (!list) return;
      
      let items = [...state.ingredients];
      
      // Filter by category
      if (cat && cat !== "Alle") {
        items = items.filter(i => (i.cat || "") === cat);
      }
      
      // Filter by search query
      if (q) {
        items = items.filter(i => {
          const hay = (i.name + " " + (i.cat || "") + " " + (i.allergens || "") + " " + (i.additives || "") + " " + (i.ingredientsText || "")).toLowerCase();
          return hay.includes(q);
        });
      }
      
      if (items.length === 0) {
        list.innerHTML = `<div class="hint">Keine Zutaten gefunden. Füge eine neue Zutat hinzu.</div>`;
        return;
      }
      
      list.innerHTML = items.map(i => {
        const alls = normalizeList(i.allergens).slice(0, 4);
        const adds = normalizeList(i.additives).slice(0, 4);
        const warn = hasAzoWarning(i.additives) || /kann aktivität/i.test(i.note || "");
        
        return `
          <div class="item">
            <div class="meta">
              <div class="name">${escapeHtml(i.name)}</div>
              <div class="small">${escapeHtml(i.cat || "")}</div>
              <div>
                ${alls.map(a => `<span class="pill ok">Allergen: ${escapeHtml(a)}</span>`).join("")}
                ${adds.map(a => `<span class="pill warn">Zusatz: ${escapeHtml(a)}</span>`).join("")}
                ${warn ? `<span class="pill bad">Warnhinweis</span>` : ""}
              </div>
              <div class="small mono">pro 100g: ${fmtNutri(i.n)}</div>
            </div>
            <div class="miniBtns">
              <button class="btnPrimary" onclick="window.__editIng('${i.id}')">Bearbeiten</button>
              <button class="btnBad" onclick="window.__delIng('${i.id}')">Löschen</button>
            </div>
          </div>
        `;
      }).join("");
    }
    
    // Event listeners for ingredients
    $("btnSaveIng").addEventListener("click", saveIngredient);
    $("btnResetIng").addEventListener("click", () => {
      resetIngForm();
      toast("Formular zurückgesetzt.");
    });
    $("ingSearch").addEventListener("input", renderIngredients);
    $("ingFilterCat").addEventListener("change", renderIngredients);

    /* =========================
       RECIPES MANAGEMENT
    ========================= */
    function fillPickers() {
      // Fill ingredient picker for recipes
      const rPick = $("r_pick");
      if (rPick) {
        const list = [...state.ingredients].sort(sortByName);
        rPick.innerHTML = list.map(i => 
          `<option value="${i.id}">${escapeHtml(i.name)} — ${escapeHtml(i.cat || "")}</option>`
        ).join("");
      }
      
      // Fill recipe picker
      const rp = $("recipePicker");
      if (rp) {
        const rList = [...state.recipes].sort((a, b) => (a.name || "").localeCompare((b.name || ""), "de"));
        rp.innerHTML = `<option value="">— Rezept wählen —</option>` + 
          rList.map(r => `<option value="${r.id}">${escapeHtml(r.name)}</option>`).join("");
      }
    }
    
    function setRecipeFromCurrent() {
      const r = state.current.recipe;
      $("r_name").value = r.name || "";
      $("r_type").value = r.type || "auto";
      $("r_netto").value = (r.netto === "custom") ? "custom" : (r.netto || "170");
      $("r_netto_custom").value = r.netto_custom || "";
      $("customNetRow").style.display = ($("r_netto").value === "custom") ? "flex" : "none";
      
      $("eanMode").value = r.eanMode || "auto";
      $("eanCustom").value = r.eanCustom || "";
      $("customEanRow").style.display = ($("eanMode").value === "custom") ? "flex" : "none";
      
      $("r_lot").value = r.lot || "";
      $("r_mhd").value = r.mhd || "";
      $("r_qr").value = r.qr || "";
      $("labelSize").value = r.labelSize || "big";
    }
    
    function addToRecipe() {
      const ingId = $("r_pick").value;
      const qty = num($("r_qty").value);
      const unit = $("r_unit").value;
      
      if (!ingId || qty <= 0) {
        toast("Bitte eine Zutat auswählen und eine Menge > 0 eingeben.");
        return;
      }
      
      state.current.recipe.items.push({ ingId, qty, unit });
      saveState();
      renderRecipeTable();
      renderLabel();
      toast("Zutat hinzugefügt.");
    }
    
    $("btnAddToRecipe").addEventListener("click", addToRecipe);
    
    function removeRecipeItem(idx) {
      state.current.recipe.items.splice(idx, 1);
      saveState();
      renderRecipeTable();
      renderLabel();
      toast("Zutat entfernt.");
    }
    
    window.__rmItem = (idx) => removeRecipeItem(idx);
    
    function compactNote(ing) {
      const adds = normalizeList(ing.additives).slice(0, 6).join(", ");
      const alls = normalizeList(ing.allergens).slice(0, 6).join(", ");
      const parts = [];
      if (alls) parts.push("Allergene: " + alls);
      if (adds) parts.push("Zusatz: " + adds);
      if (ing.note) parts.push(ing.note);
      return parts.join(" · ");
    }
    
    function renderRecipeTable() {
      const tb = $("recipeTable")?.querySelector("tbody");
      if (!tb) return;
      
      const items = state.current.recipe.items || [];
      if (items.length === 0) {
        tb.innerHTML = `<tr><td colspan="5" class="mut" style="text-align: center; padding: 20px;">Noch keine Zutaten im Rezept. Füge Zutaten hinzu.</td></tr>`;
        return;
      }
      
      tb.innerHTML = items.map((it, idx) => {
        const ing = state.ingredients.find(x => x.id === it.ingId);
        const note = (ing?.additives || ing?.note || ing?.allergens) ? compactNote(ing) : "";
        return `
          <tr>
            <td><b>${escapeHtml(ing?.name || "Unbekannt")}</b><div class="mut">${escapeHtml(ing?.cat || "")}</div></td>
            <td class="mono">${round(it.qty, 1)}</td>
            <td class="mono">${escapeHtml(it.unit)}</td>
            <td class="mut">${escapeHtml(note)}</td>
            <td><button class="btnBad" onclick="window.__rmItem(${idx})" title="Entfernen">X</button></td>
          </tr>
        `;
      }).join("");
    }
    
    function newRecipe() {
      if (state.current.recipe.items.length > 0 && !confirm("Aktuelles Rezept verwerfen?")) return;
      
      state.current.editingRecipeId = null;
      state.current.recipe = {
        name: "",
        type: "auto",
        netto: "170",
        netto_custom: "",
        eanMode: "auto",
        eanCustom: "",
        lot: "",
        mhd: new Date(Date.now() + 180 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10), // 6 months from now
        qr: "",
        labelSize: "big",
        items: []
      };
      
      saveState();
      setRecipeFromCurrent();
      renderRecipeTable();
      renderLabel();
      toast("Neues Rezept gestartet.");
    }
    
    $("btnNewRecipe").addEventListener("click", newRecipe);
    
    function saveRecipe() {
      const r = state.current.recipe;
      r.name = $("r_name").value.trim();
      r.type = $("r_type").value;
      r.netto = $("r_netto").value;
      r.netto_custom = $("r_netto_custom").value.trim();
      r.eanMode = $("eanMode").value;
      r.eanCustom = $("eanCustom").value.trim();
      r.lot = $("r_lot").value.trim();
      r.mhd = $("r_mhd").value;
      r.qr = $("r_qr").value.trim();
      r.labelSize = $("labelSize").value;
      
      if (!r.name) {
        toast("Bitte Rezeptnamen eingeben.");
        return;
      }
      
      if ((r.items || []).length === 0) {
        toast("Rezept muss mindestens eine Zutat enthalten.");
        return;
      }
      
      const rec = { 
        id: state.current.editingRecipeId || uid("rec"), 
        ...deepClone(r),
        createdAt: new Date().toISOString()
      };
      
      const idx = state.recipes.findIndex(x => x.id === rec.id);
      if (idx >= 0) {
        state.recipes[idx] = rec;
      } else {
        state.recipes.push(rec);
      }
      
      state.current.editingRecipeId = rec.id;
      saveState();
      fillPickers();
      toast("Rezept gespeichert ✅");
    }
    
    $("btnSaveRecipe").addEventListener("click", saveRecipe);
    
    function loadRecipe(id) {
      const rec = state.recipes.find(r => r.id === id);
      if (!rec) {
        toast("Rezept nicht gefunden.");
        return;
      }
      
      state.current.editingRecipeId = rec.id;
      state.current.recipe = deepClone(rec);
      saveState();
      setRecipeFromCurrent();
      renderRecipeTable();
      renderLabel();
      toast("Rezept geladen: " + rec.name);
    }
    
    $("btnLoadRecipe").addEventListener("click", () => {
      const id = $("recipePicker").value;
      if (!id) {
        toast("Bitte ein Rezept auswählen.");
        return;
      }
      loadRecipe(id);
    });
    
    // Live bindings for recipe form
    ["r_name", "r_netto_custom", "r_lot", "r_mhd", "r_qr", "eanCustom"].forEach(id => {
      const el = $(id);
      if (el) {
        el.addEventListener("input", () => {
          const r = state.current.recipe;
          if (id === "r_name") r.name = el.value;
          if (id === "r_netto_custom") r.netto_custom = el.value;
          if (id === "r_lot") r.lot = el.value;
          if (id === "r_mhd") r.mhd = el.value;
          if (id === "r_qr") r.qr = el.value;
          if (id === "eanCustom") r.eanCustom = el.value;
          saveState();
          renderLabel();
        });
      }
    });
    
    ["r_type", "labelSize", "layoutMode", "fontScale"].forEach(id => {
      const el = $(id);
      if (el) {
        el.addEventListener("change", () => {
          if (id === "r_type") state.current.recipe.type = el.value;
          if (id === "labelSize") state.current.recipe.labelSize = el.value;
          saveState();
          renderLabel();
        });
      }
    });
    
    $("r_netto").addEventListener("change", () => {
      const show = $("r_netto").value === "custom";
      $("customNetRow").style.display = show ? "flex" : "none";
      state.current.recipe.netto = $("r_netto").value;
      saveState();
      renderLabel();
    });
    
    $("eanMode").addEventListener("change", () => {
      const show = $("eanMode").value === "custom";
      $("customEanRow").style.display = show ? "flex" : "none";
      state.current.recipe.eanMode = $("eanMode").value;
      saveState();
      renderLabel();
    });

    /* =========================
       SETTINGS MANAGEMENT
    ========================= */
    function loadSettings() {
      $("s_storage").value = state.settings.storage || "";
      $("s_footer").value = state.settings.footer || "";
      $("s_company").value = state.settings.company || "";
      $("s_addr").value = state.settings.addr || "";
      $("s_phone").value = state.settings.phone || "";
      $("s_email").value = state.settings.email || "";
      $("s_spuren").value = state.settings.spuren || "";
      $("s_azo").value = state.settings.azoText || "";
    }
    
    function saveSettings() {
      state.settings.storage = $("s_storage").value.trim();
      state.settings.footer = $("s_footer").value.trim();
      state.settings.company = $("s_company").value.trim();
      state.settings.addr = $("s_addr").value.trim();
      state.settings.phone = $("s_phone").value.trim();
      state.settings.email = $("s_email").value.trim();
      state.settings.spuren = $("s_spuren").value.trim();
      state.settings.azoText = $("s_azo").value.trim();
      saveState();
      renderLabel();
      toast("Einstellungen gespeichert ✅");
    }
    
    $("btnSaveSettings").addEventListener("click", saveSettings);

    /* =========================
       LABEL CALCULATION & RENDERING
    ========================= */
    function recipeTotals() {
      const items = state.current.recipe.items || [];
      let totalG = 0;
      const sum = {kj: 0, kcal: 0, fat: 0, sat: 0, carb: 0, sugar: 0, protein: 0, salt: 0, fiber: 0};
      const allergens = [];
      const additives = [];
      let warn = false;
      
      for (const it of items) {
        const ing = state.ingredients.find(x => x.id === it.ingId);
        if (!ing) continue;
        
        // Convert to grams (assume 1ml = 1g for simplicity)
        const qtyG = it.qty * (it.unit === "ml" ? 1 : 1);
        totalG += qtyG;
        
        const n = ing.n || {};
        const factor = qtyG / 100;
        
        sum.kj += (num(n.kj) * factor);
        sum.kcal += (num(n.kcal) * factor);
        sum.fat += (num(n.fat) * factor);
        sum.sat += (num(n.sat) * factor);
        sum.carb += (num(n.carb) * factor);
        sum.sugar += (num(n.sugar) * factor);
        sum.protein += (num(n.protein) * factor);
        sum.salt += (num(n.salt) * factor);
        sum.fiber += (num(n.fiber) * factor);
        
        // Collect allergens and additives
        normalizeList(ing.allergens).forEach(a => allergens.push(a));
        normalizeList(ing.additives).forEach(a => additives.push(a));
        
        // Check for warnings
        if (hasAzoWarning(ing.additives) || /kann aktivität/i.test(ing.note || "")) {
          warn = true;
        }
      }
      
      // Calculate per 100g values
      const per100 = totalG > 0 ? {
        kj: (sum.kj * 100) / totalG,
        kcal: (sum.kcal * 100) / totalG,
        fat: (sum.fat * 100) / totalG,
        sat: (sum.sat * 100) / totalG,
        carb: (sum.carb * 100) / totalG,
        sugar: (sum.sugar * 100) / totalG,
        protein: (sum.protein * 100) / totalG,
        salt: (sum.salt * 100) / totalG,
        fiber: (sum.fiber * 100) / totalG
      } : {kj: 0, kcal: 0, fat: 0, sat: 0, carb: 0, sugar: 0, protein: 0, salt: 0, fiber: 0};
      
      return {
        totalG,
        per100,
        allergens: uniq(allergens),
        additives: uniq(additives),
        warn
      };
    }
    
    function ingredientListText() {
      const items = [...(state.current.recipe.items || [])].sort((a, b) => num(b.qty) - num(a.qty));
      const parts = [];
      
      for (const it of items) {
        const ing = state.ingredients.find(x => x.id === it.ingId);
        if (!ing) continue;
        
        let txt = (ing.ingredientsText && ing.ingredientsText.trim()) 
          ? ing.ingredientsText.trim() 
          : ing.name;
        
        parts.push(txt);
      }
      
      let result = parts.join(", ");
      // Clean up punctuation
      result = result.replace(/\s+,/g, ",").replace(/,\s+,/g, ", ");
      return result;
    }
    
    function autoProductType() {
      const items = state.current.recipe.items || [];
      const hasWater = items.some(it => it.ingId === "i_water");
      const hasMilk = items.some(it => 
        it.ingId === "i_milk_uht_35" || 
        it.ingId === "i_cream_33" || 
        it.ingId === "i_skim_milk_powder"
      );
      
      if (hasWater && !hasMilk) return "Fruchteis";
      return "Speiseeis";
    }
    
    function resolveEAN() {
      const r = state.current.recipe;
      const netto = r.netto;
      const mode = r.eanMode || "auto";
      
      if (mode === "off") return "";
      if (mode === "170") return EAN_170;
      if (mode === "750") return EAN_750;
      if (mode === "custom") return (r.eanCustom || "").trim();
      
      // Auto mode
      if (netto === "170") return EAN_170;
      if (netto === "750") return EAN_750;
      
      // Fallback to custom if set
      return (r.eanCustom || "").trim();
    }
    
    function nettoText() {
      const r = state.current.recipe;
      if (r.netto === "custom" && (r.netto_custom || "").trim()) {
        return r.netto_custom.trim();
      }
      return (r.netto || "170") + " g";
    }
    
    function makeSimpleQR(text) {
      const s = String(text || "");
      if (!s) return "";
      
      // Simple deterministic "QR-like" pattern for demo
      const size = 29;
      const mod = 5;
      const w = size * mod;
      
      // Create a simple pattern based on text hash
      let hash = 0;
      for (let i = 0; i < s.length; i++) {
        hash = ((hash << 5) - hash) + s.charCodeAt(i);
        hash |= 0;
      }
      
      const seed = Math.abs(hash);
      const cells = [];
      
      for (let y = 0; y < size; y++) {
        for (let x = 0; x < size; x++) {
          // Create finder patterns (corners)
          const isFinder = 
            (x < 8 && y < 8) || 
            (x > size - 9 && y < 8) || 
            (x < 8 && y > size - 9);
          
          let on = false;
          if (isFinder) {
            on = true;
          } else {
            // Random-ish pattern based on seed
            const val = (seed * x * y) % 100;
            on = val < 55;
          }
          
          if (on) {
            cells.push(`<rect x="${x * mod}" y="${y * mod}" width="${mod}" height="${mod}" fill="#000"/>`);
          }
        }
      }
      
      return `<svg viewBox="0 0 ${w} ${w}" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
        <rect width="${w}" height="${w}" fill="#fff"/>
        ${cells.join("")}
      </svg>`;
    }
    
    function renderLabel() {
      const host = $("previewHost");
      if (!host) return;
      
      const r = state.current.recipe;
      const totals = recipeTotals();
      const mode = $("layoutMode")?.value || "clean";
      const fs = num($("fontScale")?.value || 1);
      const size = $("labelSize")?.value || "big";
      
      // Set preview scale
      host.style.setProperty("--previewScale", String(fs));
      
      // Determine product type
      const type = (r.type === "auto") ? autoProductType() : r.type;
      const netto = nettoText();
      const ean = resolveEAN();
      
      // Prepare text content
      const ingText = ingredientListText();
      const alls = totals.allergens.length ? totals.allergens.join(", ") : "—";
      const adds = totals.additives.length ? totals.additives.join(", ") : "—";
      const warnLine = totals.warn ? `<div class="warning-text">${escapeHtml(state.settings.azoText || "")}</div>` : "";
      
      const n = totals.per100;
      
      // Header section
      const header = `
        <div class="lblHeader">
          <div class="prodName">${escapeHtml(r.name || "Gelato")}</div>
          <div class="prodMeta"><b>${escapeHtml(type)}</b> · Netto: <b>${escapeHtml(netto)}</b></div>
          ${mode === "clean" ? `<div class="prodMeta2">${escapeHtml(state.settings.storage || "")}</div>` : ""}
        </div>
      `;
      
      // Nutrition table
      const nutriTable = `
        <table class="nutri">
          <tr><th>Energie</th><td class="mono">${round(n.kj, 0)} kJ / ${round(n.kcal, 0)} kcal</td></tr>
          <tr><th>Fett</th><td class="mono">${round(n.fat, 1)} g</td></tr>
          <tr><th>davon gesättigt</th><td class="mono">${round(n.sat, 1)} g</td></tr>
          <tr><th>Kohlenhydrate</th><td class="mono">${round(n.carb, 1)} g</td></tr>
          <tr><th>davon Zucker</th><td class="mono">${round(n.sugar, 1)} g</td></tr>
          <tr><th>Eiweiß</th><td class="mono">${round(n.protein, 1)} g</td></tr>
          <tr><th>Salz</th><td class="mono">${round(n.salt, 2)} g</td></tr>
        </table>
      `;
      
      // Right column content
      const right = `
        <div class="rightCol">
          <div class="blk"><b>Zutaten:</b> ${escapeHtml(ingText || "—")}</div>
          <div class="blk"><b>Allergene:</b> ${escapeHtml(alls)}</div>
          <div class="blk"><b>Zusatzstoffe:</b> ${escapeHtml(adds)}</div>
          ${state.settings.spuren ? `<div class="spuren">${escapeHtml(state.settings.spuren)}</div>` : ""}
          ${mode === "compact" ? `<div class="blk">${escapeHtml(state.settings.storage || "")}</div>` : ""}
          ${warnLine}
          <div class="blk">
            <b>Hersteller:</b> ${escapeHtml(state.settings.company || "")} · ${escapeHtml(state.settings.addr || "")}<br>
            ${escapeHtml(state.settings.phone || "")}${state.settings.email ? (" · " + escapeHtml(state.settings.email)) : ""}<br>
            ${state.settings.footer ? escapeHtml(state.settings.footer) : ""}
          </div>
        </div>
      `;
      
      // QR code
      const qrLink = (r.qr || "").trim();
      const qrHtml = qrLink ? `<div class="qrBox">${makeSimpleQR(qrLink)}</div>` : "";
      
      // Footer with barcode
      const barcodeHtml = ean ? makeBarcodeSVG(ean) : '<div style="text-align: center; color: #999; font-size: 8pt;">Kein Barcode</div>';
      
      const footer = `
        <div class="lblFooter">
          <div class="barcodeBox">
            <div class="barcodeContainer">
              ${barcodeHtml}
            </div>
            ${ean ? `<div class="eanText">${escapeHtml(ean)}</div>` : '<div class="eanText">—</div>'}
          </div>
          ${qrHtml}
          <div class="lotMini">
            <b>Charge/Lot:</b> ${escapeHtml(r.lot || "—")}<br>
            <b>MHD:</b> ${escapeHtml(r.mhd || "—")}
          </div>
        </div>
      `;
      
      // Determine label class
      let cls = "lbl big";
      if (size === "small") cls = "lbl small";
      if (size === "round") cls = "lbl round";
      
      // Body grid
      const body = `
        <div class="lblBody">
          <div class="bodyGrid">
            <div>${nutriTable}</div>
            ${right}
          </div>
        </div>
      `;
      
      // Complete label HTML
      const html = `
        <div class="${cls}">
          ${header}
          ${body}
          ${footer}
        </div>
      `;
      
      host.innerHTML = html;
    }

    /* =========================
       PRINT FUNCTIONALITY
    ========================= */
    $("btnPrint").addEventListener("click", () => {
      // Update current recipe from form
      const r = state.current.recipe;
      r.name = $("r_name").value;
      r.type = $("r_type").value;
      r.netto = $("r_netto").value;
      r.netto_custom = $("r_netto_custom").value;
      r.eanMode = $("eanMode").value;
      r.eanCustom = $("eanCustom").value;
      r.lot = $("r_lot").value;
      r.mhd = $("r_mhd").value;
      r.qr = $("r_qr").value;
      r.labelSize = $("labelSize").value;
      saveState();
      
      const size = $("labelSize").value;
      const mode = $("layoutMode").value;
      
      // Dimensions
      let dims = { w: 100, h: 62, shape: "rect" };
      if (size === "small") dims = { w: 90, h: 38, shape: "rect" };
      if (size === "round") dims = { w: 62, h: 62, shape: "round" };
      
      // Get preview HTML
      const html = $("previewHost").innerHTML;
      
      // Create print window
      const w = window.open("", "_blank", "width=800,height=600");
      if (!w) {
        toast("Popup blockiert! Bitte Popups für diese Seite erlauben.", 4000);
        return;
      }
      
      w.document.open();
      w.document.write(`
        <!doctype html>
        <html><head><meta charset="utf-8">
          <meta name="viewport" content="width=device-width,initial-scale=1">
          <title>Etikett Druck - ${escapeHtml(r.name || "Gelato")}</title>
          <style>
            @page { 
              size: ${dims.w}mm ${dims.h}mm; 
              margin: 0; 
            }
            html, body { 
              margin: 0; 
              padding: 0; 
              background: #fff;
              width: ${dims.w}mm;
              height: ${dims.h}mm;
              overflow: hidden;
            }
            body {
              display: flex;
              align-items: center;
              justify-content: center;
            }
            
            .lbl {
              width: ${dims.w}mm;
              height: ${dims.h}mm;
              background: #fff;
              color: #000;
              overflow: hidden;
              position: relative;
              font-family: Arial, Helvetica, sans-serif;
              display: grid;
              grid-template-rows: auto 1fr var(--footerH);
              box-sizing: border-box;
              -webkit-print-color-adjust: exact;
              print-color-adjust: exact;
            }
            
            .lbl.round { border-radius: 999px; }
            
            .lblHeader { 
              padding: 2.6mm 2.6mm 1.2mm; 
              border-bottom: 0.2mm solid #eee;
            }
            
            .lblBody { 
              padding: 1.3mm 2.6mm 1.2mm; 
              overflow: hidden; 
            }
            
            .lblFooter {
              border-top: 0.35mm solid #111;
              padding: 1.6mm 2.6mm 1.4mm;
              display: flex;
              align-items: flex-end;
              justify-content: space-between;
              gap: 2.4mm;
              overflow: hidden;
              background: #f9f9f9;
            }
            
            .prodName { 
              font-weight: 900; 
              letter-spacing: .2px; 
              margin: 0 0 0.5mm 0;
              line-height: 1.2;
            }
            
            .prodMeta { 
              font-size: 8.2pt; 
              margin-top: 0.5mm;
              color: #333;
            }
            
            .prodMeta2 { 
              font-size: 8.0pt; 
              margin-top: .6mm; 
              color: #666;
            }
            
            .bodyGrid {
              display: grid;
              grid-template-columns: ${size === "round" ? "1fr" : "45% 55%"};
              gap: ${size === "small" ? "1.6mm" : "2.2mm"};
              align-items: start;
              height: 100%;
            }
            
            .rightCol { 
              min-width: 0; 
              overflow: hidden; 
            }
            
            table.nutri {
              width: 100%;
              border-collapse: collapse;
              font-size: ${size === "small" ? "7.0pt" : "7.2pt"};
              margin: 0;
            }
            
            table.nutri td, table.nutri th {
              border: 0.3mm solid #000;
              padding: ${size === "small" ? "0.5mm 0.6mm" : "0.6mm 0.8mm"};
              vertical-align: top;
              line-height: 1.3;
            }
            
            table.nutri th { 
              text-align: left; 
              font-weight: 800; 
              background: #f5f5f5;
            }
            
            .blk {
              font-size: ${size === "small" ? "7.0pt" : "7.2pt"};
              line-height: 1.22;
              margin-top: ${size === "small" ? "0.8mm" : "1.0mm"};
              color: #222;
            }
            
            .blk b { 
              font-weight: 900; 
              color: #000;
            }
            
            .spuren {
              border: 0.3mm solid #000;
              padding: ${size === "small" ? "0.6mm 0.8mm" : "0.8mm 1.0mm"};
              font-weight: 800;
              overflow: hidden;
              display: -webkit-box;
              -webkit-box-orient: vertical;
              -webkit-line-clamp: ${size === "small" ? 2 : 3};
              background: #fff9e6;
              margin-top: 1mm;
              font-size: ${size === "small" ? "6.8pt" : "7.0pt"};
            }
            
            .barcodeBox {
              display: flex;
              flex-direction: column;
              gap: 0.3mm;
              align-items: center;
              justify-content: center;
              min-width: 40mm;
              max-width: 50%;
            }
            
            .barcodeContainer {
              width: 100%;
              height: 15mm;
              background: #fff;
              border: 0.2mm solid #ccc;
              padding: 0.5mm;
              display: flex;
              align-items: center;
              justify-content: center;
            }
            
            .eanText {
              font-size: 7.4pt;
              letter-spacing: .2px;
              text-align: center;
              margin-top: 0.3mm;
              font-family: "Courier New", monospace;
              font-weight: bold;
              color: #000;
            }
            
            .lotMini {
              font-size: 7.2pt;
              line-height: 1.15;
              white-space: nowrap;
              overflow: hidden;
              text-overflow: ellipsis;
              color: #333;
              max-width: 25mm;
            }
            
            .lotMini b {
              color: #000;
            }
            
            .qrBox {
              width: 16mm;
              height: 16mm;
              border: 0.3mm solid #000;
              display: flex;
              align-items: center;
              justify-content: center;
              overflow: hidden;
              background: #fff;
              flex: 0 0 auto;
            }
            
            .qrBox svg { 
              width: 100%; 
              height: 100%; 
            }
            
            .warning-text {
              color: #d00;
              font-weight: bold;
              border: 0.2mm solid #d00;
              padding: 0.5mm;
              margin-top: 0.5mm;
              background: #fff0f0;
              font-size: 7.0pt;
            }
            
            .lbl.big { --footerH: 13.8mm; }
            .lbl.small { --footerH: 11.8mm; }
            .lbl.round { --footerH: 14mm; }
            
            .lbl.round table.nutri { display: none; }
            .lbl.round .spuren { display: none; }
            .lbl.round .prodMeta2 { display: none; }
            .lbl.round .blk { font-size: 8.0pt; }
            .lbl.round .prodName { 
              font-size: 13pt; 
              text-align: center;
            }
            .lbl.round .prodMeta { 
              text-align: center; 
            }
            
            svg {
              width: 100%;
              height: auto;
              max-width: 100%;
            }
          </style>
        </head>
        <body>
          ${html}
          <script>
            window.onload = function() {
              // Wait a bit for fonts to load
              setTimeout(function() {
                window.print();
                setTimeout(function() {
                  window.close();
                }, 500);
              }, 250);
            };
            
            window.onbeforeprint = function() {
              // Ensure proper scaling
              document.body.style.zoom = "1";
            };
          <\/script>
        </body></html>
      `);
      w.document.close();
    });

    /* =========================
       BACKUP & IMPORT/EXPORT
    ========================= */
    $("btnExport").addEventListener("click", () => {
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `sanremo-etiketten-backup-${new Date().toISOString().slice(0, 10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(() => URL.revokeObjectURL(url), 100);
      toast("Backup exportiert.");
    });
    
    $("btnImport").addEventListener("click", () => $("fileImport").click());
    
    $("fileImport").addEventListener("change", async (e) => {
      const f = e.target.files?.[0];
      if (!f) return;
      
      try {
        const txt = await f.text();
        const obj = JSON.parse(txt);
        
        if (!obj || typeof obj !== "object") {
          throw new Error("Ungültige Datei");
        }
        
        // Merge with defaults
        state = {
          ...deepClone(DEFAULT_STATE),
          ...obj,
          settings: { ...deepClone(DEFAULT_STATE.settings), ...(obj.settings || {}) },
          current: { ...deepClone(DEFAULT_STATE.current), ...(obj.current || {}) },
          ingredients: obj.ingredients || [],
          recipes: obj.recipes || []
        };
        
        saveState();
        fillCatSelects();
        fillPickers();
        loadSettings();
        setRecipeFromCurrent();
        renderAll();
        toast("Backup importiert ✅");
      } catch (err) {
        console.error("Import error:", err);
        toast("Import fehlgeschlagen. Ungültiges Dateiformat.");
      } finally {
        $("fileImport").value = "";
      }
    });

    /* =========================
       INITIAL SEED DATA
    ========================= */
    function ensureSeed() {
      if (state.ingredients && state.ingredients.length > 0) return;
      
      const seed = [
        {
          id: "i_milk_uht_35",
          name: "H-Vollmilch 3,5% (UHT)",
          cat: "Milch & Sahne",
          allergens: "MILCH",
          additives: "",
          ingredientsText: "Vollmilch (MILCH).",
          note: "",
          n: {kj: 270, kcal: 64, fat: 3.5, sat: 2.2, carb: 4.8, sugar: 4.8, protein: 3.4, salt: 0.10, fiber: 0}
        },
        {
          id: "i_cream_33",
          name: "Schlagsahne 33% Fett",
          cat: "Milch & Sahne",
          allergens: "MILCH",
          additives: "",
          ingredientsText: "Schlagsahne (MILCH).",
          note: "",
          n: {kj: 1350, kcal: 327, fat: 33, sat: 22, carb: 3.3, sugar: 3.3, protein: 2.4, salt: 0.08, fiber: 0}
        },
        {
          id: "i_skim_milk_powder",
          name: "Magermilchpulver",
          cat: "Pulver & Stabilisierung",
          allergens: "MILCH",
          additives: "",
          ingredientsText: "Magermilchpulver (MILCH).",
          note: "",
          n: {kj: 1480, kcal: 350, fat: 1, sat: 0.7, carb: 52, sugar: 52, protein: 36, salt: 0.5, fiber: 0}
        },
        {
          id: "i_sugar",
          name: "Zucker (Saccharose)",
          cat: "Zucker & Süßung",
          allergens: "",
          additives: "",
          ingredientsText: "Zucker.",
          note: "",
          n: {kj: 1700, kcal: 400, fat: 0, sat: 0, carb: 100, sugar: 100, protein: 0, salt: 0, fiber: 0}
        },
        {
          id: "i_dextrose",
          name: "Dextrose",
          cat: "Zucker & Süßung",
          allergens: "",
          additives: "",
          ingredientsText: "Dextrose.",
          note: "",
          n: {kj: 1700, kcal: 400, fat: 0, sat: 0, carb: 100, sugar: 100, protein: 0, salt: 0, fiber: 0}
        },
        {
          id: "i_base_soave",
          name: "Base Soave (Milch-Base)",
          cat: "Pulver & Stabilisierung",
          allergens: "",
          additives: "E412, E407, E410",
          ingredientsText: "Stabilisatoren (E412, E407, E410).",
          note: "",
          n: {kj: 1500, kcal: 360, fat: 0, sat: 0, carb: 90, sugar: 10, protein: 0, salt: 0.1, fiber: 0}
        },
        {
          id: "i_supergelmix",
          name: "Supergelmix D (für Fruchteis)",
          cat: "Pulver & Stabilisierung",
          allergens: "",
          additives: "E440, E412, E415",
          ingredientsText: "Stabilisatoren (E440, E412, E415).",
          note: "",
          n: {kj: 1400, kcal: 335, fat: 0, sat: 0, carb: 85, sugar: 5, protein: 0, salt: 0.2, fiber: 0}
        },
        {
          id: "i_water",
          name: "Wasser",
          cat: "Sonstiges",
          allergens: "",
          additives: "",
          ingredientsText: "Wasser.",
          note: "",
          n: {kj: 0, kcal: 0, fat: 0, sat: 0, carb: 0, sugar: 0, protein: 0, salt: 0, fiber: 0}
        },
        {
          id: "i_strawberry",
          name: "Erdbeeren (frisch)",
          cat: "Frucht / Püree",
          allergens: "",
          additives: "",
          ingredientsText: "Erdbeeren.",
          note: "",
          n: {kj: 120, kcal: 29, fat: 0.3, sat: 0.0, carb: 7.7, sugar: 4.9, protein: 0.7, salt: 0.01, fiber: 2.0}
        },
        {
          id: "i_mango",
          name: "Mango (frisch)",
          cat: "Frucht / Püree",
          allergens: "",
          additives: "",
          ingredientsText: "Mango.",
          note: "",
          n: {kj: 250, kcal: 60, fat: 0.4, sat: 0.1, carb: 15.0, sugar: 13.7, protein: 0.8, salt: 0.01, fiber: 1.6}
        },
        {
          id: "i_pistachio_paste",
          name: "Pistazienpaste",
          cat: "Pasten & Nüsse",
          allergens: "SCHALENFRÜCHTE, PISTAZIEN",
          additives: "",
          ingredientsText: "Pistazien (SCHALENFRÜCHTE).",
          note: "",
          n: {kj: 2500, kcal: 600, fat: 50, sat: 6, carb: 27, sugar: 7, protein: 20, salt: 0.1, fiber: 10}
        }
      ];
      
      state.ingredients = seed.sort((a, b) => (a.name || "").localeCompare((b.name || ""), "de"));
      saveState();
    }

    /* =========================
       RENDER ALL
    ========================= */
    function renderAll() {
      fillCatSelects();
      fillPickers();
      loadSettings();
      setRecipeFromCurrent();
      renderIngredients();
      renderRecipeTable();
      renderLabel();
    }

    /* =========================
       INITIALIZATION
    ========================= */
    function init() {
      ensureSeed();
      fillCatSelects();
      fillPickers();
      loadSettings();
      
      // Set default MHD if not set
      if (!state.current.recipe.mhd) {
        const d = new Date();
        d.setMonth(d.getMonth() + 6); // 6 months from now
        state.current.recipe.mhd = d.toISOString().slice(0, 10);
        saveState();
      }
      
      setRecipeFromCurrent();
      renderAll();
      resetIngForm();
      
      // Show welcome message
      setTimeout(() => {
        toast("Sanremo Gelato Etikett Generator geladen ✅");
      }, 500);
    }
    
    // Initialize when DOM is loaded
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }
  </script>
</body>
</html>

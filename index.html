
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Sanremo Gelato ‚Äì LMIV Etikett (Brother QL-810W)</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#0b0e14; --card:#121827; --text:#eef2ff; --muted:#98a7c4;
      --line:rgba(255,255,255,.10);
      --accent:#7c3aed; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --shadow: 0 12px 28px rgba(0,0,0,.35);
      --r:18px;

      /* QL-810W default: DK-22205 (62mm width) */
      --labelWmm:62;
      --labelHmm:60;
      --labelFont: 11.2px; /* auto-ish */
    }
    @media (prefers-color-scheme: light){
      :root{--bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#516079; --line:rgba(15,23,42,.10); --shadow: 0 10px 22px rgba(2,6,23,.08);}
    }
    *{box-sizing:border-box}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text);}
    .wrap{max-width:1100px; margin:0 auto; padding:14px 14px 80px;}
    header{
      position:sticky; top:0; z-index:20;
      background: color-mix(in oklab, var(--bg) 70%, transparent);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
      padding:12px 0;
    }
    .topbar{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      max-width:1100px; margin:0 auto; padding:0 14px;
    }
    .brand{display:flex; gap:10px; align-items:center; min-width:0}
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(34,197,94,.9));
      display:grid; place-items:center; box-shadow: 0 12px 22px rgba(0,0,0,.25);
      flex:0 0 auto;
    }
    .logo svg{width:22px; height:22px}
    .brand .t{display:flex; flex-direction:column; min-width:0; line-height:1.1}
    .brand .t b{font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .brand .t span{font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding:12px 12px;
      border-radius: 14px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
      display:inline-flex; gap:8px; align-items:center; justify-content:center;
      min-height:44px;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{background: rgba(124,58,237,.18); border-color: rgba(124,58,237,.35)}
    .btn.good{background: rgba(34,197,94,.16); border-color: rgba(34,197,94,.33)}
    .btn.warn{background: rgba(245,158,11,.16); border-color: rgba(245,158,11,.33)}
    .btn.bad{background: rgba(239,68,68,.14); border-color: rgba(239,68,68,.32)}
    .btn.ghost{background: transparent}
    .chip{
      display:inline-flex; gap:8px; align-items:center;
      padding:10px 12px; border:1px solid var(--line); border-radius:999px;
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .grid{display:grid; grid-template-columns: 1fr; gap:12px; margin-top:14px;}
    @media(min-width:980px){ .grid{grid-template-columns: 360px 1fr;} }

    .card{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0; padding:12px 14px; font-size:14px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card h2 small{color:var(--muted); font-weight:600}
    .body{padding:14px}

    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input,select,textarea{
      width:100%; padding:12px 12px; border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.14);
      color:var(--text);
      outline:none;
      font-size:14px;
      min-height:44px;
    }
    @media (prefers-color-scheme: light){
      input,select,textarea{background: rgba(2,6,23,.03)}
    }
    textarea{min-height:90px; resize:vertical}

    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media(max-width:520px){ .row{grid-template-columns:1fr} }
    .flex{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .muted{color:var(--muted)}
    .divider{height:1px; background:var(--line); margin:12px 0}
    .list{display:flex; flex-direction:column; gap:10px; max-height:62vh; overflow:auto; padding-right:4px}
    .item{
      border:1px solid var(--line);
      border-radius:18px;
      padding:10px;
      background: rgba(255,255,255,.02);
    }
    .item .top{display:flex; justify-content:space-between; gap:10px; align-items:flex-start}
    .item b{font-size:14px}
    .item .meta{font-size:12px; color:var(--muted); margin-top:4px; line-height:1.35}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      font-size:11px; color:var(--muted);
      margin:6px 6px 0 0;
    }

    table{width:100%; border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line); padding:10px 8px; text-align:left; font-size:13px; vertical-align:top}
    th{color:var(--muted); font-weight:900}
    td input{min-height:40px}
    .right{text-align:right}

    .notice{
      border:1px dashed rgba(245,158,11,.55);
      background: rgba(245,158,11,.10);
      border-radius: 18px;
      padding:12px;
      font-size:12.5px;
      line-height:1.35;
    }

    /* LABEL (Preview + Print) */
    .labelShell{
      border:1px solid var(--line);
      border-radius:22px;
      background: rgba(255,255,255,.02);
      padding:14px;
    }
    .label{
      width: calc(var(--labelWmm) * 1mm);
      min-height: calc(var(--labelHmm) * 1mm);
      background:#fff;
      color:#111827;
      border:1px solid rgba(17,24,39,.12);
      border-radius: 12px;
      padding: 10px 10px;
      box-shadow: 0 10px 22px rgba(0,0,0,.14);
      font-size: var(--labelFont);
      line-height: 1.25;
    }
    .lh{
      display:flex; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(17,24,39,.10);
      padding-bottom:6px; margin-bottom:6px;
    }
    .lh b{font-size: 12.6px}
    .lh small{color:#374151; font-size:11px}
    .titleLine{font-weight:1000; margin:6px 0 6px; font-size: 13px}
    .cap{font-weight:1000; font-size: 11px; margin-bottom:3px}
    .p{margin:0 0 7px}
    .small{font-size: 10.7px; color:#374151}
    .foot{
      display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap;
      margin-top:7px; padding-top:7px;
      border-top:1px solid rgba(17,24,39,.10);
      font-size:10.6px; color:#374151;
    }
    .nutri table{font-size:10.6px}
    .nutri th,.nutri td{border-bottom:1px solid rgba(17,24,39,.10); padding:5px 5px}
    .nutri th{color:#374151}

    /* Allergens highlight: RED + bold + underline (nice with QL red/black tape) */
    .allergen{
      color:#c00000;
      font-weight:1000;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    /* Bottom action bar for mobile */
    .bottomBar{
      position:fixed; left:0; right:0; bottom:0; z-index:30;
      border-top:1px solid var(--line);
      background: color-mix(in oklab, var(--bg) 80%, transparent);
      backdrop-filter: blur(10px);
      padding:10px 14px;
    }
    .bottomBar .inner{max-width:1100px; margin:0 auto; display:flex; gap:10px}
    .bottomBar .inner .btn{flex:1}

    /* PRINT for Brother QL */
    @media print{
      header, .wrap, .bottomBar, .no-print{display:none !important;}
      #printArea{display:block !important;}
      body{background:#fff !important}
      #printArea .label{box-shadow:none !important; border-radius:0 !important; border:none !important; padding:0 !important;}
    }
    #printArea{display:none}
  </style>

  <!-- Dynamic print page size (set by JS) -->
  <style id="pageSizeStyle">
    @page { size: 62mm 60mm; margin: 0; }
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M7 7c0-2.2 2.2-4 5-4s5 1.8 5 4-2.2 4-5 4-5-1.8-5-4Z" stroke="white" stroke-width="2"/>
          <path d="M9 21h6M10 15l2 6M14 15l-2 6" stroke="white" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="t">
        <b>Sanremo Gelato ‚Äì Etiketten</b>
        <span>LMIV ¬∑ N√§hrwerte ¬∑ Allergene ¬∑ Brother QL-810W (62 mm)</span>
      </div>
    </div>

    <div class="flex" style="justify-content:flex-end">
      <span class="chip">Breite: <b id="wInfo">62mm</b></span>
      <button class="btn ghost no-print" id="btnBackup">‚¨áÔ∏è Backup</button>
      <label class="btn ghost no-print" style="cursor:pointer">
        ‚¨ÜÔ∏è Import
        <input id="fileImport" type="file" accept="application/json" style="display:none">
      </label>
      <button class="btn bad no-print" id="btnReset">üóëÔ∏è Reset</button>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT: Zutatenbank -->
    <div class="card">
      <h2>Zutatenbank (nur Gelato) <small id="ingCount">0</small></h2>
      <div class="body">
        <div class="row">
          <div>
            <label>Suche</label>
            <input id="q" placeholder="Milch, Zucker, Pistazie, Amarena..." />
          </div>
          <div>
            <label>Kategorie</label>
            <select id="catFilter">
              <option value="">Alle</option>
              <option>Milchprodukte</option>
              <option>Zucker/Carbs</option>
              <option>Fette</option>
              <option>Frucht</option>
              <option>N√ºsse</option>
              <option>Schokolade/Kakao</option>
              <option>Stabilisator/Emulgator</option>
              <option>Aromen/Pasten</option>
              <option>Zusatzstoffe/Farbstoffe</option>
              <option>Sonstiges</option>
            </select>
          </div>
        </div>

        <div class="divider"></div>

        <div class="flex">
          <button class="btn primary" id="btnNewIng">‚ûï Zutat</button>
          <button class="btn good" id="btnGelatoPack">üç¶ Basis-Pack</button>
        </div>

        <div class="divider"></div>

        <div class="list" id="ingList"></div>

        <div class="notice">
          <b>Wichtig (Supermarkt):</b><br>
          F√ºr jede Zutat brauchst du korrekte N√§hrwerte vom Lieferanten (Etikett/Spezifikation).
          Das Tool markiert Allergene rot und erstellt die Zutatenliste absteigend.
        </div>
      </div>
    </div>

    <!-- RIGHT: Rezept + Etikett -->
    <div class="card">
      <h2>Rezept & Etikett <small id="status">bereit</small></h2>
      <div class="body">
        <div class="row">
          <div>
            <label>Gespeicherter Geschmack</label>
            <select id="flavorSelect"></select>
          </div>
          <div>
            <label>Aktion</label>
            <div class="flex">
              <button class="btn" id="btnNewFlavor">‚ûï Neu</button>
              <button class="btn warn" id="btnSaveFlavor">üíæ Speichern</button>
              <button class="btn bad" id="btnDeleteFlavor">üóëÔ∏è L√∂schen</button>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Verkehrsbezeichnung (LMIV)</label>
            <input id="prodName" placeholder="z.B. Speiseeis / Milcheis / Sorbet" />
          </div>
          <div>
            <label>Geschmack / Sorte</label>
            <input id="flavorName" placeholder="z.B. Pistazie, Amarena, Cookies..." />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Nettof√ºllmenge</label>
            <select id="netQty">
              <option value="170 g">170 g (Becher)</option>
              <option value="750 g">750 g (Family)</option>
              <option value="custom">Benutzerdefiniert‚Ä¶</option>
            </select>
          </div>
          <div>
            <label>Custom Nettof√ºllmenge (falls gew√§hlt)</label>
            <input id="netQtyCustom" placeholder="z.B. 240 ml / 500 g" disabled />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>MHD</label>
            <input id="mhd" placeholder="TT.MM.JJJJ" />
          </div>
          <div>
            <label>Los / Charge</label>
            <input id="lot" placeholder="z.B. L241217-01" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Hersteller</label>
            <input id="maker" value="Eiscaf√© Sanremo" />
          </div>
          <div>
            <label>Adresse / Kontakt</label>
            <input id="contact" value="57319 Bad Berleburg ¬∑ Tel. 0176 72809926 ¬∑ paulo.sanremo@web.de" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Aufbewahrung</label>
            <input id="storage" value="Tiefgek√ºhlt bei -18¬∞C lagern. Nach dem Auftauen nicht wieder einfrieren." />
          </div>
          <div>
            <label>Hinweis (optional)</label>
            <input id="mandatoryNote" placeholder="z.B. Kann Spuren von ... enthalten" />
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div>
            <label>Etikettgr√∂√üe (Brother DK 62mm)</label>
            <select id="labelPreset">
              <option value="62x37">62√ó37 mm (klein / 170g)</option>
              <option value="62x60" selected>62√ó60 mm (Standard)</option>
              <option value="62x100">62√ó100 mm (viel Text/QR)</option>
              <option value="custom">Benutzerdefiniert (mm)</option>
            </select>
          </div>
          <div>
            <div class="row">
              <div>
                <label>H√∂he (mm)</label>
                <input id="customH" type="number" min="25" step="1" placeholder="z.B. 60" disabled />
              </div>
              <div>
                <label>Textgr√∂√üe</label>
                <select id="fontPreset">
                  <option value="10.6">klein</option>
                  <option value="11.2" selected>normal</option>
                  <option value="12.0">gro√ü</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="flex">
          <button class="btn primary" id="btnAddLine">‚ûï Zutat ins Rezept</button>
          <button class="btn" id="btnSort">‚ÜïÔ∏è Sortieren</button>
          <button class="btn bad" id="btnClearRecipe">üßπ Rezept leeren</button>
        </div>

        <div style="margin-top:12px; overflow:auto; border:1px solid var(--line); border-radius:18px">
          <table id="recipeTable">
            <thead>
              <tr>
                <th style="min-width:220px">Zutat</th>
                <th style="min-width:140px">Menge (g)</th>
                <th class="right">Aktion</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div>
            <label>Zutatenliste (automatisch)</label>
            <textarea id="ingredientsOut" readonly></textarea>
          </div>
          <div>
            <label>Allergene / Hinweise</label>
            <textarea id="allergensOut" readonly></textarea>
          </div>
        </div>

        <div class="divider"></div>

        <div class="labelShell">
          <div class="flex no-print" style="justify-content:space-between">
            <span class="chip">Vorschau (wird so gedruckt)</span>
            <span class="chip">Breite fix: 62 mm</span>
          </div>
          <div style="height:10px"></div>
          <div class="label" id="labelPreview"></div>
        </div>

      </div>
    </div>
  </div>
</div>

<div class="bottomBar no-print">
  <div class="inner">
    <button class="btn warn" id="btnQuick170">üßä 170g Drucken</button>
    <button class="btn good" id="btnPrint">üñ®Ô∏è Drucken</button>
    <button class="btn warn" id="btnQuick750">üçß 750g Drucken</button>
  </div>
</div>

<!-- PRINT AREA -->
<div id="printArea">
  <div class="label" id="labelPrint"></div>
</div>

<!-- MODAL -->
<div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); backdrop-filter: blur(7px); z-index:50;">
  <div style="max-width:980px; margin:4vh auto; padding:14px;">
    <div class="card">
      <h2>Zutat bearbeiten <small>N√§hrwerte pro 100 g ¬∑ Allergene ¬∑ Zusatzstoffe</small></h2>
      <div class="body">
        <div class="row">
          <div>
            <label>Name (Etikett)</label>
            <input id="m_name" placeholder="z.B. Pistazienpaste, Amarena Variegato..." />
          </div>
          <div>
            <label>Kategorie</label>
            <select id="m_cat">
              <option>Milchprodukte</option>
              <option>Zucker/Carbs</option>
              <option>Fette</option>
              <option>Frucht</option>
              <option>N√ºsse</option>
              <option>Schokolade/Kakao</option>
              <option>Stabilisator/Emulgator</option>
              <option>Aromen/Pasten</option>
              <option>Zusatzstoffe/Farbstoffe</option>
              <option>Sonstiges</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Allergene (kommagetrennt, z.B. MILCH, SOJA, GLUTEN)</label>
            <input id="m_allergens" placeholder="MILCH, SOJA, SCHALENFR√úCHTE (PISTAZIE)" />
          </div>
          <div>
            <label>Zusatzstoffe/Hinweise (kommagetrennt)</label>
            <input id="m_additives" placeholder="mit Farbstoff, E129, mit Konservierungsstoff" />
          </div>
        </div>

        <div class="divider"></div>

        <b style="display:block; margin-bottom:8px">N√§hrwerte pro 100 g (vom Lieferanten)</b>

        <div class="row">
          <div><label>Energie (kJ)</label><input id="m_kj" type="number" min="0" step="0.1" /></div>
          <div><label>Energie (kcal)</label><input id="m_kcal" type="number" min="0" step="0.1" /></div>
        </div>
        <div class="row">
          <div><label>Fett (g)</label><input id="m_fat" type="number" min="0" step="0.01" /></div>
          <div><label>davon ges√§ttigt (g)</label><input id="m_sat" type="number" min="0" step="0.01" /></div>
        </div>
        <div class="row">
          <div><label>Kohlenhydrate (g)</label><input id="m_carb" type="number" min="0" step="0.01" /></div>
          <div><label>davon Zucker (g)</label><input id="m_sugar" type="number" min="0" step="0.01" /></div>
        </div>
        <div class="row">
          <div><label>Eiwei√ü (g)</label><input id="m_protein" type="number" min="0" step="0.01" /></div>
          <div><label>Salz (g)</label><input id="m_salt" type="number" min="0" step="0.001" /></div>
        </div>

        <div class="divider"></div>

        <div class="flex" style="justify-content:space-between">
          <button class="btn bad" id="m_delete">üóëÔ∏è L√∂schen</button>
          <div class="flex">
            <button class="btn" id="m_cancel">Abbrechen</button>
            <button class="btn good" id="m_save">Speichern</button>
          </div>
        </div>

        <div class="notice" style="margin-top:12px">
          <b>Tipp:</b> Para ‚Äúp√≥s/pastas/variegati‚Äù usa sempre os valores do r√≥tulo do balde.
          Para ‚ÄúStabilisator‚Äù podes deixar 0 (se o fornecedor n√£o d√° valores), mas para supermercado o ideal √© ter dados.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const LS_KEY = "sanremo_gelato_ql810w_v1";

  const EU14 = [
    "GLUTEN","KREBSTIERE","EI","FISCH","ERDNUSS","SOJA","MILCH","SCHALENFR√úCHTE",
    "SELLERIE","SENF","SESAM","SULFITE","LUPINE","WEICHTIERE"
  ];

  const state = {
    selectedIngId: null,
    ingredients: [],
    recipe: [], // {id,name,grams}
    flavors: {}, // name -> saved snapshot
    settings: {
      prodName: "Speiseeis",
      flavorName: "",
      netQty: "170 g",
      netQtyCustom: "",
      mhd: "",
      lot: "",
      maker: "Eiscaf√© Sanremo",
      contact: "57319 Bad Berleburg ¬∑ Tel. 0176 72809926 ¬∑ paulo.sanremo@web.de",
      storage: "Tiefgek√ºhlt bei -18¬∞C lagern. Nach dem Auftauen nicht wieder einfrieren.",
      mandatoryNote: "",
      labelPreset: "62x60",
      customH: 60,
      fontPreset: "11.2"
    }
  };

  const $ = (id)=>document.getElementById(id);
  const clamp0 = (x)=>Math.max(0, isFinite(x)? +x : 0);
  const fmt = (n,d)=> (isFinite(n)? (+n).toFixed(d) : "0");
  const uid = ()=> "ing_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);

  function save(){
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }
  function load(){
    const raw = localStorage.getItem(LS_KEY);
    if(raw){
      try{ Object.assign(state, JSON.parse(raw)); } catch {}
    }
    if(!state.ingredients?.length) seedBase();
    bindUI();
    renderAll();
  }

  function seedBase(){
    // Minimal gelato base (you can expand). Values for milk/cream/sugar are common; others can be filled from supplier.
    state.ingredients = [
      mkIng("H-Milch Vollmilch 3,5%", "Milchprodukte", ["MILCH"], [], {kj:268,kcal:64,fat:3.5,sat:2.3,carb:4.8,sugar:4.8,protein:3.4,salt:0.10}),
      mkIng("Sahne 30%", "Milchprodukte", ["MILCH"], [], {kj:1255,kcal:305,fat:30,sat:19,carb:3,sugar:3,protein:2,salt:0.08}),
      mkIng("Zucker", "Zucker/Carbs", [], [], {kj:1700,kcal:400,fat:0,sat:0,carb:100,sugar:100,protein:0,salt:0}),
      mkIng("Dextrose", "Zucker/Carbs", [], [], {kj:1570,kcal:370,fat:0,sat:0,carb:92,sugar:92,protein:0,salt:0}),
      mkIng("Glukosepulver", "Zucker/Carbs", [], [], {kj:1600,kcal:380,fat:0,sat:0,carb:95,sugar:95,protein:0,salt:0}),
      mkIng("Magermilchpulver", "Milchprodukte", ["MILCH"], [], {kj:1500,kcal:360,fat:1,sat:0.7,carb:52,sugar:52,protein:35,salt:1.2}),
      mkIng("Stabilisator/Emulgator (Mix)", "Stabilisator/Emulgator", [], ["mit Emulgator"], {kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0}),

      // Examples from your photos (rename if you want)
      mkIng("Produkt A (Paste/Variegato)", "Aromen/Pasten", [], [], {kj:1250,kcal:299,fat:7,sat:2.8,carb:54.2,sugar:40.8,protein:4.8,salt:1.1}),
      mkIng("Produkt C (Veganok Paste)", "Aromen/Pasten", [], [], {kj:1023,kcal:241,fat:0,sat:0,carb:60,sugar:53,protein:0,salt:0}),
      mkIng("Base in polvere (20kg Sack)", "Sonstiges", ["MILCH"], ["mit Emulgator (E471/E477/E472b/E473)"], {kj:1933,kcal:476,fat:22,sat:16,carb:57,sugar:40,protein:11,salt:1.1}),
    ];
    state.selectedIngId = state.ingredients[0]?.id || null;
    save();
  }

  function mkIng(name, cat, allergens=[], additives=[], nutri){
    return { id: uid(), name, cat, allergens, additives, nutri: nutri || {kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0} };
  }

  function bindUI(){
    // Backup / import / reset
    $("btnBackup").onclick = () => {
      const blob = new Blob([JSON.stringify({meta:{tool:"SanremoGelatoQL",v:"1"},state}, null, 2)], {type:"application/json"});
      download(blob, `sanremo_gelato_backup_${stamp()}.json`);
    };
    $("fileImport").onchange = async (e) => {
      const f = e.target.files?.[0]; if(!f) return;
      try{
        const txt = await f.text();
        const data = JSON.parse(txt);
        const st = data.state || data;
        if(!st.ingredients || !st.settings) throw new Error("Ung√ºltige Datei");
        Object.assign(state, st);
        save(); renderAll();
        alert("Import OK");
      }catch(err){ alert("Import Fehler: " + err.message); }
      e.target.value = "";
    };
    $("btnReset").onclick = () => {
      if(!confirm("Alles zur√ºcksetzen?")) return;
      localStorage.removeItem(LS_KEY);
      location.reload();
    };

    // Filters
    $("q").oninput = renderIngList;
    $("catFilter").onchange = renderIngList;

    // Ingredient actions
    $("btnNewIng").onclick = () => openModal(null);
    $("btnGelatoPack").onclick = () => {
      const added = addGelatoPack();
      alert(`Basis-Pack erg√§nzt: ${added} Zutaten.`);
      save(); renderIngList();
    };

    // Recipe actions
    $("btnAddLine").onclick = () => {
      const id = state.selectedIngId;
      const ing = state.ingredients.find(x=>x.id===id);
      if(!ing) return alert("Bitte links eine Zutat ausw√§hlen.");
      state.recipe.push({id: ing.id, name: ing.name, grams: 0});
      save(); renderRecipe(); recalc(); renderLabel();
    };
    $("btnSort").onclick = () => {
      state.recipe.sort((a,b)=>clamp0(b.grams)-clamp0(a.grams));
      save(); renderRecipe(); recalc(); renderLabel();
    };
    $("btnClearRecipe").onclick = () => {
      if(!confirm("Rezept leeren?")) return;
      state.recipe = [];
      save(); renderRecipe(); recalc(); renderLabel();
    };

    // Settings bindings
    bind("prodName","prodName");
    bind("flavorName","flavorName");
    bindSelect("netQty","netQty", () => {
      const v = $("netQty").value;
      $("netQtyCustom").disabled = (v !== "custom");
      if(v !== "custom") state.settings.netQtyCustom = "";
      renderLabel();
    });
    bind("netQtyCustom","netQtyCustom", renderLabel);
    bind("mhd","mhd", renderLabel);
    bind("lot","lot", renderLabel);
    bind("maker","maker", renderLabel);
    bind("contact","contact", renderLabel);
    bind("storage","storage", renderLabel);
    bind("mandatoryNote","mandatoryNote", renderLabel);

    $("labelPreset").onchange = () => {
      state.settings.labelPreset = $("labelPreset").value;
      $("customH").disabled = (state.settings.labelPreset !== "custom");
      applyLabelSize();
      save(); renderLabel();
    };
    $("customH").oninput = () => {
      state.settings.customH = clamp0(+$("customH").value);
      applyLabelSize();
      save(); renderLabel();
    };
    $("fontPreset").onchange = () => {
      state.settings.fontPreset = $("fontPreset").value;
      document.documentElement.style.setProperty("--labelFont", state.settings.fontPreset + "px");
      save(); renderLabel();
    };

    // Flavors (save/load)
    $("btnNewFlavor").onclick = () => {
      if(!confirm("Neuen Geschmack erstellen (aktuelles Rezept bleibt bis du speicherst)?")) return;
      $("flavorName").focus();
    };
    $("btnSaveFlavor").onclick = saveFlavor;
    $("btnDeleteFlavor").onclick = deleteFlavor;
    $("flavorSelect").onchange = () => loadFlavor($("flavorSelect").value);

    // Quick print buttons
    $("btnQuick170").onclick = () => { setPreset("62x37"); $("netQty").value="170 g"; state.settings.netQty="170 g"; $("netQtyCustom").disabled=true; save(); renderLabel(); doPrint(); };
    $("btnQuick750").onclick = () => { setPreset("62x60"); $("netQty").value="750 g"; state.settings.netQty="750 g"; $("netQtyCustom").disabled=true; save(); renderLabel(); doPrint(); };
    $("btnPrint").onclick = () => doPrint();

    // Modal
    $("m_cancel").onclick = closeModal;
    $("m_save").onclick = saveModal;
    $("m_delete").onclick = deleteModal;
  }

  function bind(id, key, onChange){
    const el = $(id);
    el.value = state.settings[key] ?? "";
    el.oninput = () => { state.settings[key] = el.value; save(); onChange && onChange(); };
  }
  function bindSelect(id, key, onChange){
    const el = $(id);
    el.value = state.settings[key] ?? el.value;
    el.onchange = () => { state.settings[key] = el.value; save(); onChange && onChange(); };
  }

  function setPreset(v){
    $("labelPreset").value = v;
    state.settings.labelPreset = v;
    $("customH").disabled = (v !== "custom");
    applyLabelSize();
  }

  function applyLabelSize(){
    const w = 62; // fixed for DK-22205
    let h = 60;
    const p = state.settings.labelPreset;
    if(p === "62x37") h = 37;
    if(p === "62x60") h = 60;
    if(p === "62x100") h = 100;
    if(p === "custom") h = clamp0(state.settings.customH || 60) || 60;

    document.documentElement.style.setProperty("--labelWmm", w);
    document.documentElement.style.setProperty("--labelHmm", h);

    // update @page size for print
    $("pageSizeStyle").textContent = `@page { size: ${w}mm ${h}mm; margin: 0; }`;
    $("wInfo").textContent = w + "mm";
  }

  function renderAll(){
    // settings -> inputs
    $("prodName").value = state.settings.prodName || "Speiseeis";
    $("flavorName").value = state.settings.flavorName || "";
    $("netQty").value = state.settings.netQty || "170 g";
    $("netQtyCustom").value = state.settings.netQtyCustom || "";
    $("netQtyCustom").disabled = ($("netQty").value !== "custom");
    $("mhd").value = state.settings.mhd || "";
    $("lot").value = state.settings.lot || "";
    $("maker").value = state.settings.maker || "";
    $("contact").value = state.settings.contact || "";
    $("storage").value = state.settings.storage || "";
    $("mandatoryNote").value = state.settings.mandatoryNote || "";
    $("labelPreset").value = state.settings.labelPreset || "62x60";
    $("customH").value = state.settings.customH || 60;
    $("customH").disabled = ($("labelPreset").value !== "custom");
    $("fontPreset").value = state.settings.fontPreset || "11.2";
    document.documentElement.style.setProperty("--labelFont", (state.settings.fontPreset || "11.2") + "px");

    applyLabelSize();
    renderFlavorSelect();
    renderIngList();
    renderRecipe();
    recalc();
    renderLabel();
  }

  function renderFlavorSelect(){
    const sel = $("flavorSelect");
    const names = Object.keys(state.flavors || {}).sort((a,b)=>a.localeCompare(b,"de"));
    sel.innerHTML = `<option value="">(‚Äî ausw√§hlen ‚Äî)</option>` + names.map(n=>`<option value="${escAttr(n)}">${esc(n)}</option>`).join("");
  }

  function saveFlavor(){
    const name = ($("flavorName").value || "").trim();
    if(!name) return alert("Bitte Geschmack/Sorte eingeben.");
    // snapshot
    state.flavors[name] = {
      at: new Date().toISOString(),
      settings: {
        prodName: $("prodName").value,
        flavorName: name
      },
      recipe: state.recipe.slice()
    };
    $("status").textContent = "gespeichert";
    save();
    renderFlavorSelect();
    $("flavorSelect").value = name;
    renderLabel();
  }

  function loadFlavor(name){
    if(!name) return;
    const snap = state.flavors?.[name];
    if(!snap) return;
    // apply
    state.settings.flavorName = name;
    $("flavorName").value = name;
    if(snap.settings?.prodName){
      state.settings.prodName = snap.settings.prodName;
      $("prodName").value = snap.settings.prodName;
    }
    state.recipe = (snap.recipe || []).map(r=>({id:r.id,name:r.name,grams:clamp0(r.grams)}));
    save();
    renderRecipe(); recalc(); renderLabel();
    $("status").textContent = "geladen";
  }

  function deleteFlavor(){
    const name = $("flavorSelect").value;
    if(!name) return alert("Kein Geschmack ausgew√§hlt.");
    if(!confirm(`"${name}" l√∂schen?`)) return;
    delete state.flavors[name];
    save();
    renderFlavorSelect();
    $("flavorSelect").value = "";
    $("status").textContent = "gel√∂scht";
  }

  function renderIngList(){
    const q = ($("q").value || "").trim().toLowerCase();
    const cat = $("catFilter").value;
    const list = $("ingList");
    list.innerHTML = "";

    const filtered = (state.ingredients||[])
      .filter(i => !cat || i.cat === cat)
      .filter(i => !q || (i.name||"").toLowerCase().includes(q));

    $("ingCount").textContent = `${filtered.length} / ${(state.ingredients||[]).length}`;

    filtered.forEach(i=>{
      const div = document.createElement("div");
      div.className = "item";
      div.style.outline = (state.selectedIngId === i.id) ? "2px solid rgba(124,58,237,.55)" : "none";
      div.innerHTML = `
        <div class="top">
          <div style="min-width:0">
            <b>${esc(i.name)}</b>
            <div class="meta">${esc(i.cat)} ¬∑ ${i.allergens?.length ? "Allergene: " + esc(i.allergens.join(", ")) : "keine Allergene"}</div>
            <div>
              ${(i.allergens||[]).slice(0,3).map(a=>`<span class="pill">‚ö†Ô∏è ${esc(a)}</span>`).join("")}
              ${(i.additives||[]).slice(0,2).map(a=>`<span class="pill">üß™ ${esc(a)}</span>`).join("")}
            </div>
          </div>
          <div class="flex" style="justify-content:flex-end">
            <button class="btn" data-sel="${i.id}">W√§hlen</button>
            <button class="btn primary" data-edit="${i.id}">‚úèÔ∏è</button>
          </div>
        </div>
      `;
      div.querySelector("[data-sel]").onclick = () => {
        state.selectedIngId = i.id;
        save();
        renderIngList();
      };
      div.querySelector("[data-edit]").onclick = () => openModal(i.id);
      list.appendChild(div);
    });
  }

  function renderRecipe(){
    const tb = $("recipeTable").querySelector("tbody");
    tb.innerHTML = "";
    state.recipe.forEach((r, idx)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><b>${esc(r.name)}</b></td>
        <td><input type="number" min="0" step="1" value="${clamp0(r.grams)}" data-g="${idx}" /></td>
        <td class="right"><button class="btn bad" data-del="${idx}">Entfernen</button></td>
      `;
      tr.querySelector("[data-g]").oninput = (e) => {
        state.recipe[idx].grams = clamp0(+e.target.value);
        save(); recalc(); renderLabel();
      };
      tr.querySelector("[data-del]").onclick = () => {
        state.recipe.splice(idx,1);
        save(); renderRecipe(); recalc(); renderLabel();
      };
      tb.appendChild(tr);
    });
  }

  function recalc(){
    const total = state.recipe.reduce((s,r)=>s+clamp0(r.grams),0);

    const sum = {kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0};
    const allergens = new Set();
    const additives = new Set();
    const missing = [];

    state.recipe.forEach(r=>{
      const g = clamp0(r.grams);
      if(g<=0) return;
      const ing = state.ingredients.find(x=>x.id===r.id);
      if(!ing) return;
      (ing.allergens||[]).forEach(a=>allergens.add(normAll(a)));
      (ing.additives||[]).forEach(a=>additives.add(a.trim()));

      const n = ing.nutri || {};
      const isZeroEnergy = (+n.kj===0 && +n.kcal===0);
      const mightNeed = (ing.cat !== "Stabilisator/Emulgator");
      if(isZeroEnergy && mightNeed) missing.push(ing.name);

      for(const k in sum){
        sum[k] += (clamp0(n[k]) * g / 100);
      }
    });

    const per100 = {};
    for(const k in sum){
      per100[k] = total>0 ? (sum[k]/total*100) : 0;
    }

    // Zutatenliste
    const sorted = state.recipe.filter(r=>clamp0(r.grams)>0).slice().sort((a,b)=>clamp0(b.grams)-clamp0(a.grams));
    const ingTextHTML = sorted.map(r=>{
      const ing = state.ingredients.find(x=>x.id===r.id);
      return markAllergens(ing?.name || r.name, [...allergens]);
    }).join(", ");

    $("ingredientsOut").value = stripHtml(ingTextHTML);
    $("allergensOut").value =
      (allergens.size ? ("Allergene: " + [...allergens].join(", ")) : "Allergene: ‚Äì") +
      (additives.size ? ("\nHinweise: " + [...additives].join(", ")) : "");

    state._computed = { total, per100, allergens:[...allergens], additives:[...additives], ingredientsHTML: ingTextHTML, missing };
  }

  function renderLabel(){
    recalc();
    const s = state.settings;
    const c = state._computed || {per100:{}, allergens:[], additives:[], missing:[]};

    // Supersafe: block printing if missing nutrients for supermarket ingredients
    const warnMissing = c.missing?.length ? `‚ö†Ô∏è N√§hrwerte fehlen bei: ${c.missing.slice(0,6).join(", ")}${c.missing.length>6?"‚Ä¶":""}` : "";

    $("status").textContent = warnMissing ? "pr√ºfen" : "bereit";

    const net = (s.netQty === "custom" ? (s.netQtyCustom || "") : s.netQty);
    const title = `${(s.prodName||"").trim()}${(s.flavorName||"").trim() ? " ‚Äì " + (s.flavorName||"").trim() : ""}`.trim();

    const n = c.per100 || {};
    const nutriRows = [
      ["Energie", `${fmt(n.kj,0)} kJ / ${fmt(n.kcal,0)} kcal`],
      ["Fett", `${fmt(n.fat,1)} g`],
      ["davon ges√§ttigt", `${fmt(n.sat,1)} g`],
      ["Kohlenhydrate", `${fmt(n.carb,1)} g`],
      ["davon Zucker", `${fmt(n.sugar,1)} g`],
      ["Eiwei√ü", `${fmt(n.protein,1)} g`],
      ["Salz", `${fmt(n.salt,2)} g`],
    ];

    const additivesLine = c.additives?.length ? esc(c.additives.join(", ")) : "";
    const allergensLine = c.allergens?.length ? esc(c.allergens.join(", ")) : "";

    const html = `
      <div class="lh">
        <div>
          <b>${esc(s.maker||"")}</b><br>
          <small>${esc(s.contact||"")}</small>
        </div>
        <div style="text-align:right">
          <small>${esc(s.lot||"")}</small><br>
          <small><b>${esc(net||"")}</b></small>
        </div>
      </div>

      <div class="titleLine">${esc(title || "Produkt")}</div>

      <div class="cap">Zutaten:</div>
      <p class="p">${c.ingredientsHTML || "<span class='small'>(kein Rezept)</span>"}</p>

      ${additivesLine ? `<div class="cap">Hinweise:</div><p class="p">${additivesLine}</p>` : ""}

      ${allergensLine ? `<div class="cap">Allergene:</div><p class="p">${allergensLine}</p>` : ""}

      <div class="cap">N√§hrwerte je 100 g:</div>
      <div class="nutri">
        <table>
          <tbody>
            ${nutriRows.map(r=>`<tr><th>${esc(r[0])}</th><td class="right"><b>${esc(r[1])}</b></td></tr>`).join("")}
          </tbody>
        </table>
      </div>

      <div class="cap">Aufbewahrung:</div>
      <p class="p">${esc(s.storage||"")}</p>

      <div class="foot">
        <div>
          ${s.mhd ? `<div><b>MHD:</b> ${esc(s.mhd)}</div>` : ""}
          ${s.mandatoryNote ? `<div><b>Hinweis:</b> ${esc(s.mandatoryNote)}</div>` : ""}
        </div>
        <div style="text-align:right">
          ${warnMissing ? `<div style="color:#b45309"><b>${esc(warnMissing)}</b></div>` : `<div class="small">LMIV-Ausgabe (intern)</div>`}
        </div>
      </div>
    `;

    $("labelPreview").innerHTML = html;
    $("labelPrint").innerHTML = html;
  }

  function doPrint(){
    recalc();
    const c = state._computed || {};
    // Strong safety: if any ingredient with grams>0 missing energy (kJ/kcal) and not stabilizer, block print
    if(c.missing?.length){
      alert("Para supermercado: faltam N√§hrwerte em algumas Zutaten. Abre a Zutat (‚úèÔ∏è) e mete os valores do r√≥tulo do fornecedor.\n\nFaltam: " + c.missing.slice(0,10).join(", "));
      return;
    }
    // Ensure label style is updated
    applyLabelSize();
    renderLabel();
    window.print();
  }

  function addGelatoPack(){
    const pack = [
      tpl("Inulin", "Zucker/Carbs", []),
      tpl("Johannisbrotkernmehl", "Stabilisator/Emulgator", []),
      tpl("Guarkernmehl", "Stabilisator/Emulgator", []),
      tpl("Pistazienpaste", "Aromen/Pasten", ["SCHALENFR√úCHTE (PISTAZIE)"]),
      tpl("Haselnusspaste", "Aromen/Pasten", ["SCHALENFR√úCHTE (HASELNUSS)"]),
      tpl("Amarena Variegato", "Aromen/Pasten", []),
      tpl("Karamell Variegato", "Aromen/Pasten", []),
      tpl("Schoko Variegato", "Aromen/Pasten", ["SOJA"]),
      tpl("Cookies St√ºckchen", "Sonstiges", ["GLUTEN (WEIZEN)","MILCH","SOJA"]),
      tpl("Wei√üe Schokolade St√ºckchen", "Schokolade/Kakao", ["MILCH","SOJA"]),
      tpl("Kakaopulver", "Schokolade/Kakao", []),
      tpl("Vanillepaste", "Aromen/Pasten", []),
      tpl("Erdbeer-Paste/Variegato", "Aromen/Pasten", []),
      tpl("Mango-Paste/Variegato", "Aromen/Pasten", []),
      tpl("Zitronenpaste", "Aromen/Pasten", []),
    ];
    return addPack(pack);
  }
  function tpl(name, cat, allergens=[]){
    return { id: uid(), name, cat, allergens, additives:[], nutri:{kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0} };
  }
  function addPack(list){
    let added = 0;
    const existing = new Set(state.ingredients.map(i=>(i.name||"").trim().toLowerCase()));
    list.forEach(x=>{
      const k=(x.name||"").trim().toLowerCase();
      if(!k || existing.has(k)) return;
      state.ingredients.push(x);
      existing.add(k); added++;
    });
    save();
    return added;
  }

  // Modal logic
  let modalId = null;
  function openModal(id){
    modalId = id;
    const ing = id ? state.ingredients.find(x=>x.id===id) : mkIng("", "Sonstiges", [], [], null);

    $("m_name").value = ing?.name || "";
    $("m_cat").value = ing?.cat || "Sonstiges";
    $("m_allergens").value = (ing?.allergens||[]).join(", ");
    $("m_additives").value = (ing?.additives||[]).join(", ");

    const n = ing?.nutri || {};
    $("m_kj").value = n.kj ?? 0;
    $("m_kcal").value = n.kcal ?? 0;
    $("m_fat").value = n.fat ?? 0;
    $("m_sat").value = n.sat ?? 0;
    $("m_carb").value = n.carb ?? 0;
    $("m_sugar").value = n.sugar ?? 0;
    $("m_protein").value = n.protein ?? 0;
    $("m_salt").value = n.salt ?? 0;

    $("m_delete").style.display = id ? "" : "none";
    $("modal").style.display = "";
  }
  function closeModal(){ $("modal").style.display = "none"; }

  function saveModal(){
    const name = ($("m_name").value||"").trim();
    if(!name) return alert("Bitte Name eingeben.");
    const ingData = {
      id: modalId || uid(),
      name,
      cat: $("m_cat").value,
      allergens: parseCsv($("m_allergens").value),
      additives: parseCsv($("m_additives").value),
      nutri: {
        kj: clamp0(+$("m_kj").value),
        kcal: clamp0(+$("m_kcal").value),
        fat: clamp0(+$("m_fat").value),
        sat: clamp0(+$("m_sat").value),
        carb: clamp0(+$("m_carb").value),
        sugar: clamp0(+$("m_sugar").value),
        protein: clamp0(+$("m_protein").value),
        salt: clamp0(+$("m_salt").value),
      }
    };

    if(modalId){
      const idx = state.ingredients.findIndex(x=>x.id===modalId);
      if(idx>=0) state.ingredients[idx] = ingData;
    } else {
      state.ingredients.unshift(ingData);
      state.selectedIngId = ingData.id;
    }

    // sync recipe names
    state.recipe.forEach(r=>{ if(r.id===ingData.id) r.name = ingData.name; });

    save();
    closeModal();
    renderIngList(); renderRecipe(); recalc(); renderLabel();
  }

  function deleteModal(){
    if(!modalId) return;
    if(!confirm("Zutat l√∂schen?")) return;
    state.ingredients = state.ingredients.filter(x=>x.id!==modalId);
    state.recipe = state.recipe.filter(r=>r.id!==modalId);
    if(state.selectedIngId===modalId) state.selectedIngId = state.ingredients[0]?.id || null;
    modalId = null;
    save(); closeModal();
    renderAll();
  }

  function parseCsv(s){
    return (s||"").split(",").map(x=>x.trim()).filter(Boolean);
  }

  // Helpers
  function esc(s){
    return (s??"").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function escAttr(s){ return esc(s).replaceAll("\n"," "); }

  function normAll(a){
    const x = (a||"").trim();
    if(!x) return "";
    return x.toUpperCase();
  }

  function markAllergens(text, allergensUpper){
    let html = esc(text);
    (allergensUpper||[]).forEach(al=>{
      if(!al) return;
      const safe = al.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      const re = new RegExp(safe, "gi");
      html = html.replace(re, (m)=>`<span class="allergen">${esc(m)}</span>`);
    });
    return html;
  }

  function stripHtml(html){
    const d = document.createElement("div");
    d.innerHTML = html;
    return d.textContent || "";
  }

  function download(blob, filename){
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 300);
  }
  function stamp(){
    const d = new Date();
    const p = n=>String(n).padStart(2,"0");
    return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}`;
  }

  // Init
  load();
})();
</script>
</body>
</html>

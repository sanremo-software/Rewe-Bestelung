<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Sanremo – LMIV Etiketten (QL-810W)</title>
  <style>
    :root{
      --bg:#0b1020; --card:#111a33; --line:#22305c;
      --txt:#e9eefc; --mut:#b7c2ea; --acc:#4dd4ff; --ok:#33d17a; --warn:#ffcc66; --bad:#ff6b6b;
      --shadow: 0 16px 40px rgba(0,0,0,.35);
      --r:18px; --pad:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--sans);
      background: radial-gradient(1200px 600px at 10% -10%, rgba(77,212,255,.22), transparent 50%),
                  radial-gradient(900px 500px at 90% 0%, rgba(51,209,122,.20), transparent 55%),
                  linear-gradient(180deg, #060a16 0%, #0b1020 60%, #070b15 100%);
      color:var(--txt);
    }
    .wrap{max-width:1200px; margin:0 auto; padding:18px 14px 80px}
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      position:sticky; top:0; z-index:20; padding:14px 0 10px;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(7,10,20,.92) 0%, rgba(7,10,20,.65) 70%, transparent 100%);
    }
    .brand{display:flex; gap:12px; align-items:center}
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: conic-gradient(from 200deg, #33d17a, #4dd4ff, #9b7bff, #33d17a);
      box-shadow: var(--shadow);
    }
    .title h1{margin:0; font-size:16px; letter-spacing:.2px}
    .title .sub{margin:2px 0 0; color:var(--mut); font-size:12px}
    .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    button{
      border:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      color:var(--txt); padding:10px 12px; border-radius:14px;
      cursor:pointer; box-shadow: 0 10px 22px rgba(0,0,0,.22);
      font-weight:650; font-size:13px;
    }
    button:hover{border-color: rgba(77,212,255,.35)}
    .btnPrimary{background: linear-gradient(180deg, rgba(77,212,255,.26), rgba(77,212,255,.12)); border-color: rgba(77,212,255,.35);}
    .btnOk{background: linear-gradient(180deg, rgba(51,209,122,.26), rgba(51,209,122,.12)); border-color: rgba(51,209,122,.35);}
    .btnBad{background: linear-gradient(180deg, rgba(255,107,107,.26), rgba(255,107,107,.12)); border-color: rgba(255,107,107,.35);}

    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 14px;}
    .tab{
      padding:10px 12px; border-radius:999px; cursor:pointer; user-select:none;
      border:1px solid rgba(255,255,255,.10);
      color:var(--mut);
      background: rgba(255,255,255,.04);
      font-weight:700; font-size:13px;
    }
    .tab.active{color:var(--txt); border-color: rgba(77,212,255,.45); background: rgba(77,212,255,.12);}

    .grid{display:grid; gap:14px; grid-template-columns: 1.05fr .95fr; align-items:start;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} .actions{justify-content:flex-start} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      padding: var(--pad);
      box-shadow: var(--shadow);
    }
    .card h2{margin:0 0 10px; font-size:14px}
    .mut{color:var(--mut)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row > *{flex:1}
    label{display:block; font-size:12px; color:var(--mut); margin:0 0 6px}
    input, select, textarea{
      width:100%; padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,14,26,.65);
      color:var(--txt);
      outline:none;
    }
    textarea{min-height:90px; resize:vertical}
    input:focus, select:focus, textarea:focus{border-color: rgba(77,212,255,.5)}
    .hr{height:1px; background: rgba(255,255,255,.08); margin:12px 0}
    .hint{
      padding:10px 12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color:var(--mut);
      font-size:12px;
    }
    .list{
      display:flex; flex-direction:column; gap:10px;
      max-height: 520px; overflow:auto; padding-right:4px;
    }
    .item{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius:16px;
      padding:10px;
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
    }
    .item .meta{flex:1; min-width:0}
    .item .meta .name{font-weight:850; font-size:13px}
    .item .meta .small{font-size:12px; color:var(--mut); margin-top:2px}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      font-size:11px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color:var(--mut);
      margin:6px 6px 0 0;
      white-space:nowrap;
    }
    .pill.ok{border-color: rgba(51,209,122,.35); color:#b9f7d8; background: rgba(51,209,122,.10)}
    .pill.warn{border-color: rgba(255,204,102,.35); color:#ffe7b8; background: rgba(255,204,102,.10)}
    .pill.bad{border-color: rgba(255,107,107,.35); color:#ffd2d2; background: rgba(255,107,107,.10)}
    .miniBtns{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .miniBtns button{padding:8px 10px; font-size:12px; border-radius:12px; box-shadow:none}

    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-size:12px;
      text-align:left;
      vertical-align:top;
    }
    .table th{color:var(--mut); font-weight:800; background: rgba(255,255,255,.03)}
    .table tr:last-child td{border-bottom:none}
    .mono{font-family:var(--mono)}

    .labelCard{position:sticky; top:92px;}
    @media (max-width:980px){ .labelCard{position:relative; top:auto} }

    /* ===== Label preview (IMPORTANT FIXES) =====
       - Body reserves space for barcode strip
       - Barcode never overlaps nutrition
       - No bottom cut (we use strict body area + strip area) */
    .labelWrap{
      display:flex; justify-content:center; align-items:center;
      padding:10px; border-radius:16px;
      background: rgba(0,0,0,.25);
      border:1px dashed rgba(255,255,255,.16);
      overflow:auto;
    }
    .label{
      background:#fff; color:#000;
      border-radius:10px;
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
      overflow:hidden;
      position:relative;
      font-family: Arial, Helvetica, sans-serif;
    }
    .labelBody{position:absolute; left:0; top:0; right:0; overflow:hidden;}
    .labelBodyContent{padding:10px 10px 10px;}
    .labelStrip{
      position:absolute; left:0; right:0; bottom:0;
      background:#fff;
      border-top:1px solid #000;
      display:flex; align-items:center; gap:10px;
      padding:6px 8px;
    }
    .lTitle{font-weight:900; letter-spacing:.2px}
    .lSub{margin-top:2px}
    .lSmall{margin-top:6px; line-height:1.22}
    .lGrid{display:grid; gap:8px; margin-top:8px;}
    .label table{width:100%; border-collapse:collapse;}
    .label td, .label th{border:1px solid #000; padding:3px 4px;}
    .label th{text-align:left}
    .lFooter{margin-top:6px; line-height:1.18}
    .lWarn{margin-top:6px; font-weight:800}
    .lQR{
      position:absolute; right:8px; top:8px;
      background:#fff; border:1px solid #000;
      display:flex; align-items:center; justify-content:center; overflow:hidden;
    }
    .barcodeText{font-size:11px; letter-spacing:1px; font-family: var(--mono);}
    .toast{
      position:fixed; left:50%; bottom:14px; transform:translateX(-50%);
      background: rgba(17,26,51,.92);
      border:1px solid rgba(255,255,255,.12);
      color:var(--txt); padding:10px 12px;
      border-radius:14px; box-shadow: var(--shadow);
      font-size:13px; display:none; z-index:999;
      max-width: min(720px, 92vw);
    }
    .hidden{display:none !important;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">
          <h1>Sanremo – LMIV Etiketten</h1>
          <div class="sub">Mobile/Tablet • Brother QL-810W • DK11208 (38×90) / DK11202 (62×100)</div>
        </div>
      </div>
      <div class="actions">
        <button class="btnPrimary" id="btnExport">Backup exportieren</button>
        <button class="btnPrimary" id="btnImport">Backup importieren</button>
        <input id="fileImport" type="file" accept="application/json" class="hidden" />
        <button class="btnOk" id="btnPrint">Etikett drucken</button>
      </div>
    </div>

    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="ingredients">Zutaten / Produkte</div>
      <div class="tab" data-tab="recipes">Rezept / Etikett</div>
      <div class="tab" data-tab="settings">Betrieb / Standardtexte</div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div id="leftCol">
        <!-- INGREDIENTS -->
        <div class="card" id="tab-ingredients">
          <h2>Zutaten-Bibliothek</h2>

          <div class="row">
            <div>
              <label>Suche</label>
              <input id="ingSearch" placeholder="Milch, Base Soave, Supergelmix, Erdbeere, Lemon Più..." />
            </div>
            <div>
              <label>Kategorie</label>
              <select id="ingFilterCat"></select>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div>
              <label>Name</label>
              <input id="ingName" placeholder="z.B. Supergelmix (Fruchteis)" />
            </div>
            <div>
              <label>Kategorie</label>
              <select id="ingCat"></select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Allergene (GROSS, Komma)</label>
              <input id="ingAll" placeholder="z.B. MILCH, SOJA, SCHALENFRÜCHTE" />
            </div>
            <div>
              <label>Zusatzstoffe / E-Nummern (Komma)</label>
              <input id="ingAdd" placeholder="z.B. E471, E477, E466..." />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Zutatenliste (für dieses Produkt – DE)</label>
              <textarea id="ingText" placeholder="Genau wie auf dem Sack/Etikett (Deutsch)."></textarea>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Hinweis (optional)</label>
              <input id="ingNote" placeholder="z.B. Kann Aktivität und Aufmerksamkeit bei Kindern beeinträchtigen." />
            </div>
          </div>

          <div class="hr"></div>

          <h2>Nährwerte pro 100 g (Lieferant)</h2>
          <div class="row">
            <div><label>Energie (kJ)</label><input id="n_kj" type="number" step="0.1" value="0"></div>
            <div><label>Energie (kcal)</label><input id="n_kcal" type="number" step="0.1" value="0"></div>
          </div>
          <div class="row">
            <div><label>Fett (g)</label><input id="n_fat" type="number" step="0.1" value="0"></div>
            <div><label>davon gesättigt (g)</label><input id="n_sat" type="number" step="0.1" value="0"></div>
          </div>
          <div class="row">
            <div><label>Kohlenhydrate (g)</label><input id="n_carb" type="number" step="0.1" value="0"></div>
            <div><label>davon Zucker (g)</label><input id="n_sugar" type="number" step="0.1" value="0"></div>
          </div>
          <div class="row">
            <div><label>Eiweiß (g)</label><input id="n_protein" type="number" step="0.1" value="0"></div>
            <div><label>Salz (g)</label><input id="n_salt" type="number" step="0.01" value="0"></div>
          </div>
          <div class="row">
            <div><label>Ballaststoffe (g) optional</label><input id="n_fiber" type="number" step="0.1" value="0"></div>
            <div style="display:flex; gap:8px; align-items:flex-end; justify-content:flex-end">
              <button class="btnOk" id="btnSaveIng">Speichern</button>
              <button class="btnBad" id="btnResetIng">Neu</button>
            </div>
          </div>

          <div class="hr"></div>
          <div class="hint">
            <b>Wichtig:</b> Trage für Base Soave (Milch) und Supergelmix/Lemon Più (Frucht) die Lieferantenwerte ein.
            Allergene/Zusatzstoffe werden automatisch in der Etikette gesammelt.
          </div>

          <div class="hr"></div>
          <h2>Liste</h2>
          <div class="list" id="ingList"></div>
        </div>

        <!-- RECIPES -->
        <div class="card hidden" id="tab-recipes">
          <h2>Rezept + Etikett</h2>

          <div class="row">
            <div>
              <label>Sorte / Rezeptname</label>
              <input id="r_name" placeholder="z.B. Kinder Bueno, Erdbeere, Pistazie..." />
            </div>
            <div>
              <label>Produktart</label>
              <select id="r_type">
                <option value="speiseeis">Speiseeis (Milch)</option>
                <option value="fruchteis">Fruchteis (Wasser)</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Nettofüllmenge</label>
              <select id="r_netto">
                <option value="170">170 g</option>
                <option value="750">750 g</option>
                <option value="1000">1000 g</option>
                <option value="custom">Eigen...</option>
              </select>
            </div>
            <div>
              <label>Etikettgröße</label>
              <select id="labelSize">
                <option value="38x90">DK11208 – 38×90 mm</option>
                <option value="62x100">DK11202 – 62×100 mm</option>
              </select>
            </div>
          </div>

          <div class="row" id="customNetRow" style="display:none;">
            <div>
              <label>Eigen Netto (Text)</label>
              <input id="r_netto_custom" placeholder="z.B. 500 g / 0,5 kg / 240 ml" />
            </div>
            <div></div>
          </div>

          <div class="row">
            <div>
              <label>Charge / Lot</label>
              <input id="r_lot" placeholder="z.B. L2513681" />
            </div>
            <div>
              <label>MHD</label>
              <input id="r_mhd" type="date" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>QR Link (optional)</label>
              <input id="r_qr" placeholder="https://..." />
            </div>
            <div>
              <label>Barcode anzeigen</label>
              <select id="r_showBarcode">
                <option value="yes">Ja</option>
                <option value="no">Nein</option>
              </select>
            </div>
          </div>

          <div class="hr"></div>

          <h2>Zutaten ins Rezept</h2>
          <div class="row">
            <div>
              <label>Zutat wählen</label>
              <select id="r_pick"></select>
            </div>
            <div>
              <label>Menge</label>
              <input id="r_qty" type="number" step="0.1" value="100" />
            </div>
            <div>
              <label>Einheit</label>
              <select id="r_unit">
                <option value="g">g</option>
                <option value="ml">ml</option>
              </select>
            </div>
            <div style="flex:0">
              <label>&nbsp;</label>
              <button class="btnOk" id="btnAddToRecipe">Hinzufügen</button>
            </div>
          </div>

          <div class="hr"></div>

          <h2>Rezeptliste</h2>
          <table class="table" id="recipeTable">
            <thead>
              <tr>
                <th style="width:42%">Zutat</th>
                <th style="width:14%">Menge</th>
                <th style="width:10%">Einheit</th>
                <th style="width:26%">Hinweise</th>
                <th style="width:8%"></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <div class="hr"></div>

          <div class="hint">
            <b>Deine Regel:</b> Base Soave = Milch (Speiseeis) · Supergelmix/Lemon Più = Frucht (Fruchteis).<br>
            <b>EAN:</b> 170 g → <span class="mono">4170000057765</span> · 750 g → <span class="mono">4170000057949</span> (optional).
          </div>

          <div class="hr"></div>

          <div class="row">
            <button class="btnOk" id="btnSaveRecipe">Rezept speichern</button>
            <button class="btnBad" id="btnNewRecipe">Neues Rezept</button>
            <button class="btnPrimary" id="btnLoadRecipe">Rezept laden</button>
            <select id="recipePicker"></select>
          </div>
        </div>

        <!-- SETTINGS -->
        <div class="card hidden" id="tab-settings">
          <h2>Betrieb / Standardtexte (LMIV)</h2>

          <div class="row">
            <div>
              <label>Verkehrsbezeichnung (Speiseeis)</label>
              <input id="s_vbz" placeholder="Speiseeis" />
            </div>
            <div>
              <label>Verkehrsbezeichnung (Fruchteis)</label>
              <input id="s_vbz_frucht" placeholder="Fruchteis" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Aufbewahrung</label>
              <input id="s_storage" placeholder="Tiefgekühlt bei -18°C lagern." />
            </div>
            <div>
              <label>Fußzeile</label>
              <input id="s_footer" placeholder="Nach dem Auftauen nicht wieder einfrieren." />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Kann Spuren enthalten (Text)</label>
              <input id="s_traces" placeholder="Soja, Ei, Mandeln, Haselnüsse, Walnüsse, Pistazien" />
            </div>
            <div>
              <label>Spuren-Hinweis anzeigen</label>
              <select id="s_showTraces">
                <option value="yes">Ja</option>
                <option value="no">Nein</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Firma</label>
              <input id="s_company" />
            </div>
            <div>
              <label>Adresse</label>
              <input id="s_addr" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Telefon</label>
              <input id="s_phone" />
            </div>
            <div>
              <label>E-Mail</label>
              <input id="s_email" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>EAN 170 g</label>
              <input id="s_ean170" placeholder="4170000057765" />
            </div>
            <div>
              <label>EAN 750 g</label>
              <input id="s_ean750" placeholder="4170000057949" />
            </div>
          </div>

          <div class="row">
            <div style="display:flex; gap:8px; align-items:flex-end; justify-content:flex-end">
              <button class="btnOk" id="btnSaveSettings">Speichern</button>
            </div>
          </div>

          <div class="hr"></div>
          <div class="hint">
            <b>LMIV:</b> Zutatenliste + Allergene + Zusatzstoffe + Nährwerte + Netto + Hersteller + Lagerung + MHD/Charge.
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div>
        <div class="card labelCard">
          <h2>Etikett Vorschau (fix: Barcode unten, kein Cut)</h2>

          <div class="row">
            <div>
              <label>Layout</label>
              <select id="layoutMode">
                <option value="clean">Clean (Supermarkt)</option>
                <option value="compact">Compact (mehr Text)</option>
              </select>
            </div>
            <div>
              <label>Schriftgröße</label>
              <select id="fontScale">
                <option value="1">Normal</option>
                <option value="0.95">Etwas kleiner</option>
                <option value="0.9">Klein</option>
              </select>
            </div>
          </div>

          <div class="hr"></div>

          <div class="labelWrap">
            <div class="label" id="labelPreview">
              <div class="labelBody" id="labelBody">
                <div class="labelBodyContent" id="labelInner"></div>
              </div>
              <div class="labelStrip hidden" id="barcodeStrip"></div>
              <div class="lQR hidden" id="labelQR"></div>
            </div>
          </div>

          <div class="hr"></div>
          <div class="hint">Druck: QL-810W → Skalierung 100% → Rand 0. Barcode bleibt immer unten.</div>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

<script>
/* ===================== STATE ===================== */
const STORAGE_KEY = "sanremo_lmiv_labels_v3";

const DEFAULT_STATE = {
  settings: {
    vbz: "Speiseeis",
    vbz_frucht: "Fruchteis",
    storage: "Tiefgekühlt bei -18°C lagern.",
    footer: "Nach dem Auftauen nicht wieder einfrieren.",
    traces: "Soja, Ei, Mandeln, Haselnüsse, Walnüsse, Pistazien",
    showTraces: "yes",
    company: "Eiscafé Sanremo",
    addr: "57319 Bad Berleburg, Deutschland",
    phone: "0176 72809926",
    email: "paulo.sanremo@web.de",
    ean170: "4170000057765",
    ean750: "4170000057949"
  },
  ingredients: [],
  recipes: [],
  current: {
    editingIngId: null,
    editingRecipeId: null,
    recipe: {
      name: "",
      type: "speiseeis",
      netto: "170",
      netto_custom: "",
      lot: "",
      mhd: "",
      qr: "",
      showBarcode: "yes",
      items: []
    }
  }
};

function uid(prefix="id"){ return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16); }
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return structuredClone(DEFAULT_STATE);
    const s = JSON.parse(raw);
    return {
      ...structuredClone(DEFAULT_STATE),
      ...s,
      settings: {...structuredClone(DEFAULT_STATE.settings), ...(s.settings||{})},
      current: {...structuredClone(DEFAULT_STATE.current), ...(s.current||{})}
    };
  }catch(e){
    console.error(e);
    return structuredClone(DEFAULT_STATE);
  }
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
let state = loadState();

const $ = (id)=>document.getElementById(id);
function toast(msg){
  const t = $("toast");
  t.textContent = msg; t.style.display = "block";
  clearTimeout(toast._tm); toast._tm = setTimeout(()=>t.style.display="none", 2200);
}
function num(x){ const v = parseFloat(x); return isFinite(v)?v:0; }
function round(x, d=1){ const p = Math.pow(10,d); return Math.round((num(x)+Number.EPSILON)*p)/p; }
function normalizeList(str){ return (str||"").split(",").map(s=>s.trim()).filter(Boolean); }
function uniq(arr){ return Array.from(new Set(arr.filter(Boolean))); }
function escapeHtml(s){ return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }
function sortByName(a,b){ return (a.name||"").localeCompare((b.name||""), "de"); }

/* ===================== SEED (Milk + Fruit powders) ===================== */
function ensureSeed(){
  if(state.ingredients && state.ingredients.length>0) return;

  const seed = [
    // MILK SYSTEM
    { id:"i_milk_uht_35", name:"H-Vollmilch 3,5% (UHT)", cat:"Milch & Sahne", allergens:"MILCH", additives:"", ingredientsText:"Vollmilch (MILCH).", note:"", n:{kj:0,kcal:0,fat:3.5,sat:2.2,carb:4.8,sugar:4.8,protein:3.4,salt:0.10,fiber:0} },
    { id:"i_cream_33", name:"Schlagsahne 33% Fett", cat:"Milch & Sahne", allergens:"MILCH", additives:"", ingredientsText:"Schlagsahne (MILCH).", note:"", n:{kj:0,kcal:0,fat:33,sat:22,carb:3.3,sugar:3.3,protein:2.4,salt:0.08,fiber:0} },
    { id:"i_sugar", name:"Zucker (Saccharose)", cat:"Zucker & Süßung", allergens:"", additives:"", ingredientsText:"Zucker.", note:"", n:{kj:1700,kcal:400,fat:0,sat:0,carb:100,sugar:100,protein:0,salt:0,fiber:0} },
    { id:"i_dextrose", name:"Dextrose", cat:"Zucker & Süßung", allergens:"", additives:"", ingredientsText:"Dextrose.", note:"", n:{kj:1700,kcal:400,fat:0,sat:0,carb:100,sugar:100,protein:0,salt:0,fiber:0} },
    { id:"i_glucose_powder", name:"Glukosepulver", cat:"Zucker & Süßung", allergens:"", additives:"", ingredientsText:"Glukosepulver.", note:"", n:{kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0,fiber:0} },
    { id:"i_skim_milk_powder", name:"Magermilchpulver", cat:"Pulver & Stabilisierung", allergens:"MILCH", additives:"", ingredientsText:"Magermilchpulver (MILCH).", note:"", n:{kj:0,kcal:0,fat:1,sat:0.7,carb:52,sugar:52,protein:36,salt:0.5,fiber:0} },

    // YOUR KEY: Base Soave (milk base) — put supplier label details here
    { id:"b_base_soave", name:"Base Soave (Milchbasis)", cat:"Basen / Milch", allergens:"MILCH", additives:"", ingredientsText:"(Bitte Zutatenliste vom Lieferantenetikett eintragen – DE).", note:"", n:{kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0,fiber:0} },

    // FRUIT SYSTEM
    { id:"i_water", name:"Wasser", cat:"Sonstiges", allergens:"", additives:"", ingredientsText:"Wasser.", note:"", n:{kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0,fiber:0} },

    // Fruits (placeholders; you can overwrite nutrition if you want)
    { id:"f_erdbeere", name:"Erdbeere (Frucht)", cat:"Frucht / Püree", allergens:"", additives:"", ingredientsText:"Erdbeeren (Frucht).", note:"", n:{kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0,fiber:0} },
    { id:"f_mango", name:"Mango (Frucht)", cat:"Frucht / Püree", allergens:"", additives:"", ingredientsText:"Mango (Frucht).", note:"", n:{kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0,fiber:0} },
    { id:"f_banane", name:"Banane (Frucht)", cat:"Frucht / Püree", allergens:"", additives:"", ingredientsText:"Banane (Frucht).", note:"", n:{kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0,fiber:0} },
    { id:"f_zitrone", name:"Zitrone (Frucht)", cat:"Frucht / Püree", allergens:"", additives:"", ingredientsText:"Zitrone (Frucht).", note:"", n:{kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0,fiber:0} },
    { id:"f_himbeere", name:"Himbeere (Frucht)", cat:"Frucht / Püree", allergens:"", additives:"", ingredientsText:"Himbeeren (Frucht).", note:"", n:{kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0,fiber:0} },
    { id:"f_maracuja", name:"Maracuja (Frucht)", cat:"Frucht / Püree", allergens:"", additives:"", ingredientsText:"Maracuja (Frucht).", note:"", n:{kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0,fiber:0} },
    { id:"f_limette", name:"Limette (Frucht)", cat:"Frucht / Püree", allergens:"", additives:"", ingredientsText:"Limette (Frucht).", note:"", n:{kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0,fiber:0} },

    // Powders you mentioned (edit ingredientsText + E numbers to match your sacks)
    { id:"p_supergelmix", name:"Supergelmix (Fruchteis)", cat:"Basen / Frucht", allergens:"", additives:"(E-Nummern vom Sack eintragen)", ingredientsText:"(Bitte Zutatenliste vom Sack eintragen – DE).", note:"", n:{kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0,fiber:0} },
    { id:"p_lemon_piu", name:"Lemon Più (Zitronen-Fruchteis Pulver)", cat:"Basen / Frucht", allergens:"", additives:"E466, E410, E412, E401, E1422", ingredientsText:"(Bitte Zutatenliste vom Sack eintragen – DE).", note:"", n:{kj:1324.3,kcal:312.6,fat:3.5,sat:3.4,carb:69,sugar:29,protein:1.2,salt:0.3,fiber:0} },
  ];

  state.ingredients = seed.sort(sortByName);
  saveState();
}
ensureSeed();

/* ===================== TABS ===================== */
function setTab(tab){
  document.querySelectorAll(".tab").forEach(el=>el.classList.toggle("active", el.dataset.tab===tab));
  ["ingredients","recipes","settings"].forEach(t=>{
    $("tab-"+t).classList.toggle("hidden", t!==tab);
  });
  renderAll();
}
$("tabs").addEventListener("click",(e)=>{
  const t = e.target.closest(".tab");
  if(!t) return;
  setTab(t.dataset.tab);
});

/* ===================== CATEGORIES ===================== */
function catList(){
  const base = ["Alle","Milch & Sahne","Zucker & Süßung","Pulver & Stabilisierung","Pasten & Nüsse","Variegato / Saucen","Frucht / Püree","Basen / Milch","Basen / Frucht","Sonstiges"];
  const extra = uniq(state.ingredients.map(i=>i.cat).filter(c=>c && !base.includes(c)));
  return base.concat(extra);
}
function fillCatSelects(){
  const cats = catList();
  $("ingCat").innerHTML = cats.filter(c=>c!=="Alle").map(c=>`<option>${escapeHtml(c)}</option>`).join("");
  $("ingFilterCat").innerHTML = cats.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
  if(!$("ingCat").value) $("ingCat").value = "Sonstiges";
}

/* ===================== INGREDIENT FORM ===================== */
function resetIngForm(){
  state.current.editingIngId = null;
  $("ingName").value="";
  $("ingCat").value="Sonstiges";
  $("ingAll").value="";
  $("ingAdd").value="";
  $("ingText").value="";
  $("ingNote").value="";
  $("n_kj").value=0; $("n_kcal").value=0;
  $("n_fat").value=0; $("n_sat").value=0;
  $("n_carb").value=0; $("n_sugar").value=0;
  $("n_protein").value=0; $("n_salt").value=0;
  $("n_fiber").value=0;
}
function loadIngToForm(ing){
  state.current.editingIngId = ing.id;
  $("ingName").value=ing.name||"";
  $("ingCat").value=ing.cat||"Sonstiges";
  $("ingAll").value=ing.allergens||"";
  $("ingAdd").value=ing.additives||"";
  $("ingText").value=ing.ingredientsText||"";
  $("ingNote").value=ing.note||"";
  $("n_kj").value=num(ing.n?.kj);
  $("n_kcal").value=num(ing.n?.kcal);
  $("n_fat").value=num(ing.n?.fat);
  $("n_sat").value=num(ing.n?.sat);
  $("n_carb").value=num(ing.n?.carb);
  $("n_sugar").value=num(ing.n?.sugar);
  $("n_protein").value=num(ing.n?.protein);
  $("n_salt").value=num(ing.n?.salt);
  $("n_fiber").value=num(ing.n?.fiber);
}
function saveIngredient(){
  const ing = {
    id: state.current.editingIngId || uid("ing"),
    name: $("ingName").value.trim(),
    cat: ($("ingCat").value||"Sonstiges").trim(),
    allergens: $("ingAll").value.trim(),
    additives: $("ingAdd").value.trim(),
    ingredientsText: $("ingText").value.trim(),
    note: $("ingNote").value.trim(),
    n: {
      kj: num($("n_kj").value),
      kcal: num($("n_kcal").value),
      fat: num($("n_fat").value),
      sat: num($("n_sat").value),
      carb: num($("n_carb").value),
      sugar: num($("n_sugar").value),
      protein: num($("n_protein").value),
      salt: num($("n_salt").value),
      fiber: num($("n_fiber").value)
    }
  };
  if(!ing.name){ toast("Bitte Namen eingeben."); return; }
  const idx = state.ingredients.findIndex(x=>x.id===ing.id);
  if(idx>=0) state.ingredients[idx]=ing; else state.ingredients.push(ing);
  state.ingredients.sort(sortByName);
  saveState();
  fillCatSelects(); fillPickers(); renderIngredients(); renderLabel();
  toast("Gespeichert ✅");
}
function deleteIngredient(id){
  if(!confirm("Zutat löschen?")) return;
  state.ingredients = state.ingredients.filter(x=>x.id!==id);
  state.current.recipe.items = state.current.recipe.items.filter(it=>it.ingId!==id);
  state.recipes.forEach(r=>r.items=(r.items||[]).filter(it=>it.ingId!==id));
  saveState();
  fillPickers(); renderAll(); toast("Gelöscht.");
}

/* ===================== INGREDIENT LIST ===================== */
function hasAzoWarning(additivesStr){
  const adds = normalizeList(additivesStr).map(x=>x.toUpperCase().replace(/\s/g,""));
  const set = new Set(adds);
  const azo = ["E102","E104","E110","E122","E124","E129"];
  return azo.some(a=>set.has(a));
}
function fmtNutri(n){
  if(!n) return "—";
  return `${round(n.kj,0)}kJ/${round(n.kcal,0)}kcal · F ${round(n.fat,1)} · KH ${round(n.carb,1)} · Z ${round(n.sugar,1)} · E ${round(n.protein,1)} · S ${round(n.salt,2)}`;
}
function renderIngredients(){
  fillCatSelects();
  const q = ($("ingSearch").value||"").trim().toLowerCase();
  const cat = $("ingFilterCat").value;
  const list = $("ingList");

  let items = [...state.ingredients];
  if(cat && cat!=="Alle") items = items.filter(i=>(i.cat||"")==cat);
  if(q) items = items.filter(i=>{
    const hay = (i.name+" "+i.cat+" "+(i.allergens||"")+" "+(i.additives||"")+" "+(i.ingredientsText||"")).toLowerCase();
    return hay.includes(q);
  });

  if(items.length===0){ list.innerHTML = `<div class="hint">Keine Treffer.</div>`; return; }

  list.innerHTML = items.map(i=>{
    const alls = normalizeList(i.allergens).slice(0,4);
    const adds = normalizeList(i.additives).slice(0,4);
    const warn = hasAzoWarning(i.additives) || /kann aktivität/i.test(i.note||"");
    return `
      <div class="item">
        <div class="meta">
          <div class="name">${escapeHtml(i.name)}</div>
          <div class="small">${escapeHtml(i.cat||"")}</div>
          <div>
            ${alls.map(a=>`<span class="pill ok">Allergen: ${escapeHtml(a)}</span>`).join("")}
            ${adds.map(a=>`<span class="pill warn">Zusatz: ${escapeHtml(a)}</span>`).join("")}
            ${warn?`<span class="pill bad">Warnhinweis</span>`:""}
          </div>
          <div class="small mono">pro 100g: ${fmtNutri(i.n)}</div>
        </div>
        <div class="miniBtns">
          <button class="btnPrimary" onclick="window.__editIng('${i.id}')">Bearbeiten</button>
          <button class="btnBad" onclick="window.__delIng('${i.id}')">Löschen</button>
        </div>
      </div>
    `;
  }).join("");
}
window.__editIng = (id)=>{ const ing = state.ingredients.find(x=>x.id===id); if(!ing) return; loadIngToForm(ing); toast("Zutat geladen."); };
window.__delIng = (id)=>deleteIngredient(id);

$("btnSaveIng").addEventListener("click", saveIngredient);
$("btnResetIng").addEventListener("click", ()=>{ resetIngForm(); toast("Neu."); });
$("ingSearch").addEventListener("input", renderIngredients);
$("ingFilterCat").addEventListener("change", renderIngredients);

/* ===================== PICKERS ===================== */
function fillPickers(){
  const sel = $("r_pick");
  const list = [...state.ingredients].sort(sortByName);
  sel.innerHTML = list.map(i=>`<option value="${i.id}">${escapeHtml(i.name)} — ${escapeHtml(i.cat||"")}</option>`).join("");

  const rp = $("recipePicker");
  const rList = [...state.recipes].sort((a,b)=>(a.name||"").localeCompare((b.name||""),"de"));
  rp.innerHTML = `<option value="">— wählen —</option>` + rList.map(r=>`<option value="${r.id}">${escapeHtml(r.name)}</option>`).join("");
}

/* ===================== RECIPE UI ===================== */
function setRecipeFromCurrent(){
  const r = state.current.recipe;
  $("r_name").value = r.name||"";
  $("r_type").value = r.type||"speiseeis";
  $("r_netto").value = (r.netto==="custom") ? "custom" : (r.netto||"170");
  $("r_netto_custom").value = r.netto_custom||"";
  $("customNetRow").style.display = ($("r_netto").value==="custom") ? "flex" : "none";
  $("r_lot").value = r.lot||"";
  $("r_mhd").value = r.mhd||"";
  $("r_qr").value = r.qr||"";
  $("r_showBarcode").value = r.showBarcode||"yes";
}
$("r_netto").addEventListener("change", ()=>{
  $("customNetRow").style.display = ($("r_netto").value==="custom") ? "flex" : "none";
  state.current.recipe.netto = $("r_netto").value; saveState(); renderLabel();
});
$("r_type").addEventListener("change", ()=>{ state.current.recipe.type=$("r_type").value; saveState(); renderLabel(); });
$("r_showBarcode").addEventListener("change", ()=>{ state.current.recipe.showBarcode=$("r_showBarcode").value; saveState(); renderLabel(); });

function compactNote(ing){
  const adds = normalizeList(ing.additives).slice(0,6).join(", ");
  const alls = normalizeList(ing.allergens).slice(0,6).join(", ");
  const parts = [];
  if(alls) parts.push("Allergene: "+alls);
  if(adds) parts.push("Zusatz: "+adds);
  if(ing.note) parts.push(ing.note);
  return parts.join(" · ");
}
function addToRecipe(){
  const ingId = $("r_pick").value;
  const qty = num($("r_qty").value);
  const unit = $("r_unit").value;
  if(!ingId || qty<=0){ toast("Zutat & Menge prüfen."); return; }
  state.current.recipe.items.push({ ingId, qty, unit });
  saveState(); renderRecipeTable(); renderLabel();
}
$("btnAddToRecipe").addEventListener("click", addToRecipe);
function removeRecipeItem(idx){
  state.current.recipe.items.splice(idx,1);
  saveState(); renderRecipeTable(); renderLabel();
}
window.__rmItem = (idx)=>removeRecipeItem(idx);

function renderRecipeTable(){
  const tb = $("recipeTable").querySelector("tbody");
  const items = state.current.recipe.items || [];
  if(items.length===0){ tb.innerHTML = `<tr><td colspan="5" class="mut">Noch keine Zutaten im Rezept.</td></tr>`; return; }
  tb.innerHTML = items.map((it, idx)=>{
    const ing = state.ingredients.find(x=>x.id===it.ingId);
    const note = (ing?.additives || ing?.note || ing?.allergens) ? compactNote(ing) : "";
    return `
      <tr>
        <td><b>${escapeHtml(ing?.name||"Unbekannt")}</b><div class="mut">${escapeHtml(ing?.cat||"")}</div></td>
        <td class="mono">${round(it.qty,1)}</td>
        <td class="mono">${escapeHtml(it.unit)}</td>
        <td class="mut">${escapeHtml(note)}</td>
        <td><button class="btnBad" onclick="window.__rmItem(${idx})">X</button></td>
      </tr>
    `;
  }).join("");
}
function newRecipe(){
  state.current.editingRecipeId = null;
  state.current.recipe = { name:"", type:"speiseeis", netto:"170", netto_custom:"", lot:"", mhd:"", qr:"", showBarcode:"yes", items:[] };
  saveState(); setRecipeFromCurrent(); renderRecipeTable(); renderLabel(); toast("Neues Rezept.");
}
$("btnNewRecipe").addEventListener("click", newRecipe);

function saveRecipe(){
  const r = state.current.recipe;
  r.name = $("r_name").value.trim();
  r.type = $("r_type").value;
  r.netto = $("r_netto").value;
  r.netto_custom = $("r_netto_custom").value.trim();
  r.lot = $("r_lot").value.trim();
  r.mhd = $("r_mhd").value;
  r.qr = $("r_qr").value.trim();
  r.showBarcode = $("r_showBarcode").value;

  if(!r.name){ toast("Rezeptname fehlt."); return; }
  if((r.items||[]).length===0){ toast("Rezept hat keine Zutaten."); return; }

  const rec = { id: state.current.editingRecipeId || uid("rec"), ...structuredClone(r) };
  const idx = state.recipes.findIndex(x=>x.id===rec.id);
  if(idx>=0) state.recipes[idx]=rec; else state.recipes.push(rec);

  state.current.editingRecipeId = rec.id;
  saveState(); fillPickers(); toast("Rezept gespeichert ✅");
}
$("btnSaveRecipe").addEventListener("click", saveRecipe);

function loadRecipe(id){
  const rec = state.recipes.find(r=>r.id===id);
  if(!rec){ toast("Rezept nicht gefunden."); return; }
  state.current.editingRecipeId = rec.id;
  state.current.recipe = structuredClone(rec);
  saveState(); setRecipeFromCurrent(); renderRecipeTable(); renderLabel(); toast("Rezept geladen.");
}
$("btnLoadRecipe").addEventListener("click", ()=>{
  const id = $("recipePicker").value;
  if(!id){ toast("Bitte Rezept wählen."); return; }
  loadRecipe(id);
});
["r_name","r_netto_custom","r_lot","r_mhd","r_qr"].forEach(id=>{
  $(id).addEventListener("input", ()=>{
    state.current.recipe.name = $("r_name").value;
    state.current.recipe.netto_custom = $("r_netto_custom").value;
    state.current.recipe.lot = $("r_lot").value;
    state.current.recipe.mhd = $("r_mhd").value;
    state.current.recipe.qr = $("r_qr").value;
    saveState(); renderLabel();
  });
});

/* ===================== SETTINGS ===================== */
function loadSettings(){
  $("s_vbz").value = state.settings.vbz || "";
  $("s_vbz_frucht").value = state.settings.vbz_frucht || "";
  $("s_storage").value = state.settings.storage || "";
  $("s_footer").value = state.settings.footer || "";
  $("s_traces").value = state.settings.traces || "";
  $("s_showTraces").value = state.settings.showTraces || "yes";
  $("s_company").value = state.settings.company || "";
  $("s_addr").value = state.settings.addr || "";
  $("s_phone").value = state.settings.phone || "";
  $("s_email").value = state.settings.email || "";
  $("s_ean170").value = state.settings.ean170 || "";
  $("s_ean750").value = state.settings.ean750 || "";
}
function saveSettings(){
  state.settings.vbz = $("s_vbz").value.trim();
  state.settings.vbz_frucht = $("s_vbz_frucht").value.trim();
  state.settings.storage = $("s_storage").value.trim();
  state.settings.footer = $("s_footer").value.trim();
  state.settings.traces = $("s_traces").value.trim();
  state.settings.showTraces = $("s_showTraces").value;
  state.settings.company = $("s_company").value.trim();
  state.settings.addr = $("s_addr").value.trim();
  state.settings.phone = $("s_phone").value.trim();
  state.settings.email = $("s_email").value.trim();
  state.settings.ean170 = $("s_ean170").value.trim() || "4170000057765";
  state.settings.ean750 = $("s_ean750").value.trim() || "4170000057949";
  saveState(); renderLabel(); toast("Gespeichert ✅");
}
$("btnSaveSettings").addEventListener("click", saveSettings);

/* ===================== LABEL LOGIC (NO OVERLAP) ===================== */
$("labelSize").addEventListener("change", renderLabel);
$("layoutMode").addEventListener("change", renderLabel);
$("fontScale").addEventListener("change", renderLabel);

function recipeTotals(){
  const items = state.current.recipe.items || [];
  let totalG = 0;
  const sum = {kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0,fiber:0};
  const allergens = [];
  const additives = [];
  let warn = false;

  for(const it of items){
    const ing = state.ingredients.find(x=>x.id===it.ingId);
    if(!ing) continue;
    const qtyG = it.qty; // ml ~ g
    totalG += qtyG;

    const n = ing.n || {};
    sum.kj += (num(n.kj) * qtyG / 100);
    sum.kcal += (num(n.kcal) * qtyG / 100);
    sum.fat += (num(n.fat) * qtyG / 100);
    sum.sat += (num(n.sat) * qtyG / 100);
    sum.carb += (num(n.carb) * qtyG / 100);
    sum.sugar += (num(n.sugar) * qtyG / 100);
    sum.protein += (num(n.protein) * qtyG / 100);
    sum.salt += (num(n.salt) * qtyG / 100);
    sum.fiber += (num(n.fiber) * qtyG / 100);

    normalizeList(ing.allergens).forEach(a=>allergens.push(a));
    normalizeList(ing.additives).forEach(a=>additives.push(a));
    if(hasAzoWarning(ing.additives) || /kann aktivität/i.test(ing.note||"")) warn = true;
  }

  const per100 = (totalG>0) ? {
    kj: sum.kj*100/totalG,
    kcal: sum.kcal*100/totalG,
    fat: sum.fat*100/totalG,
    sat: sum.sat*100/totalG,
    carb: sum.carb*100/totalG,
    sugar: sum.sugar*100/totalG,
    protein: sum.protein*100/totalG,
    salt: sum.salt*100/totalG,
    fiber: sum.fiber*100/totalG
  } : {kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0,fiber:0};

  return {
    per100,
    allergens: uniq(allergens.map(a=>a.toUpperCase())),
    additives: uniq(additives.map(a=>a.toUpperCase())),
    warn
  };
}
function ingredientListText(){
  const items = [...(state.current.recipe.items||[])].sort((a,b)=>num(b.qty)-num(a.qty));
  const parts = [];
  for(const it of items){
    const ing = state.ingredients.find(x=>x.id===it.ingId);
    if(!ing) continue;
    parts.push((ing.ingredientsText && ing.ingredientsText.trim()) ? ing.ingredientsText.trim() : ing.name);
  }
  return parts.join(", ").replace(/\s+,/g,",").replace(/,\s+,/g,", ");
}
function getEAN(){
  const r = state.current.recipe;
  if((r.showBarcode||"yes")!=="yes") return "";
  if(r.netto==="170") return (state.settings.ean170||"").trim();
  if(r.netto==="750") return (state.settings.ean750||"").trim();
  return "";
}

function renderLabel(){
  const size = $("labelSize").value;
  const mode = $("layoutMode").value;
  const fs = num($("fontScale").value);

  const dims = (size==="38x90") ? {w:90,h:38} : {w:100,h:62};
  const small = (size==="38x90");

  const mmToPx = 6;
  const pxW = Math.round(dims.w*mmToPx);
  const pxH = Math.round(dims.h*mmToPx);

  const label = $("labelPreview");
  label.style.width = pxW+"px";
  label.style.height = pxH+"px";
  label.style.transform = `scale(${fs})`;
  label.style.transformOrigin = "center";

  // Reserve strip area (PREVIEW) -> prevents overlap + bottom cut
  const strip = $("barcodeStrip");
  const stripPx = small ? 54 : 70;
  strip.style.height = stripPx+"px";
  $("labelBody").style.bottom = stripPx+"px";

  // QR sizing (preview)
  const qr = $("labelQR");
  qr.style.width = (small ? 46 : 56) + "px";
  qr.style.height = (small ? 46 : 56) + "px";

  const r = state.current.recipe;
  const totals = recipeTotals();
  const isFruit = (r.type==="fruchteis");
  const vbz = isFruit ? (state.settings.vbz_frucht||"Fruchteis") : (state.settings.vbz||"Speiseeis");
  const nettoText = (r.netto==="custom" && r.netto_custom.trim()) ? r.netto_custom.trim() : ((r.netto||"170")+" g");
  const ingText = ingredientListText();
  const alls = totals.allergens.length ? totals.allergens.join(", ") : "—";
  const adds = totals.additives.length ? totals.additives.join(", ") : "—";
  const n = totals.per100;

  const showTraces = (state.settings.showTraces||"yes")==="yes" && (state.settings.traces||"").trim();
  const tracesLine = showTraces ? `<div class="lSmall" style="font-weight:800;">Kann Spuren enthalten: ${escapeHtml(state.settings.traces)}</div>` : "";

  const warnLine = totals.warn ? `<div class="lWarn">Hinweis: Kann Aktivität und Aufmerksamkeit bei Kindern beeinträchtigen.</div>` : "";

  const companyLine = `${state.settings.company||""} · ${state.settings.addr||""}`;
  const contactLine = `${state.settings.phone||""}${state.settings.email?(" · "+state.settings.email):""}`;

  // Typography per size
  const tTitle = small ? 13.2 : 15.2;
  const tSub   = small ? 9.6  : 11.0;
  const tSmall = small ? 8.6  : 10.0;
  const tFoot  = small ? 8.0  : 9.2;

  const sub1 = `<div class="lSub" style="font-size:${tSub}px"><b>${escapeHtml(vbz)}</b> · Netto: <b>${escapeHtml(nettoText)}</b></div>`;
  const sub2 = `<div class="lSub" style="font-size:${tSub}px">${escapeHtml(state.settings.storage||"")}</div>`;

  const ingredientsBlock = `
    <div class="lSmall" style="font-size:${tSmall}px"><b>Zutaten:</b> ${escapeHtml(ingText||"—")}</div>
    <div class="lSmall" style="font-size:${tSmall}px"><b>Allergene:</b> ${escapeHtml(alls)}</div>
    <div class="lSmall" style="font-size:${tSmall}px"><b>Zusatzstoffe:</b> ${escapeHtml(adds)}</div>
    ${tracesLine}
  `;

  const nutriTable = `
    <div class="lSmall" style="font-size:${tSmall}px; font-weight:900">Durchschnittliche Nährwerte je 100 g:</div>
    <table style="font-size:${tSmall}px">
      <tr><th>Energie</th><td class="mono">${round(n.kj,0)} kJ / ${round(n.kcal,0)} kcal</td></tr>
      <tr><th>Fett</th><td class="mono">${round(n.fat,1)} g</td></tr>
      <tr><th>davon gesättigte Fettsäuren</th><td class="mono">${round(n.sat,1)} g</td></tr>
      <tr><th>Kohlenhydrate</th><td class="mono">${round(n.carb,1)} g</td></tr>
      <tr><th>davon Zucker</th><td class="mono">${round(n.sugar,1)} g</td></tr>
      <tr><th>Eiweiß</th><td class="mono">${round(n.protein,1)} g</td></tr>
      <tr><th>Salz</th><td class="mono">${round(n.salt,2)} g</td></tr>
    </table>
  `;

  const lotMhd = `
    <div class="lSmall" style="font-size:${tSmall}px"><b>Charge/Lot:</b> ${escapeHtml(r.lot||"—")} &nbsp; <b>MHD:</b> ${escapeHtml(r.mhd||"—")}</div>
  `;
  const footer = `
    <div class="lFooter" style="font-size:${tFoot}px">
      <div><b>Hersteller:</b> ${escapeHtml(companyLine)}</div>
      <div>${escapeHtml(contactLine)}</div>
      ${state.settings.footer ? `<div>${escapeHtml(state.settings.footer)}</div>` : ""}
    </div>
  `;

  const compact = (mode==="compact");
  let html = "";

  if(small){
    // SMALL = single column (best for no cut)
    html = `
      <div class="lTitle" style="font-size:${tTitle}px">${escapeHtml(r.name||"Gelato")}</div>
      ${sub1}
      ${compact ? "" : sub2}
      ${ingredientsBlock}
      ${nutriTable}
      ${lotMhd}
      ${compact ? sub2 : ""}
      ${warnLine}
      ${footer}
    `;
  }else{
    // BIG = 2 columns
    html = `
      <div class="lTitle" style="font-size:${tTitle}px">${escapeHtml(r.name||"Gelato")}</div>
      ${sub1}
      ${compact ? "" : sub2}
      ${ingredientsBlock}
      <div class="lGrid" style="grid-template-columns:1fr 1fr; font-size:${tSmall}px">
        <div>${nutriTable}</div>
        <div>
          ${lotMhd}
          ${compact ? sub2 : ""}
          ${warnLine}
          ${footer}
        </div>
      </div>
    `;
  }

  $("labelInner").innerHTML = html;

  // QR (optional)
  const qrLink = (r.qr||"").trim();
  if(qrLink){
    qr.classList.remove("hidden");
    qr.innerHTML = makeSimpleQR(qrLink);
  }else{
    qr.classList.add("hidden");
    qr.innerHTML = "";
  }

  // Barcode strip (optional, ALWAYS below)
  const ean = getEAN();
  if(ean && /^\d{13}$/.test(ean)){
    strip.classList.remove("hidden");
    strip.innerHTML = `
      <div style="display:flex; flex-direction:column; gap:3px; align-items:flex-start">
        ${makeEAN13SVG(ean, small ? 46 : 56)}
        <div class="barcodeText">${ean}</div>
      </div>
      <div style="font-size:${small?9:10}px; color:#000; line-height:1.15; opacity:.9">
        hergestellt am: ________<br>kg: ________
      </div>
    `;
  }else{
    strip.classList.add("hidden");
    strip.innerHTML = "";
    $("labelBody").style.bottom = "0px";
  }
}

/* ===================== PRINT (REAL SIZE) ===================== */
$("btnPrint").addEventListener("click", ()=>{
  // sync current inputs
  state.current.recipe.name = $("r_name").value;
  state.current.recipe.type = $("r_type").value;
  state.current.recipe.netto = $("r_netto").value;
  state.current.recipe.netto_custom = $("r_netto_custom").value;
  state.current.recipe.lot = $("r_lot").value;
  state.current.recipe.mhd = $("r_mhd").value;
  state.current.recipe.qr = $("r_qr").value;
  state.current.recipe.showBarcode = $("r_showBarcode").value;
  saveState();

  const size = $("labelSize").value;
  const mode = $("layoutMode").value;
  const fs = num($("fontScale").value);
  const dims = (size==="38x90") ? {w:90,h:38} : {w:100,h:62};
  const small = (size==="38x90");

  const stripMm = small ? 10 : 14; // reserved barcode area
  const html = $("labelPreview").outerHTML;

  const w = window.open("", "_blank");
  if(!w){ toast("Popup blockiert? Bitte erlauben."); return; }

  w.document.open();
  w.document.write(`
    <!doctype html><html><head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Etikett Druck</title>
    <style>
      @page { size: ${dims.w}mm ${dims.h}mm; margin:0; }
      html,body{margin:0; padding:0; background:#fff;}
      .label{
        width:${dims.w}mm; height:${dims.h}mm; position:relative; overflow:hidden;
        background:#fff; color:#000; font-family: Arial, Helvetica, sans-serif;
        transform: scale(${fs}); transform-origin: top left;
        border-radius:0; box-shadow:none;
      }
      .labelBody{position:absolute; left:0; top:0; right:0; bottom:${stripMm}mm; overflow:hidden;}
      .labelBodyContent{padding:2.6mm 2.6mm 2.0mm;}
      .lTitle{font-weight:900; letter-spacing:.2px; font-size:${small?12.3:14.2}pt}
      .lSub{font-size:${small?8.2:9.2}pt; margin-top:0.7mm}
      .lSmall{font-size:${small?7.0:7.8}pt; margin-top:0.9mm; line-height:1.22}
      table{width:100%; border-collapse:collapse; font-size:${small?7.0:7.6}pt}
      th,td{border:0.25mm solid #000; padding:0.55mm 0.8mm}
      th{text-align:left}
      .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;}
      .lFooter{margin-top:1.1mm; font-size:${small?6.6:7.2}pt; line-height:1.18}
      .lWarn{margin-top:1.1mm; font-size:${small?6.8:7.4}pt; font-weight:800}
      .lGrid{display:grid; grid-template-columns:1fr 1fr; gap:2.2mm; margin-top:1.2mm;}
      .labelStrip{
        position:absolute; left:0; right:0; bottom:0; height:${stripMm}mm;
        border-top:0.25mm solid #000; display:flex; align-items:center; gap:2mm; padding:1.4mm 2mm;
      }
      .barcodeText{font-size:${small?7:8}pt; letter-spacing:0.9pt; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;}
      .lQR{position:absolute; right:2mm; top:2mm; width:${small?14:16}mm; height:${small?14:16}mm; border:0.25mm solid #000; display:flex; align-items:center; justify-content:center; overflow:hidden;}
      svg{width:100%; height:100%}
    </style>
    </head><body>
      ${html}
      <script>window.onload=()=>window.print();<\/script>
    </body></html>
  `);
  w.document.close();
});

/* ===================== BACKUP ===================== */
$("btnExport").addEventListener("click", ()=>{
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "sanremo-lmiv-backup.json";
  a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 500);
  toast("Backup exportiert.");
});
$("btnImport").addEventListener("click", ()=> $("fileImport").click());
$("fileImport").addEventListener("change", async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  try{
    const txt = await f.text();
    const obj = JSON.parse(txt);
    if(!obj || typeof obj!=="object") throw new Error("Invalid");
    state = {
      ...structuredClone(DEFAULT_STATE),
      ...obj,
      settings: {...structuredClone(DEFAULT_STATE.settings), ...(obj.settings||{})},
      current: {...structuredClone(DEFAULT_STATE.current), ...(obj.current||{})}
    };
    saveState(); fillCatSelects(); fillPickers(); loadSettings(); setRecipeFromCurrent(); renderAll();
    toast("Backup importiert ✅");
  }catch(err){
    console.error(err);
    toast("Import fehlgeschlagen.");
  }finally{
    $("fileImport").value = "";
  }
});

/* ===================== QR (simple) ===================== */
function makeSimpleQR(text){
  const s = String(text);
  let h = 2166136261;
  for(let i=0;i<s.length;i++){ h ^= s.charCodeAt(i); h = Math.imul(h, 16777619); }
  const size = 29, mod = 5, w = size*mod;
  let cells = [];
  function rnd(){ h ^= h<<13; h ^= h>>>17; h ^= h<<5; return (h>>>0)/4294967295; }
  function isFinder(x,y){
    const fp = (ox,oy)=>{
      const dx=x-ox, dy=y-oy;
      if(dx<0||dy<0||dx>6||dy>6) return false;
      const onEdge = dx===0||dy===0||dx===6||dy===6;
      const inner = dx>=2&&dx<=4&&dy>=2&&dy<=4;
      const midEdge = dx===1||dy===1||dx===5||dy===5;
      return onEdge || inner || !midEdge;
    };
    return fp(0,0)||fp(size-7,0)||fp(0,size-7);
  }
  for(let y=0;y<size;y++){
    for(let x=0;x<size;x++){
      let on = false;
      if(isFinder(x,y)) on = true;
      else on = rnd()>0.55;
      cells.push(on ? `<rect x="${x*mod}" y="${y*mod}" width="${mod}" height="${mod}" fill="#000"/>` : "");
    }
  }
  return `<svg viewBox="0 0 ${w} ${w}" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
    <rect width="${w}" height="${w}" fill="#fff"/>${cells.join("")}
  </svg>`;
}

/* ===================== REAL EAN-13 SVG ===================== */
function makeEAN13SVG(ean, heightPx=56){
  const L = {"0":"0001101","1":"0011001","2":"0010011","3":"0111101","4":"0100011","5":"0110001","6":"0101111","7":"0111011","8":"0110111","9":"0001011"};
  const G = {"0":"0100111","1":"0110011","2":"0011011","3":"0100001","4":"0011101","5":"0111001","6":"0000101","7":"0010001","8":"0001001","9":"0010111"};
  const R = {"0":"1110010","1":"1100110","2":"1101100","3":"1000010","4":"1011100","5":"1001110","6":"1010000","7":"1000100","8":"1001000","9":"1110100"};
  const PARITY = {"0":"LLLLLL","1":"LLGLGG","2":"LLGGLG","3":"LLGGGL","4":"LGLLGG","5":"LGGLLG","6":"LGGGLL","7":"LGLGLG","8":"LGLGGL","9":"LGGLGL"};
  if(!/^\d{13}$/.test(ean)) return "";
  const first = ean[0], left = ean.slice(1,7), right = ean.slice(7);
  let bits = "101";
  const p = PARITY[first];
  for(let i=0;i<6;i++){ bits += (p[i]==="L" ? L[left[i]] : G[left[i]]); }
  bits += "01010";
  for(let i=0;i<6;i++){ bits += R[right[i]]; }
  bits += "101";

  const module = 2; // px
  const w = bits.length * module;
  const h = heightPx;
  let x = 0, rects = [];
  for(let i=0;i<bits.length;i++){
    if(bits[i]==="1") rects.push(`<rect x="${x}" y="0" width="${module}" height="${h}" fill="#000"/>`);
    x += module;
  }
  return `<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" shape-rendering="crispEdges">
    <rect width="${w}" height="${h}" fill="#fff"/>${rects.join("")}
  </svg>`;
}

/* ===================== INIT RENDER ===================== */
function renderAll(){
  fillCatSelects();
  fillPickers();
  loadSettings();
  setRecipeFromCurrent();
  renderIngredients();
  renderRecipeTable();
  renderLabel();
}
(function init(){
  fillCatSelects();
  fillPickers();
  loadSettings();

  // default MHD +6 Monate
  if(!state.current.recipe.mhd){
    const d = new Date();
    d.setMonth(d.getMonth()+6);
    state.current.recipe.mhd = d.toISOString().slice(0,10);
    saveState();
  }
  setRecipeFromCurrent();
  renderAll();
  resetIngForm();
})();
</script>
</body>
</html>

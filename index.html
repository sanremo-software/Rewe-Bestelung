<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Eiscafé Sanremo – LMIV Etiketten (Final)</title>
  <style>
    :root{
      --bg:#070b15; --card:rgba(255,255,255,.05); --line:rgba(255,255,255,.10);
      --txt:#eaf0ff; --mut:rgba(234,240,255,.72);
      --acc:#4dd4ff; --ok:#33d17a; --warn:#ffcc66; --bad:#ff6b6b;
      --r:18px; --shadow:0 14px 40px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--sans); color:var(--txt);
      background:
        radial-gradient(1200px 700px at 15% -10%, rgba(77,212,255,.18), transparent 55%),
        radial-gradient(900px 600px at 95% 0%, rgba(51,209,122,.16), transparent 55%),
        linear-gradient(180deg, #040611 0%, var(--bg) 65%, #040611 100%);
    }
    .wrap{max-width:1220px;margin:0 auto;padding:16px 14px 90px}
    .top{
      position:sticky; top:0; z-index:20;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 0 10px;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(4,6,17,.92) 0%, rgba(4,6,17,.68) 75%, transparent 100%);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: conic-gradient(from 210deg, var(--ok), var(--acc), #9b7bff, var(--ok));
      box-shadow:var(--shadow);
    }
    .title h1{margin:0;font-size:16px;letter-spacing:.2px}
    .title .sub{margin-top:3px;font-size:12px;color:var(--mut)}
    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    button{
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      color:var(--txt);
      padding:10px 12px;border-radius:14px;
      cursor:pointer;font-weight:750;font-size:13px;
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
    }
    button:hover{border-color: rgba(77,212,255,.35)}
    .btnOk{background: linear-gradient(180deg, rgba(51,209,122,.26), rgba(51,209,122,.12)); border-color: rgba(51,209,122,.35);}
    .btnAcc{background: linear-gradient(180deg, rgba(77,212,255,.26), rgba(77,212,255,.12)); border-color: rgba(77,212,255,.35);}
    .btnBad{background: linear-gradient(180deg, rgba(255,107,107,.22), rgba(255,107,107,.12)); border-color: rgba(255,107,107,.35);}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 14px}
    .tab{
      padding:10px 12px;border-radius:999px;cursor:pointer;user-select:none;
      border:1px solid rgba(255,255,255,.12); color:var(--mut);
      background: rgba(255,255,255,.04); font-weight:800; font-size:13px;
    }
    .tab.active{color:var(--txt); border-color: rgba(77,212,255,.45); background: rgba(77,212,255,.12);}

    .grid{display:grid;gap:14px;grid-template-columns: 1.05fr .95fr;align-items:start}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} .actions{justify-content:flex-start} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .card h2{margin:0 0 10px;font-size:14px}
    .mut{color:var(--mut)}
    label{display:block;font-size:12px;color:var(--mut);margin:0 0 6px}
    input,select,textarea{
      width:100%;
      padding:11px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,14,26,.65);
      color:var(--txt); outline:none;
      font-size:13px;
    }
    textarea{min-height:88px;resize:vertical}
    input:focus,select:focus,textarea:focus{border-color: rgba(77,212,255,.55)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .row > *{flex:1;min-width:180px}
    .row.tight > *{flex:0;min-width:auto}
    .hr{height:1px;background: rgba(255,255,255,.08);margin:12px 0}
    .hint{
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color:var(--mut); font-size:12px; line-height:1.35;
    }

    .list{display:flex;flex-direction:column;gap:10px;max-height:520px;overflow:auto;padding-right:4px}
    .item{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius:16px;
      padding:10px;
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
    }
    .item .meta{flex:1;min-width:0}
    .item .name{font-weight:900;font-size:13px}
    .item .small{font-size:12px;color:var(--mut);margin-top:2px}
    .miniBtns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .miniBtns button{padding:8px 10px;font-size:12px;border-radius:12px;box-shadow:none}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      font-size:11px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color:var(--mut); margin:6px 6px 0 0; white-space:nowrap;
    }
    .pill.ok{border-color: rgba(51,209,122,.35); color:#b9f7d8; background: rgba(51,209,122,.10)}
    .pill.warn{border-color: rgba(255,204,102,.35); color:#ffe7b8; background: rgba(255,204,102,.10)}
    .pill.bad{border-color: rgba(255,107,107,.35); color:#ffd2d2; background: rgba(255,107,107,.10)}
    .mono{font-family:var(--mono)}

    .table{
      width:100%; border-collapse:separate; border-spacing:0;
      overflow:hidden; border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .table th,.table td{
      padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.08);
      font-size:12px; text-align:left; vertical-align:top;
    }
    .table th{color:var(--mut);font-weight:800;background: rgba(255,255,255,.03)}
    .table tr:last-child td{border-bottom:none}

    .labelCard{position:sticky; top:90px}
    @media (max-width:980px){ .labelCard{position:relative; top:auto} }

    /* Preview frame */
    .labelWrap{
      display:flex;justify-content:center;align-items:center;
      padding:10px;border-radius:16px;
      background: rgba(0,0,0,.25);
      border:1px dashed rgba(255,255,255,.16);
      overflow:auto;
    }

    /* ------------------ LABEL (shared) ------------------ */
    .lbl{
      background:#fff; color:#000;
      border-radius:7px;
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
      overflow:hidden;
      position:relative;
      font-family: Arial, Helvetica, sans-serif;
      display:flex;
      flex-direction:column; /* ensures barcode zone stays bottom */
    }
    .lbl .content{padding:3mm 3mm 2.4mm; display:flex; flex-direction:column; gap:1.4mm; flex:1 1 auto; min-height:0;}
    .lbl .bottom{
      margin-top:auto;
      border-top:0.35mm solid #111;
      padding:1.8mm 3mm 1.8mm;
      display:flex; gap:2.2mm; align-items:flex-end; justify-content:space-between;
    }
    .lbl .prodName{font-weight:900; letter-spacing:.2px; line-height:1.05;}
    .lbl .meta{font-size:8.6pt; line-height:1.18; text-align:right; white-space:nowrap;}
    .lbl .topLine{display:flex; gap:4mm; align-items:flex-end; justify-content:space-between; border-bottom:0.35mm solid #111; padding-bottom:1.2mm;}
    .lbl .block{font-size:8.6pt; line-height:1.25;}
    .lbl .block b{font-weight:900;}
    .lbl .spuren{
      border:0.35mm solid #111; padding:1.2mm 1.4mm;
      font-weight:900; font-size:9.2pt; background:#fff;
    }
    .lbl .maker{font-size:8.2pt; line-height:1.2;}
    .lbl .lotBox{
      border:0.35mm solid #111; padding:1.0mm 1.2mm; font-size:8.2pt; line-height:1.22; min-width:34mm;
    }
    .lbl .lotBox b{font-weight:900;}
    .lbl .barcodeBox{display:flex; flex-direction:column; gap:0.6mm; min-width:0; align-items:flex-start;}
    .lbl .eanText{font-size:8pt; letter-spacing:.25px;}

    /* Nutrition table (works in both sizes) */
    .nutriTitle{font-weight:900; font-size:9pt; margin-bottom:1.0mm;}
    table.nutri{
      width:100%; border-collapse:collapse; font-size:8.3pt;
    }
    .nutri th, .nutri td{border:0.32mm solid #111; padding:0.8mm 1.1mm; vertical-align:middle;}
    .nutri th{font-weight:900; text-align:left; background:#f2f2f2;}
    .nutri td:last-child{text-align:right; font-variant-numeric: tabular-nums;}
    .nutri .sub{font-weight:700; font-size:7.9pt;}

    /* Large label layout (62x100) */
    .lbl.large{width:100mm; height:62mm;}
    .lbl.large .prodName{font-size:15pt;}
    .lbl.large .grid{
      display:grid;
      grid-template-columns: 48% 52%;
      gap:2.2mm;
      flex:1 1 auto;
      min-height:0;
      align-items:start;
    }

    /* Small label layout (38x90) – MUST fit: stacked + compact */
    .lbl.small{width:90mm; height:38mm;}
    .lbl.small .content{padding:2.3mm 2.3mm 1.8mm; gap:1.1mm;}
    .lbl.small .prodName{font-size:12.2pt;}
    .lbl.small .meta{font-size:7.6pt;}
    .lbl.small .block{font-size:7.6pt; line-height:1.18;}
    .lbl.small .spuren{font-size:7.6pt; padding:0.8mm 1.0mm;}
    .lbl.small .maker{font-size:7.2pt;}
    .lbl.small table.nutri{font-size:7.2pt;}
    .lbl.small .nutri th,.lbl.small .nutri td{padding:0.55mm 0.75mm;}
    .lbl.small .bottom{padding:1.2mm 2.3mm 1.2mm;}
    .lbl.small .lotBox{font-size:7.0pt; min-width:28mm;}

    .toast{
      position:fixed; left:50%; bottom:14px; transform:translateX(-50%);
      background: rgba(17,26,51,.92);
      border:1px solid rgba(255,255,255,.12);
      color:var(--txt); padding:10px 12px;
      border-radius:14px; box-shadow: var(--shadow);
      font-size:13px; display:none; z-index:999;
      max-width: min(780px, 92vw);
    }
    .hidden{display:none !important;}
  </style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">
        <h1>Eiscafé Sanremo – LMIV Etiketten (Final 100%)</h1>
        <div class="sub">Mobile/Tablet • Brother QL-810W • DK11208 (38×90) & DK11202 (62×100) • Barcode immer unten</div>
      </div>
    </div>

    <div class="actions">
      <button class="btnAcc" id="btnExport">Backup exportieren</button>
      <button class="btnAcc" id="btnImport">Backup importieren</button>
      <input id="fileImport" type="file" accept="application/json" class="hidden"/>
      <button class="btnOk" id="btnPrint">Etikett drucken</button>
      <button class="btnBad" id="btnResetAll">Reset</button>
    </div>
  </div>

  <div class="tabs" id="tabs">
    <div class="tab active" data-tab="ingredients">Zutaten / Produkte</div>
    <div class="tab" data-tab="recipes">Rezepte</div>
    <div class="tab" data-tab="settings">Betrieb / Standard</div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div>

      <!-- INGREDIENTS -->
      <div class="card" id="tab-ingredients">
        <h2>Zutaten-Bibliothek (du kannst alles hinzufügen)</h2>

        <div class="row">
          <div>
            <label>Suche</label>
            <input id="ingSearch" placeholder="z.B. Base Soave, Supergel, Erdbeere, Pistazie..." />
          </div>
          <div>
            <label>Kategorie</label>
            <select id="ingFilterCat"></select>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <div>
            <label>Name</label>
            <input id="ingName" placeholder="z.B. Supergel Mix D" />
          </div>
          <div>
            <label>Kategorie</label>
            <select id="ingCat"></select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Allergene (GROSS, Komma)</label>
            <input id="ingAll" placeholder="z.B. MILCH, SOJA, SCHALENFRÜCHTE" />
          </div>
          <div>
            <label>„Kann Spuren enthalten“ (Komma) – optional</label>
            <input id="ingSpuren" placeholder="z.B. MILCH, EI, MANDELN ..." />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Zusatzstoffe / E-Nummern (Komma)</label>
            <input id="ingAdd" placeholder="z.B. E471, E477, E129" />
          </div>
          <div>
            <label>Hinweis (optional)</label>
            <input id="ingNote" placeholder="z.B. Kann Aktivität und Aufmerksamkeit bei Kindern beeinträchtigen." />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Zutatenliste (für dieses Produkt – LMIV Text)</label>
            <textarea id="ingText" placeholder="z.B. Dextrose, Glukosesirup, Emulgator (E471) ..."></textarea>
          </div>
        </div>

        <div class="hr"></div>
        <h2>Nährwerte pro 100 g (vom Lieferanten)</h2>

        <div class="row">
          <div><label>Energie (kJ)</label><input id="n_kj" type="number" step="0.1" value="0"></div>
          <div><label>Energie (kcal)</label><input id="n_kcal" type="number" step="0.1" value="0"></div>
        </div>
        <div class="row">
          <div><label>Fett (g)</label><input id="n_fat" type="number" step="0.1" value="0"></div>
          <div><label>davon gesättigt (g)</label><input id="n_sat" type="number" step="0.1" value="0"></div>
        </div>
        <div class="row">
          <div><label>Kohlenhydrate (g)</label><input id="n_carb" type="number" step="0.1" value="0"></div>
          <div><label>davon Zucker (g)</label><input id="n_sugar" type="number" step="0.1" value="0"></div>
        </div>
        <div class="row">
          <div><label>Eiweiß (g)</label><input id="n_protein" type="number" step="0.1" value="0"></div>
          <div><label>Salz (g)</label><input id="n_salt" type="number" step="0.01" value="0"></div>
        </div>

        <div class="row tight" style="justify-content:flex-end">
          <button class="btnOk" id="btnSaveIng">Speichern</button>
          <button class="btnBad" id="btnNewIng">Neu</button>
        </div>

        <div class="hr"></div>
        <h2>Liste</h2>
        <div class="list" id="ingList"></div>
      </div>

      <!-- RECIPES -->
      <div class="card hidden" id="tab-recipes">
        <h2>Rezepte + Etikett (berechnet Nährwerte, Allergene, Zusatzstoffe)</h2>

        <div class="row">
          <div>
            <label>Rezeptname / Sorte</label>
            <input id="r_name" placeholder="z.B. Kinder Bueno, Erdbeere, Pistazie..." />
          </div>
          <div>
            <label>Typ</label>
            <select id="r_type">
              <option value="Speiseeis">Speiseeis (Milch)</option>
              <option value="Fruchteis">Fruchteis</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Nettofüllmenge (fixe EANs)</label>
            <select id="r_netto">
              <option value="170">170 g (EAN 4170000057765)</option>
              <option value="750">750 g (EAN 4170000057949)</option>
            </select>
          </div>
          <div>
            <label>Etikettgröße</label>
            <select id="labelSize">
              <option value="62x100">DK11202 – 62×100 mm</option>
              <option value="38x90">DK11208 – 38×90 mm</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Charge / Lot</label>
            <input id="r_lot" placeholder="z.B. L2517368" />
          </div>
          <div>
            <label>MHD</label>
            <input id="r_mhd" type="date" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Herstellungsdatum (optional, Text)</label>
            <input id="r_prod" placeholder="z.B. 18.12.2025" />
          </div>
          <div>
            <label>EAN (optional überschreiben)</label>
            <input id="r_ean" placeholder="leer lassen = automatisch" inputmode="numeric" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>„Kann Spuren enthalten“ Zeile</label>
            <select id="r_spuren_on">
              <option value="yes">Anzeigen</option>
              <option value="no">Ausblenden</option>
            </select>
          </div>
          <div>
            <label>Spuren-Liste (wenn angezeigt)</label>
            <input id="r_spuren_list" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>QR Link (optional)</label>
            <input id="r_qr" placeholder="https://..." />
          </div>
          <div></div>
        </div>

        <div class="hr"></div>

        <h2>Zutaten ins Rezept</h2>
        <div class="row">
          <div>
            <label>Zutat wählen</label>
            <select id="r_pick"></select>
          </div>
          <div>
            <label>Menge</label>
            <input id="r_qty" type="number" step="0.1" value="100" />
          </div>
          <div>
            <label>Einheit</label>
            <select id="r_unit">
              <option value="g">g</option>
              <option value="ml">ml</option>
            </select>
          </div>
          <div style="flex:0;min-width:auto">
            <label>&nbsp;</label>
            <button class="btnOk" id="btnAddToRecipe">Hinzufügen</button>
          </div>
        </div>

        <div class="hr"></div>

        <h2>Rezeptliste</h2>
        <table class="table" id="recipeTable">
          <thead>
            <tr>
              <th style="width:42%">Zutat</th>
              <th style="width:14%">Menge</th>
              <th style="width:10%">Einheit</th>
              <th style="width:26%">Info (Allergen/Zusatz)</th>
              <th style="width:8%"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="hr"></div>

        <div class="hint">
          <b>Automatik (LMIV):</b>
          Zutatenliste wird nach Menge sortiert • Allergene/Zusatzstoffe werden gesammelt • Nährwerte je 100 g werden berechnet.
          Für Pasten/Variegato nutze die Werte vom Lieferantenetikett.
        </div>

        <div class="hr"></div>

        <div class="row tight" style="justify-content:flex-start">
          <button class="btnOk" id="btnSaveRecipe">Rezept speichern</button>
          <button class="btnBad" id="btnNewRecipe">Neues Rezept</button>
          <button class="btnAcc" id="btnLoadRecipe">Rezept laden</button>
          <select id="recipePicker" style="min-width:220px"></select>
        </div>
      </div>

      <!-- SETTINGS -->
      <div class="card hidden" id="tab-settings">
        <h2>Betrieb / Standardtexte</h2>

        <div class="row">
          <div>
            <label>Aufbewahrung (Standard)</label>
            <input id="s_storage" value="Tiefgekühlt bei -18 °C lagern." />
          </div>
          <div>
            <label>Hinweis (Standard)</label>
            <input id="s_footer" value="Nach dem Auftauen nicht wieder einfrieren." />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Firma</label>
            <input id="s_company" />
          </div>
          <div>
            <label>Adresse</label>
            <input id="s_addr" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Telefon</label>
            <input id="s_phone" />
          </div>
          <div>
            <label>E-Mail</label>
            <input id="s_email" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Standard „Kann Spuren enthalten“ (dein Betrieb)</label>
            <input id="s_spuren_default" />
          </div>
          <div></div>
        </div>

        <div class="row tight" style="justify-content:flex-end">
          <button class="btnOk" id="btnSaveSettings">Speichern</button>
        </div>

        <div class="hr"></div>
        <div class="hint">
          <b>Wichtig:</b> Für Supermarkt-Ware müssen Zutaten, Allergene, Zusatzstoffe und Nährwerte korrekt sein.
          Spuren-Linie schützt dich bei Kreuzkontamination in Produktion/Schaufeln/Behältern.
        </div>
      </div>

    </div>

    <!-- RIGHT: LABEL -->
    <div>
      <div class="card labelCard">
        <h2>Etikett Vorschau (final)</h2>

        <div class="row">
          <div>
            <label>Layout</label>
            <select id="layoutMode">
              <option value="clean">Clean (Supermarkt)</option>
              <option value="compact">Compact (mehr Text)</option>
            </select>
          </div>
          <div>
            <label>Barcode</label>
            <select id="barcodeOn">
              <option value="yes">Anzeigen</option>
              <option value="no">Ausblenden</option>
            </select>
          </div>
        </div>

        <div class="hr"></div>

        <div class="labelWrap">
          <div class="lbl large" id="labelPreview">
            <div class="content" id="lblContent"></div>
            <div class="bottom" id="lblBottom"></div>
          </div>
        </div>

        <div class="hr"></div>
        <div class="hint">
          Druck: „Etikett drucken“ → Brother QL-810W → <b>Skalierung 100%</b>, <b>Ränder 0</b>.  
          Barcode bleibt immer unten (kein Überlappen).
        </div>
      </div>
    </div>

  </div>

  <div class="toast" id="toast"></div>
</div>

<script>
/* ====================== STORAGE ====================== */
const STORAGE_KEY = "sanremo_lmiv_final_v100";
const FIXED_EAN = { "170": "4170000057765", "750": "4170000057949" };

const DEFAULT_STATE = {
  settings:{
    storage:"Tiefgekühlt bei -18 °C lagern.",
    footer:"Nach dem Auftauen nicht wieder einfrieren.",
    company:"Eiscafé Sanremo",
    addr:"57319 Bad Berleburg, Deutschland",
    phone:"0176 72809926",
    email:"paulo.sanremo@web.de",
    spurenDefault:"Soja, Ei, Mandeln, Haselnüsse, Walnüsse, Pistazien"
  },
  ingredients:[],
  recipes:[],
  current:{
    editingIngId:null,
    editingRecipeId:null,
    recipe:{
      name:"",
      type:"Speiseeis",
      netto:"170",
      labelSize:"62x100",
      lot:"",
      mhd:"",
      prod:"",
      ean:"",
      qr:"",
      spuren_on:"yes",
      spuren_list:"",
      items:[]
    }
  }
};

function deepClone(x){ return JSON.parse(JSON.stringify(x)); }
function uid(prefix="id"){ return prefix+"_"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16); }
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return deepClone(DEFAULT_STATE);
    const s = JSON.parse(raw);
    return {
      ...deepClone(DEFAULT_STATE),
      ...s,
      settings:{...deepClone(DEFAULT_STATE.settings), ...(s.settings||{})},
      current:{...deepClone(DEFAULT_STATE.current), ...(s.current||{})}
    };
  }catch(e){
    return deepClone(DEFAULT_STATE);
  }
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

let state = loadState();

/* ====================== SEED INGREDIENTS (your powders + fruits) ====================== */
function ensureSeed(){
  if(state.ingredients && state.ingredients.length>0) return;

  const seed = [
    // ---- Bases / powders (with real values from your photos) ----
    {
      id:"ing_base_soave",
      name:"Base Soave (Milchbasis)",
      cat:"Pulver & Stabilisierung",
      allergens:"MILCH",
      spuren:"SOJA, EI, MANDELN, HASELNÜSSE, WALNÜSSE, PISTAZIEN",
      additives:"E471, E477, E472b, E473",
      ingredientsText:"Glukosesirup, Magermilchpulver, Dextrose, Pflanzenfette (Palm, Kokosnuss), Emulgatoren (E471, E477, E472b, E473), Milcheiweiß, Verdickungsmittel (Tarakermehl, Carboxymethylcellulose, Carrageen, Guarkernmehl), Laktose, Salz, Aromen.",
      note:"",
      n:{kj:1933,kcal:476,fat:22,sat:16,carb:57,sugar:40,protein:11,salt:1.1}
    },
    {
      id:"ing_supergel_mix_d",
      name:"Supergel Mix D (Fruchteis)",
      cat:"Pulver & Stabilisierung",
      allergens:"SOJA",
      spuren:"MILCH, EI, MANDELN, HASELNÜSSE, WALNÜSSE, PISTAZIEN",
      additives:"E473, E472b, E477",
      ingredientsText:"Dextrose, Feuchthaltemittel: Sorbit, Glukosesirup, pflanzliches Fett (Kokos), Verdickungsmittel (Carboxymethylcellulose, Tarakernmehl, Guarkernmehl), Emulgatoren (E473, E472b, E477), Maltodextrin, Sojamehl, Erbsenprotein, Sojaprotein.",
      note:"",
      n:{kj:1454,kcal:347,fat:10,sat:9.4,carb:81,sugar:50,protein:0.7,salt:0.56}
    },
    {
      id:"ing_lemon_piu",
      name:"Lemon Più (Fruchteis)",
      cat:"Pulver & Stabilisierung",
      allergens:"",
      spuren:"MILCH, SOJA",
      additives:"E466, E410, E412, E401, E1422, E471, E477",
      ingredientsText:"Dextrose, getrockneter Zitronensaft, Säuerungsmittel: Zitronensäure, getrockneter Glukosesirup, Verdickungsmittel (E466, E410, E412, E401, E1422), Reisstärke, Emulgatoren (E471, E477), pflanzliche Proteine, Salz, Aromen.",
      note:"",
      n:{kj:1324.3,kcal:312.6,fat:3.5,sat:3.4,carb:69,sugar:29,protein:1.2,salt:0.3}
    },
    {
      id:"ing_yoghin_germania",
      name:"Joghurtpulver (Yoghin Germania)",
      cat:"Pulver & Aromen",
      allergens:"MILCH",
      spuren:"SOJA, EI, MANDELN, HASELNÜSSE, WALNÜSSE, PISTAZIEN, ERDNÜSSE, SESAM",
      additives:"",
      ingredientsText:"Joghurtpulver, Dextrose, Magermilchpulver, Säuerungsmittel: Zitronensäure, Aromen, Milcheiweiß.",
      note:"",
      n:{kj:1827.1,kcal:362.9,fat:0.6,sat:0.2,carb:77.6,sugar:40.2,protein:17.9,salt:0.53}
    },

    // ---- Basic sugars & liquids (common) ----
    { id:"ing_water", name:"Wasser", cat:"Grundstoffe", allergens:"", spuren:"", additives:"", ingredientsText:"Wasser.", note:"", n:{kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0} },
    { id:"ing_sugar", name:"Zucker", cat:"Zucker & Süßung", allergens:"", spuren:"", additives:"", ingredientsText:"Zucker.", note:"", n:{kj:1700,kcal:400,fat:0,sat:0,carb:100,sugar:100,protein:0,salt:0} },
    { id:"ing_dextrose", name:"Dextrose", cat:"Zucker & Süßung", allergens:"", spuren:"", additives:"", ingredientsText:"Dextrose.", note:"", n:{kj:1700,kcal:400,fat:0,sat:0,carb:100,sugar:100,protein:0,salt:0} },
    { id:"ing_glucose_powder", name:"Glukosepulver", cat:"Zucker & Süßung", allergens:"", spuren:"", additives:"", ingredientsText:"Glukosepulver.", note:"", n:{kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0} },

    // ---- Milk base (you use H-Milch 3.5%) ----
    { id:"ing_milk_uht_35", name:"H-Vollmilch 3,5% (UHT)", cat:"Milch & Sahne", allergens:"MILCH", spuren:"", additives:"", ingredientsText:"Vollmilch (MILCH).", note:"", n:{kj:0,kcal:0,fat:3.5,sat:2.2,carb:4.8,sugar:4.8,protein:3.4,salt:0.10} },
    { id:"ing_cream", name:"Sahne 33% (Schlagsahne)", cat:"Milch & Sahne", allergens:"MILCH", spuren:"", additives:"", ingredientsText:"Schlagsahne (MILCH).", note:"", n:{kj:0,kcal:0,fat:33,sat:22,carb:3.3,sugar:3.3,protein:2.4,salt:0.08} },
    { id:"ing_smp", name:"Magermilchpulver", cat:"Milch & Sahne", allergens:"MILCH", spuren:"", additives:"", ingredientsText:"Magermilchpulver (MILCH).", note:"", n:{kj:0,kcal:0,fat:1,sat:0.7,carb:52,sugar:52,protein:36,salt:0.5} },

    // ---- Fruits (placeholders; you can edit + set real nutrition if you want) ----
    { id:"f_strawberry", name:"Erdbeeren (Frucht)", cat:"Frucht", allergens:"", spuren:"", additives:"", ingredientsText:"Erdbeeren.", note:"", n:{kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0} },
    { id:"f_raspberry", name:"Himbeeren (Frucht)", cat:"Frucht", allergens:"", spuren:"", additives:"", ingredientsText:"Himbeeren.", note:"", n:{kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0} },
    { id:"f_mango", name:"Mango (Frucht)", cat:"Frucht", allergens:"", spuren:"", additives:"", ingredientsText:"Mango.", note:"", n:{kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0} },
    { id:"f_banana", name:"Banane (Frucht)", cat:"Frucht", allergens:"", spuren:"", additives:"", ingredientsText:"Banane.", note:"", n:{kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0} },
    { id:"f_lemon", name:"Zitrone (Frucht)", cat:"Frucht", allergens:"", spuren:"", additives:"", ingredientsText:"Zitrone.", note:"", n:{kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0} },
  ];

  state.ingredients = seed.sort((a,b)=>(a.name||"").localeCompare((b.name||""),"de"));
  saveState();
}
ensureSeed();

/* ====================== HELPERS ====================== */
const $ = (id)=>document.getElementById(id);
function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.style.display="block";
  clearTimeout(toast._tm);
  toast._tm=setTimeout(()=>t.style.display="none", 2400);
}
function num(x){ const v=parseFloat(x); return isFinite(v)?v:0; }
function round(x,d=1){ const p=Math.pow(10,d); return Math.round((num(x)+Number.EPSILON)*p)/p; }
function escapeHtml(s){ return String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }
function normalizeList(str){
  return (str||"").split(",").map(s=>s.trim()).filter(Boolean);
}
function uniq(arr){ return Array.from(new Set((arr||[]).filter(Boolean))); }

/* ====================== CATEGORIES ====================== */
function catList(){
  const base=["Alle","Grundstoffe","Milch & Sahne","Zucker & Süßung","Pulver & Stabilisierung","Pulver & Aromen","Frucht","Pasten & Nüsse","Variegato / Saucen","Sonstiges"];
  const extra = uniq(state.ingredients.map(i=>i.cat).filter(c=>c && !base.includes(c)));
  return base.concat(extra);
}
function fillCatSelects(){
  const cats=catList();
  $("ingCat").innerHTML = cats.filter(c=>c!=="Alle").map(c=>`<option>${escapeHtml(c)}</option>`).join("");
  $("ingFilterCat").innerHTML = cats.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
  if(!$("ingCat").value) $("ingCat").value="Sonstiges";
}

/* ====================== TAB NAV ====================== */
function setTab(tab){
  document.querySelectorAll(".tab").forEach(el=>el.classList.toggle("active", el.dataset.tab===tab));
  ["ingredients","recipes","settings"].forEach(t=>{
    $("tab-"+t).classList.toggle("hidden", t!==tab);
  });
  renderAll();
}
$("tabs").addEventListener("click",(e)=>{
  const t=e.target.closest(".tab");
  if(!t) return;
  setTab(t.dataset.tab);
});

/* ====================== INGREDIENTS ====================== */
function resetIngForm(){
  state.current.editingIngId=null;
  $("ingName").value="";
  $("ingCat").value="Sonstiges";
  $("ingAll").value="";
  $("ingSpuren").value="";
  $("ingAdd").value="";
  $("ingText").value="";
  $("ingNote").value="";
  $("n_kj").value=0; $("n_kcal").value=0;
  $("n_fat").value=0; $("n_sat").value=0;
  $("n_carb").value=0; $("n_sugar").value=0;
  $("n_protein").value=0; $("n_salt").value=0;
}
function loadIngToForm(ing){
  state.current.editingIngId=ing.id;
  $("ingName").value=ing.name||"";
  $("ingCat").value=ing.cat||"Sonstiges";
  $("ingAll").value=ing.allergens||"";
  $("ingSpuren").value=ing.spuren||"";
  $("ingAdd").value=ing.additives||"";
  $("ingText").value=ing.ingredientsText||"";
  $("ingNote").value=ing.note||"";
  $("n_kj").value=num(ing.n?.kj);
  $("n_kcal").value=num(ing.n?.kcal);
  $("n_fat").value=num(ing.n?.fat);
  $("n_sat").value=num(ing.n?.sat);
  $("n_carb").value=num(ing.n?.carb);
  $("n_sugar").value=num(ing.n?.sugar);
  $("n_protein").value=num(ing.n?.protein);
  $("n_salt").value=num(ing.n?.salt);
}
function saveIngredient(){
  const ing={
    id: state.current.editingIngId || uid("ing"),
    name: $("ingName").value.trim(),
    cat: $("ingCat").value.trim() || "Sonstiges",
    allergens: $("ingAll").value.trim(),
    spuren: $("ingSpuren").value.trim(),
    additives: $("ingAdd").value.trim(),
    ingredientsText: $("ingText").value.trim(),
    note: $("ingNote").value.trim(),
    n:{
      kj:num($("n_kj").value),
      kcal:num($("n_kcal").value),
      fat:num($("n_fat").value),
      sat:num($("n_sat").value),
      carb:num($("n_carb").value),
      sugar:num($("n_sugar").value),
      protein:num($("n_protein").value),
      salt:num($("n_salt").value),
    }
  };
  if(!ing.name){ toast("Bitte Namen eingeben."); return; }
  const idx=state.ingredients.findIndex(x=>x.id===ing.id);
  if(idx>=0) state.ingredients[idx]=ing; else state.ingredients.push(ing);
  state.ingredients.sort((a,b)=>(a.name||"").localeCompare((b.name||""),"de"));
  saveState();
  fillCatSelects();
  fillPickers();
  renderIngredients();
  renderLabel();
  toast("Gespeichert ✅");
}
function deleteIngredient(id){
  if(!confirm("Zutat löschen?")) return;
  state.ingredients = state.ingredients.filter(x=>x.id!==id);
  state.current.recipe.items = (state.current.recipe.items||[]).filter(it=>it.ingId!==id);
  state.recipes.forEach(r=>r.items=(r.items||[]).filter(it=>it.ingId!==id));
  saveState();
  fillPickers();
  renderAll();
  toast("Gelöscht.");
}
window.__editIng=(id)=>{ const ing=state.ingredients.find(x=>x.id===id); if(ing){ loadIngToForm(ing); toast("Zutat geladen."); } };
window.__delIng=(id)=>deleteIngredient(id);

function renderIngredients(){
  fillCatSelects();
  const q=$("ingSearch").value.trim().toLowerCase();
  const cat=$("ingFilterCat").value;
  let items=[...state.ingredients];
  if(cat && cat!=="Alle") items=items.filter(i=>(i.cat||"")==cat);
  if(q) items=items.filter(i=>{
    const hay=(i.name+" "+i.cat+" "+(i.allergens||"")+" "+(i.spuren||"")+" "+(i.additives||"")+" "+(i.ingredientsText||"")).toLowerCase();
    return hay.includes(q);
  });
  const list=$("ingList");
  if(items.length===0){ list.innerHTML=`<div class="hint">Keine Treffer.</div>`; return; }

  list.innerHTML = items.map(i=>{
    const alls=normalizeList(i.allergens).slice(0,4);
    const sp=normalizeList(i.spuren).slice(0,4);
    const adds=normalizeList(i.additives).slice(0,4);
    return `
      <div class="item">
        <div class="meta">
          <div class="name">${escapeHtml(i.name)}</div>
          <div class="small">${escapeHtml(i.cat||"")}</div>
          <div>
            ${alls.map(a=>`<span class="pill ok">Allergen: ${escapeHtml(a)}</span>`).join("")}
            ${sp.map(a=>`<span class="pill warn">Spuren: ${escapeHtml(a)}</span>`).join("")}
            ${adds.map(a=>`<span class="pill warn">E: ${escapeHtml(a)}</span>`).join("")}
            ${i.note?`<span class="pill bad">Hinweis</span>`:""}
          </div>
          <div class="small mono">pro 100 g: ${fmtNutri(i.n)}</div>
        </div>
        <div class="miniBtns">
          <button class="btnAcc" onclick="window.__editIng('${i.id}')">Bearbeiten</button>
          <button class="btnBad" onclick="window.__delIng('${i.id}')">Löschen</button>
        </div>
      </div>
    `;
  }).join("");
}
$("btnSaveIng").addEventListener("click", saveIngredient);
$("btnNewIng").addEventListener("click", ()=>{ resetIngForm(); toast("Neu."); });
$("ingSearch").addEventListener("input", renderIngredients);
$("ingFilterCat").addEventListener("change", renderIngredients);

/* ====================== RECIPES ====================== */
function fillPickers(){
  const sel=$("r_pick");
  const list=[...state.ingredients].sort((a,b)=>(a.name||"").localeCompare((b.name||""),"de"));
  sel.innerHTML = list.map(i=>`<option value="${i.id}">${escapeHtml(i.name)} — ${escapeHtml(i.cat||"")}</option>`).join("");

  const rp=$("recipePicker");
  const rList=[...state.recipes].sort((a,b)=>(a.name||"").localeCompare((b.name||""),"de"));
  rp.innerHTML = `<option value="">— wählen —</option>` + rList.map(r=>`<option value="${r.id}">${escapeHtml(r.name)}</option>`).join("");
}
function setRecipeFromCurrent(){
  const r=state.current.recipe;
  $("r_name").value=r.name||"";
  $("r_type").value=r.type||"Speiseeis";
  $("r_netto").value=r.netto||"170";
  $("labelSize").value=r.labelSize||"62x100";
  $("r_lot").value=r.lot||"";
  $("r_mhd").value=r.mhd||"";
  $("r_prod").value=r.prod||"";
  $("r_ean").value=r.ean||"";
  $("r_qr").value=r.qr||"";
  $("r_spuren_on").value=r.spuren_on||"yes";
  $("r_spuren_list").value=r.spuren_list || state.settings.spurenDefault || "";
}
function compactNote(ing){
  const adds=normalizeList(ing.additives).slice(0,6).join(", ");
  const alls=normalizeList(ing.allergens).slice(0,6).join(", ");
  const parts=[];
  if(alls) parts.push("Allergene: "+alls);
  if(adds) parts.push("Zusatz: "+adds);
  if(ing.note) parts.push(ing.note);
  return parts.join(" · ");
}

function addToRecipe(){
  const ingId=$("r_pick").value;
  const qty=num($("r_qty").value);
  const unit=$("r_unit").value;
  if(!ingId || qty<=0){ toast("Zutat & Menge prüfen."); return; }
  state.current.recipe.items.push({ingId, qty, unit});
  saveState();
  renderRecipeTable();
  renderLabel();
}
$("btnAddToRecipe").addEventListener("click", addToRecipe);

function removeRecipeItem(idx){
  state.current.recipe.items.splice(idx,1);
  saveState();
  renderRecipeTable();
  renderLabel();
}
window.__rmItem=(idx)=>removeRecipeItem(idx);

function renderRecipeTable(){
  const tb=$("recipeTable").querySelector("tbody");
  const items=state.current.recipe.items||[];
  if(items.length===0){ tb.innerHTML=`<tr><td colspan="5" class="mut">Noch keine Zutaten im Rezept.</td></tr>`; return; }
  tb.innerHTML = items.map((it,idx)=>{
    const ing=state.ingredients.find(x=>x.id===it.ingId);
    return `
      <tr>
        <td><b>${escapeHtml(ing?.name||"Unbekannt")}</b><div class="mut">${escapeHtml(ing?.cat||"")}</div></td>
        <td class="mono">${round(it.qty,1)}</td>
        <td class="mono">${escapeHtml(it.unit)}</td>
        <td class="mut">${escapeHtml(ing?compactNote(ing):"")}</td>
        <td><button class="btnBad" onclick="window.__rmItem(${idx})">X</button></td>
      </tr>
    `;
  }).join("");
}

function newRecipe(){
  state.current.editingRecipeId=null;
  state.current.recipe={
    name:"",
    type:"Speiseeis",
    netto:"170",
    labelSize:"62x100",
    lot:"",
    mhd:"",
    prod:"",
    ean:"",
    qr:"",
    spuren_on:"yes",
    spuren_list: state.settings.spurenDefault || "",
    items:[]
  };
  saveState();
  setRecipeFromCurrent();
  renderRecipeTable();
  renderLabel();
  toast("Neues Rezept.");
}
$("btnNewRecipe").addEventListener("click", newRecipe);

function saveRecipe(){
  const r=state.current.recipe;
  r.name=$("r_name").value.trim();
  r.type=$("r_type").value;
  r.netto=$("r_netto").value;
  r.labelSize=$("labelSize").value;
  r.lot=$("r_lot").value.trim();
  r.mhd=$("r_mhd").value;
  r.prod=$("r_prod").value.trim();
  r.ean=$("r_ean").value.trim();
  r.qr=$("r_qr").value.trim();
  r.spuren_on=$("r_spuren_on").value;
  r.spuren_list=$("r_spuren_list").value.trim();

  if(!r.name){ toast("Rezeptname fehlt."); return; }
  if((r.items||[]).length===0){ toast("Rezept hat keine Zutaten."); return; }

  const rec={ id: state.current.editingRecipeId || uid("rec"), ...deepClone(r) };
  const idx=state.recipes.findIndex(x=>x.id===rec.id);
  if(idx>=0) state.recipes[idx]=rec; else state.recipes.push(rec);
  state.current.editingRecipeId=rec.id;
  saveState();
  fillPickers();
  toast("Rezept gespeichert ✅");
}
$("btnSaveRecipe").addEventListener("click", saveRecipe);

function loadRecipe(id){
  const rec=state.recipes.find(r=>r.id===id);
  if(!rec){ toast("Rezept nicht gefunden."); return; }
  state.current.editingRecipeId=rec.id;
  state.current.recipe=deepClone(rec);
  saveState();
  setRecipeFromCurrent();
  renderRecipeTable();
  renderLabel();
  toast("Rezept geladen.");
}
$("btnLoadRecipe").addEventListener("click", ()=>{
  const id=$("recipePicker").value;
  if(!id){ toast("Bitte Rezept wählen."); return; }
  loadRecipe(id);
});

["r_name","r_type","r_netto","labelSize","r_lot","r_mhd","r_prod","r_ean","r_qr","r_spuren_on","r_spuren_list"].forEach(id=>{
  $(id).addEventListener("input", ()=>{ syncRecipeFromUI(); renderLabel(); });
  $(id).addEventListener("change", ()=>{ syncRecipeFromUI(); renderLabel(); });
});
function syncRecipeFromUI(){
  const r=state.current.recipe;
  r.name=$("r_name").value;
  r.type=$("r_type").value;
  r.netto=$("r_netto").value;
  r.labelSize=$("labelSize").value;
  r.lot=$("r_lot").value;
  r.mhd=$("r_mhd").value;
  r.prod=$("r_prod").value;
  r.ean=$("r_ean").value;
  r.qr=$("r_qr").value;
  r.spuren_on=$("r_spuren_on").value;
  r.spuren_list=$("r_spuren_list").value;
  saveState();
}

/* ====================== SETTINGS ====================== */
function loadSettings(){
  $("s_storage").value=state.settings.storage||"";
  $("s_footer").value=state.settings.footer||"";
  $("s_company").value=state.settings.company||"";
  $("s_addr").value=state.settings.addr||"";
  $("s_phone").value=state.settings.phone||"";
  $("s_email").value=state.settings.email||"";
  $("s_spuren_default").value=state.settings.spurenDefault||"";
}
function saveSettings(){
  state.settings.storage=$("s_storage").value.trim();
  state.settings.footer=$("s_footer").value.trim();
  state.settings.company=$("s_company").value.trim();
  state.settings.addr=$("s_addr").value.trim();
  state.settings.phone=$("s_phone").value.trim();
  state.settings.email=$("s_email").value.trim();
  state.settings.spurenDefault=$("s_spuren_default").value.trim();
  if(!state.current.recipe.spuren_list) state.current.recipe.spuren_list=state.settings.spurenDefault;
  saveState();
  toast("Gespeichert ✅");
  renderLabel();
}
$("btnSaveSettings").addEventListener("click", saveSettings);

/* ====================== NUTRITION / ING TEXT ====================== */
function recipeTotals(){
  const items=state.current.recipe.items||[];
  let totalG=0;
  const sum={kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0};
  const allergens=[]; const additives=[];

  for(const it of items){
    const ing=state.ingredients.find(x=>x.id===it.ingId);
    if(!ing) continue;
    const qtyG = (it.unit==="ml") ? it.qty : it.qty; // quick approximation
    totalG += qtyG;

    const n=ing.n||{};
    sum.kj += (num(n.kj)*qtyG/100);
    sum.kcal += (num(n.kcal)*qtyG/100);
    sum.fat += (num(n.fat)*qtyG/100);
    sum.sat += (num(n.sat)*qtyG/100);
    sum.carb += (num(n.carb)*qtyG/100);
    sum.sugar += (num(n.sugar)*qtyG/100);
    sum.protein += (num(n.protein)*qtyG/100);
    sum.salt += (num(n.salt)*qtyG/100);

    normalizeList(ing.allergens).forEach(a=>allergens.push(a.toUpperCase()));
    normalizeList(ing.additives).forEach(a=>additives.push(a.toUpperCase()));
  }

  const per100 = totalG>0 ? {
    kj: sum.kj*100/totalG,
    kcal: sum.kcal*100/totalG,
    fat: sum.fat*100/totalG,
    sat: sum.sat*100/totalG,
    carb: sum.carb*100/totalG,
    sugar: sum.sugar*100/totalG,
    protein: sum.protein*100/totalG,
    salt: sum.salt*100/totalG
  } : {kj:0,kcal:0,fat:0,sat:0,carb:0,sugar:0,protein:0,salt:0};

  return {
    totalG,
    per100,
    allergens: uniq(allergens),
    additives: uniq(additives)
  };
}

function ingredientListText(){
  const items=[...(state.current.recipe.items||[])].sort((a,b)=>num(b.qty)-num(a.qty));
  const parts=[];
  for(const it of items){
    const ing=state.ingredients.find(x=>x.id===it.ingId);
    if(!ing) continue;
    const txt = (ing.ingredientsText && ing.ingredientsText.trim()) ? ing.ingredientsText.trim() : ing.name;
    parts.push(txt);
  }
  return parts.join(", ").replace(/\s+,/g,",").replace(/,\s+,/g,", ");
}

function fmtNutri(n){
  if(!n) return "—";
  return `${round(n.kj,0)}kJ/${round(n.kcal,0)}kcal · F ${round(n.fat,1)} · KH ${round(n.carb,1)} · Z ${round(n.sugar,1)} · E ${round(n.protein,1)} · S ${round(n.salt,2)}`;
}

/* ====================== BARCODE (EAN-13 SVG) ====================== */
const EAN = {
  L: {"0":"0001101","1":"0011001","2":"0010011","3":"0111101","4":"0100011","5":"0110001","6":"0101111","7":"0111011","8":"0110111","9":"0001011"},
  G: {"0":"0100111","1":"0110011","2":"0011011","3":"0100001","4":"0011101","5":"0111001","6":"0000101","7":"0010001","8":"0001001","9":"0010111"},
  R: {"0":"1110010","1":"1100110","2":"1101100","3":"1000010","4":"1011100","5":"1001110","6":"1010000","7":"1000100","8":"1001000","9":"1110100"},
  PARITY: {"0":"LLLLLL","1":"LLGLGG","2":"LLGGLG","3":"LLGGGL","4":"LGLLGG","5":"LGGLLG","6":"LGGGLL","7":"LGLGLG","8":"LGLGGL","9":"LGGLGL"}
};
function onlyDigits(s){ return (s||"").replace(/\D/g,""); }
function eanCheckDigit12(d12){
  let sum=0;
  for(let i=0;i<12;i++){
    const n=Number(d12[i]);
    sum += (i%2===0) ? n : (n*3);
  }
  const mod=sum%10;
  return (mod===0)?0:(10-mod);
}
function ensureEan13(eanMaybe){
  const d=onlyDigits(eanMaybe);
  if(d.length===13) return d;
  if(d.length===12) return d + String(eanCheckDigit12(d));
  return "";
}
function makeEan13Bits(ean13){
  const d=onlyDigits(ean13);
  const first=d[0];
  const left=d.slice(1,7);
  const right=d.slice(7);
  const parity=EAN.PARITY[first];
  let bits="101";
  for(let i=0;i<6;i++){
    const digit=left[i];
    bits += (parity[i]==="L" ? EAN.L[digit] : EAN.G[digit]);
  }
  bits+="01010";
  for(let i=0;i<6;i++) bits+=EAN.R[right[i]];
  bits+="101";
  return bits;
}
function renderEan13SVG(ean13, heightMm=14){
  const d=onlyDigits(ean13);
  if(d.length!==13) return "";
  const bits=makeEan13Bits(d);
  const w=1, quiet=7;
  const width=(bits.length*w)+(quiet*2);
  const barH=42; // viewBox units
  const totalH=barH+16;
  const guardIdx=new Set([0,1,2,45,46,47,48,49,92,93,94]);
  let x=quiet, rects="";
  for(let i=0;i<bits.length;i++){
    if(bits[i]==="1"){
      const h=guardIdx.has(i)?barH+7:barH;
      rects += `<rect x="${x}" y="0" width="${w}" height="${h}" />`;
    }
    x+=w;
  }
  return `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${width} ${totalH}" width="100%" height="${heightMm}mm" preserveAspectRatio="none">
      <rect x="0" y="0" width="${width}" height="${totalH}" fill="#fff"/>
      <g fill="#000">${rects}</g>
      <text x="${quiet}" y="${totalH-2}" font-family="Arial, sans-serif" font-size="10" fill="#000" letter-spacing="2">${d}</text>
    </svg>
  `;
}

/* ====================== LABEL RENDER (NO CUT / BARCODE BOTTOM) ====================== */
$("labelSize").addEventListener("change", renderLabel);
$("layoutMode").addEventListener("change", renderLabel);
$("barcodeOn").addEventListener("change", renderLabel);

function renderLabel(){
  const r=state.current.recipe;
  const labelSize = $("labelSize").value || r.labelSize || "62x100";
  const layout = $("layoutMode").value || "clean";
  const barcodeOn = $("barcodeOn").value || "yes";

  // sync class
  const lbl=$("labelPreview");
  lbl.classList.remove("large","small");
  lbl.classList.add(labelSize==="38x90" ? "small" : "large");

  // compute fields
  const totals=recipeTotals();
  const vbz = (r.type==="Fruchteis") ? "Fruchteis" : "Speiseeis";
  const nettoText = `${r.netto||"170"} g`;
  const eanFinal = ensureEan13((r.ean||"").trim()) || FIXED_EAN[r.netto||"170"];

  const ingText = ingredientListText();
  const alls = totals.allergens.length ? totals.allergens.join(", ") : "–";
  const adds = totals.additives.length ? totals.additives.join(", ") : "–";
  const spurenList = (r.spuren_list||state.settings.spurenDefault||"").trim();
  const showSpuren = (r.spuren_on||"yes")==="yes" && spurenList.length>0;

  const n=totals.per100;

  const companyLine = `${state.settings.company||""} · ${state.settings.addr||""}`;
  const contactLine = `${state.settings.phone||""}${state.settings.email?(" · "+state.settings.email):""}`;

  // title + meta
  const topHtml = `
    <div class="topLine">
      <div class="prodName">${escapeHtml(r.name || "Gelato")}</div>
      <div class="meta">
        <div><b>${escapeHtml(vbz)}</b></div>
        <div>Nettofüllmenge: <b>${escapeHtml(nettoText)}</b></div>
      </div>
    </div>
  `;

  const nutriHtml = `
    <div>
      <div class="nutriTitle">Durchschnittliche Nährwerte <span class="sub">pro 100 g</span></div>
      <table class="nutri">
        <tr><th>Brennwert</th><td><span class="mono">${round(n.kj,0)}</span> kJ / <span class="mono">${round(n.kcal,0)}</span> kcal</td></tr>
        <tr><th>Fett</th><td class="mono">${round(n.fat,1)} g</td></tr>
        <tr><th class="sub">davon gesättigte Fettsäuren</th><td class="mono">${round(n.sat,1)} g</td></tr>
        <tr><th>Kohlenhydrate</th><td class="mono">${round(n.carb,1)} g</td></tr>
        <tr><th class="sub">davon Zucker</th><td class="mono">${round(n.sugar,1)} g</td></tr>
        <tr><th>Eiweiß</th><td class="mono">${round(n.protein,1)} g</td></tr>
        <tr><th>Salz</th><td class="mono">${round(n.salt,2)} g</td></tr>
      </table>
    </div>
  `;

  const rightHtml = `
    <div class="block"><b>Zutaten:</b> ${escapeHtml(ingText||"–")}</div>
    <div class="block"><b>Allergene:</b> ${escapeHtml(alls)}</div>
    ${layout==="compact" ? "" : `<div class="block"><b>Zusatzstoffe:</b> ${escapeHtml(adds)}</div>`}
    ${showSpuren ? `<div class="spuren">Kann Spuren enthalten: ${escapeHtml(spurenList)}</div>` : ""}
    <div class="block"><b>Lagerung:</b> ${escapeHtml(state.settings.storage||"")}</div>
    <div class="block"><b>Hinweis:</b> ${escapeHtml(state.settings.footer||"")}</div>
    <div class="maker">
      <b>Hersteller:</b> ${escapeHtml(companyLine)}<br/>
      ${escapeHtml(contactLine)}
    </div>
  `;

  const contentHtml = (labelSize==="62x100")
    ? `${topHtml}<div class="grid">${nutriHtml}<div style="display:flex;flex-direction:column;gap:1.2mm">${rightHtml}</div></div>`
    : `${topHtml}<div style="display:flex;gap:2mm;align-items:flex-start">${nutriHtml}<div style="display:flex;flex-direction:column;gap:1.0mm;min-width:0">${rightHtml}</div></div>`;

  $("lblContent").innerHTML = contentHtml;

  const lot = (r.lot||"").trim() || "–";
  const mhd = (r.mhd||"").trim() || "–";
  const prod = (r.prod||"").trim() || "–";

  const barcodeHtml = (barcodeOn==="yes")
    ? `<div class="barcodeBox">
         <div>${renderEan13SVG(eanFinal, (labelSize==="38x90")?10:14)}</div>
         <div class="eanText">${escapeHtml(eanFinal)}</div>
       </div>`
    : `<div class="barcodeBox"><div class="eanText">EAN: ${escapeHtml(eanFinal)}</div></div>`;

  const lotHtml = `
    <div class="lotBox">
      <div><b>Charge/Lot:</b> ${escapeHtml(lot)}</div>
      <div><b>MHD:</b> ${escapeHtml(mhd)}</div>
      <div><b>hergestellt am:</b> ${escapeHtml(prod)}</div>
    </div>
  `;

  $("lblBottom").innerHTML = barcodeHtml + lotHtml;

  // Also keep preview controls synced
  $("labelSize").value = labelSize;
  $("barcodeOn").value = barcodeOn;
}

/* ====================== PRINT (REAL MM) ====================== */
$("btnPrint").addEventListener("click", ()=>{
  syncRecipeFromUI(); // ensure current
  const size = $("labelSize").value || state.current.recipe.labelSize || "62x100";
  const dims = (size==="38x90") ? {w:90,h:38} : {w:100,h:62};
  const htmlLabel = $("labelPreview").outerHTML;

  const w = window.open("", "_blank");
  if(!w){ toast("Popup blockiert? Bitte erlauben."); return; }

  w.document.open();
  w.document.write(`
    <!doctype html>
    <html><head><meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <title>Etikett Druck</title>
      <style>
        @page { size: ${dims.w}mm ${dims.h}mm; margin: 0; }
        html,body{margin:0;padding:0;background:#fff;}
        .lbl{ width:${dims.w}mm; height:${dims.h}mm; border-radius:0; box-shadow:none; }
        .lbl *{ -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      </style>
    </head><body>
      ${htmlLabel}
      <script>window.onload=()=>{ window.print(); }<\/script>
    </body></html>
  `);
  w.document.close();
});

/* ====================== BACKUP ====================== */
$("btnExport").addEventListener("click", ()=>{
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "sanremo-lmiv-final-backup.json";
  a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 500);
  toast("Backup exportiert.");
});
$("btnImport").addEventListener("click", ()=> $("fileImport").click());
$("fileImport").addEventListener("change", async (e)=>{
  const f=e.target.files?.[0];
  if(!f) return;
  try{
    const txt = await f.text();
    const obj = JSON.parse(txt);
    if(!obj || typeof obj!=="object") throw new Error("invalid");
    state = {
      ...deepClone(DEFAULT_STATE),
      ...obj,
      settings:{...deepClone(DEFAULT_STATE.settings), ...(obj.settings||{})},
      current:{...deepClone(DEFAULT_STATE.current), ...(obj.current||{})}
    };
    saveState();
    fillCatSelects();
    fillPickers();
    loadSettings();
    setRecipeFromCurrent();
    renderAll();
    toast("Backup importiert ✅");
  }catch(err){
    toast("Import fehlgeschlagen.");
  }finally{
    $("fileImport").value="";
  }
});

/* ====================== RESET ALL ====================== */
$("btnResetAll").addEventListener("click", ()=>{
  if(!confirm("Alles zurücksetzen?")) return;
  localStorage.removeItem(STORAGE_KEY);
  state = loadState();
  ensureSeed();
  fillCatSelects();
  fillPickers();
  loadSettings();
  setRecipeFromCurrent();
  resetIngForm();
  renderAll();
  toast("Reset ✅");
});

/* ====================== RENDER ALL ====================== */
function renderAll(){
  fillCatSelects();
  fillPickers();
  loadSettings();
  setRecipeFromCurrent();
  renderIngredients();
  renderRecipeTable();
  // keep preview controls synced with current recipe
  $("labelSize").value = state.current.recipe.labelSize || "62x100";
  renderLabel();
}

(function init(){
  fillCatSelects();
  fillPickers();
  loadSettings();

  // default MHD +6 months
  if(!state.current.recipe.mhd){
    const d=new Date(); d.setMonth(d.getMonth()+6);
    state.current.recipe.mhd = d.toISOString().slice(0,10);
    saveState();
  }
  // default spuren list from settings
  if(!state.current.recipe.spuren_list) state.current.recipe.spuren_list = state.settings.spurenDefault || "";

  setRecipeFromCurrent();
  resetIngForm();
  renderAll();
})();
</script>
</body>
</html>
